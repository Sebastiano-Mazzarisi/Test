<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing for Resilience</title>
    <meta name="apple-mobile-web-app-title" content="Playing for Resilience">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/35f45f651fc8580ac4af1dd5111a55b57ba2444a/LogoPFR.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/35f45f651fc8580ac4af1dd5111a55b57ba2444a/LogoPFR.png">
    
    <style>
        :root { 
            --primary-color: #004080; --secondary-color: #5a7d9a; 
            --success-color: #2e7d32; --danger-color: #c62828; --warning-color: #ff8f00; 
            --teal-color: #00695c; --light-gray: #f8f9fa; --gray: #e9ecef; 
            --font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            --pastel-green: #a5d6a7; --pastel-blue: #90caf9; --pastel-orange: #ffcc80;
        }
        body { font-family: var(--font-family); line-height: 1.6; margin: 0; background-color: var(--light-gray); color: #333; }
        .view { display: none; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 2.5rem; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        header { border-bottom: 2px solid var(--primary-color); margin-bottom: 1.5rem; padding-bottom: 1rem; text-align: center;}
        .logo { max-width: 150px; height: auto; margin-bottom: 1rem; cursor: pointer; }
        h1, h2, h3, h4 { color: var(--primary-color); font-weight: 600; }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.6rem; }
        h4 { font-size: 1.25rem; }

        .button { display: inline-block; padding: 12px 28px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 5px; border: none; cursor: pointer; text-align: center; margin-top: 1rem; font-size: 1em; font-weight: 500; transition: background-color 0.2s, box-shadow 0.2s; }
        .button:hover { background-color: #003366; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .button-secondary { background-color: var(--secondary-color); }
        .button-secondary:hover { background-color: #4a6781; }
        .text-center { text-align: center; }
        
        /* Tutorial Styles */
        .tutorial-step { background-color: var(--light-gray); border: 2px solid var(--pastel-blue); border-radius: 8px; padding: 2rem; margin-bottom: 1.5rem; font-size: 1.1em; line-height: 1.7; }
        .tutorial-step h4 { margin-top: 0; color: var(--primary-color); font-size: 1.4em; }
        .tutorial-step p { font-size: 1.05em; margin-bottom: 1.2rem; }
        .tutorial-step ul { font-size: 1.05em; }
        .tutorial-step li { margin-bottom: 0.8rem; }
        .tutorial-demo { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; }
        .demo-metric { text-align: center; padding: 1rem; background: white; border-radius: 5px; border: 1px solid var(--gray); }
        .demo-choice { border: 2px solid var(--pastel-green); padding: 1rem; border-radius: 8px; text-align: center; background: white; position: relative; }
        .tutorial-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; }
        
        /* Game UI */
        #game-dashboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; background-color: var(--light-gray); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border: 2px solid var(--pastel-blue); }
        .metric { text-align: center; }
        .metric .label { font-size: 0.8em; color: var(--secondary-color); text-transform: uppercase; }
        .metric .value { font-size: 1.6em; font-weight: 700; }
        #game-budget { color: var(--primary-color); }
        #game-resilience { color: var(--success-color); }
        #game-opinion { color: var(--warning-color); }
        #game-environment { color: var(--teal-color); }
        #news-panel { margin-bottom: 2rem; padding: 1rem; background-color: #fffbeb; border: 2px solid var(--pastel-orange); border-left-width: 5px; border-radius: 8px; }
        #choices-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .choice-card { border: 2px solid var(--gray); border-radius: 8px; padding: 1rem; text-align: center; transition: box-shadow 0.2s, border-color 0.2s; display: flex; flex-direction: column; position: relative; }
        .choice-card .uncertainty { position: absolute; top: 8px; right: 8px; background: transparent; color: var(--secondary-color); border-radius: 50%; width: 20px; height: 20px; font-size: 1.2em; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: help; }
        .choice-card .uncertainty::before { content: "❓"; }
        .card-constructive { border-color: var(--pastel-green); }
        .card-infrastructure { border-color: var(--pastel-blue); }
        .card-political { border-color: var(--pastel-orange); }
        .choice-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .choice-card h4 { margin-top: 0; }
        .choice-card .cost { font-size: 1.1em; font-weight: bold; color: var(--danger-color); margin-bottom: 1rem; }
        .choice-card ul { list-style-type: none; padding: 0; text-align: left; font-size: 0.9em; flex-grow: 1; }
        .choice-card .effect-range { font-size: 0.8em; color: var(--secondary-color); font-style: italic; }
        .impact-good { color: var(--success-color); }
        .impact-bad { color: var(--danger-color); }
        .choice-card .button { width: 100%; }
        .btn-constructive { background-color: var(--success-color); } .btn-constructive:hover { background-color: #256a29; }
        .btn-infrastructure { background-color: var(--secondary-color); } .btn-infrastructure:hover { background-color: #4a6781; }
        .btn-political { background-color: var(--warning-color); } .btn-political:hover { background-color: #d97800; }
        #event-log { margin-bottom: 2rem; padding: 1rem; background-color: #e3f2fd; border: 2px solid var(--secondary-color); border-radius: 8px; text-align: center; }
        
        /* Stili per la Card di Riepilogo Fine Partita */
        .end-game-summary { padding: 2rem; background-color: var(--light-gray); border: 2px solid var(--primary-color); border-radius: 8px; }
        .end-game-summary h4 { text-align: center; font-size: 1.5rem; margin-top: 0; }
        .final-metrics { display: flex; justify-content: space-around; gap: 1rem; margin: 1.5rem 0; text-align: center; flex-wrap: wrap; }
        .final-metric { flex-basis: 150px; }
        .final-metric .label { font-weight: 600; color: var(--secondary-color); }
        .final-metric .value { font-size: 1.8em; font-weight: 700; }
        .progress-bar-wrapper { height: 10px; background-color: var(--gray); border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        .progress-resilience { background-color: var(--success-color); }
        .progress-opinion { background-color: var(--warning-color); }
        .progress-environment { background-color: var(--teal-color); }
        .final-feedback { text-align: center; font-size: 1.1em; margin: 1.5rem 0; }
        
        /* Report & Questionario */
        #report-content { display: flex; flex-direction: row; gap: 1.5rem; align-items: stretch; }
        .report-section { flex: 1; min-width: 200px; border: 2px solid var(--pastel-blue); border-radius: 8px; padding: 1.5rem; background-color: var(--light-gray); }
        .report-section ul { padding-left: 20px; }
        .question-group { margin-bottom: 2rem; background-color: #fff; padding: 1.5rem 2rem; border-radius: 8px; border: 2px solid var(--pastel-blue); box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .choice-experiment { display: flex; gap: 1.5rem; justify-content: center; flex-direction: column; }
        @media (min-width: 768px) { .choice-experiment { flex-direction: row; } }
        .policy-option { flex: 1; border: 2px solid var(--gray); padding: 1.5rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; position: relative; background-color: var(--light-gray); }
        .policy-option:hover { border-color: var(--secondary-color); }
        .policy-option.selected { border-color: var(--pastel-green); background-color: #e8f5e9; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .policy-option.selected::after { content: '✔'; font-size: 1.5em; color: var(--success-color); position: absolute; top: 10px; right: 10px; }
        .policy-option ul { list-style-type: none; padding-left: 0; }
        .policy-option li { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .policy-option .icon { font-size: 1.5em; margin-right: 10px; width: 25px; text-align: center; }
        .impact-positive { color: var(--success-color); }
        .impact-negative { color: var(--danger-color); }
        .perception-question { display: flex; align-items: center; gap: 1.5rem; }
        .perception-question .icon { font-size: 2.5em; }
        .perception-question .text { flex-grow: 1; }
        .likert-buttons { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .likert-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gray); background-color: #fff; cursor: pointer; font-size: 1.2em; font-weight: bold; transition: all 0.2s; }
        .likert-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .likert-btn.selected { border-width: 3px; transform: translateY(-3px) scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .likert-1 { color: #d32f2f; border-color: #d32f2f; } .likert-1.selected { background-color: #d32f2f; color: white; }
        .likert-2 { color: #ef5350; border-color: #ef5350; } .likert-2.selected { background-color: #ef5350; color: white; }
        .likert-3 { color: #ffab40; border-color: #ffab40; } .likert-3.selected { background-color: #ffab40; color: white; }
        .likert-4 { color: #66bb6a; border-color: #66bb6a; } .likert-4.selected { background-color: #66bb6a; color: white; }
        .likert-5 { color: #388e3c; border-color: #388e3c; } .likert-5.selected { background-color: #388e3c; color: white; }

        /* Debriefing esteso */
        .debriefing-section { background-color: var(--light-gray); border: 2px solid var(--pastel-blue); border-radius: 8px; padding: 2rem; margin-bottom: 2rem; }
        .open-question { margin-bottom: 1.5rem; }
        .open-question textarea { width: 100%; min-height: 100px; padding: 1rem; border: 2px solid var(--gray); border-radius: 5px; font-family: inherit; resize: vertical; }
        .data-export { background-color: #f0f0f0; border: 1px solid var(--gray); border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .data-export pre { margin: 0; white-space: pre-wrap; word-break: break-all; font-size: 0.8em; }

        /* Stili per il mobile */
        @media (max-width: 992px) {
            #report-content { flex-direction: column; } 
        }
        @media (max-width: 768px) {
            body { font-size: 1.05em; }
            .container { padding: 1.5rem 1rem; margin: 1rem 0.5rem; }
            h1 { font-size: 1.7rem; }
            h2 { font-size: 1.5rem; }
            h3 { font-size: 1.3rem; }
            h4 { font-size: 1.15rem; }
            #game-dashboard { grid-template-columns: 1fr 1fr; }
            .metric .value { font-size: 1.2em; }
            #choices-container { grid-template-columns: 1fr; }
            .end-game-summary h4 { font-size: 1.3rem; }
            .tutorial-demo { grid-template-columns: 1fr; }
            .tutorial-navigation { flex-direction: column; gap: 1rem; }
            .tutorial-step { font-size: 1.05em; padding: 1.5rem; }
            .tutorial-step h4 { font-size: 1.25em; }
            .choice-card .uncertainty { width: 18px; height: 18px; font-size: 1em; top: 5px; right: 5px; }
        }
    </style>
</head>
<body>

    <div id="view-start" class="view" style="display: block;">
        <div class="container">
            <header>
                <img src="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/35f45f651fc8580ac4af1dd5111a55b57ba2444a/LogoPFR.png" alt="Logo Playing for Resilience" class="logo" onclick="showView('view-methodology')">
                <h1>Progetto di Ricerca "Playing for Resilience"</h1>
            </header>
            <main>
                <p>Benvenuto/a. Stai per partecipare a uno studio che esplora nuovi modi di comunicare le sfide dell'adattamento climatico attraverso un approccio innovativo che combina simulazione interattiva e analisi delle preferenze di policy.</p>
                <p><strong>Durata stimata:</strong> 15-20 minuti</p>
                <p><strong>Cosa farai:</strong> Verrai assegnato/a casualmente a una di due modalità di apprendimento, seguita da un breve questionario sulle tue preferenze e percezioni.</p>
                <div class="text-center"> 
                    <button class="button" onclick="showView('view-tutorial')">Inizia con il Tutorial</button>
                    <br><br>
                    <button class="button-secondary button" onclick="startExperiment()">Salta il Tutorial e Inizia</button>
                </div>
            </main>
        </div>
    </div>

    <div id="view-tutorial" class="view" style="display: none;">
        <div class="container">
            <header><h2>Tutorial: Come Funziona la Simulazione</h2></header>
            
            <div id="tutorial-step-1" class="tutorial-step">
                <h4>🏛️ Il tuo Ruolo: Sindaco di Costa Futura</h4>
                <p>Sei il sindaco di una città costiera che deve affrontare i rischi del cambiamento climatico. Il tuo obiettivo è guidare la città per i prossimi 30 anni (6 mandati di 5 anni ciascuno) prendendo decisioni strategiche di adattamento.</p>
                
                <h4>📊 Dashboard di Controllo</h4>
                <p>Durante il gioco, monitorerai 4 indicatori chiave:</p>
                <div class="tutorial-demo">
                    <div class="demo-metric">
                        <div class="label">Budget</div>
                        <div class="value" style="color: var(--primary-color);">100M €</div>
                        <small>Risorse disponibili per investimenti</small>
                    </div>
                    <div class="demo-metric">
                        <div class="label">Resilienza</div>
                        <div class="value" style="color: var(--success-color);">20/100</div>
                        <small>Capacità di resistere agli eventi climatici</small>
                    </div>
                    <div class="demo-metric">
                        <div class="label">Op. Pubblica</div>
                        <div class="value" style="color: var(--warning-color);">50/100</div>
                        <small>Gradimento dei cittadini</small>
                    </div>
                </div>
                <div class="tutorial-demo">
                    <div class="demo-metric">
                        <div class="label">Ambiente</div>
                        <div class="value" style="color: var(--teal-color);">50/100</div>
                        <small>Salute dell'ecosistema locale</small>
                    </div>
                </div>
            </div>

            <div id="tutorial-step-2" class="tutorial-step" style="display: none;">
                <h4>⚖️ Trade-off e Decisioni</h4>
                <p>Ogni decisione che prendi ha <strong>costi e benefici multipli</strong>. Non esistono soluzioni perfette!</p>
                
                <div class="demo-choice">
                    <h4>Esempio: Costruzione Diga</h4>
                    <p class="cost">40M €</p>
                    <ul style="text-align: left;">
                        <li><span class="impact-good">▲</span> Resilienza: +25</li>
                        <li><span class="impact-bad">▼</span> Opinione Pubblica: -15</li>
                        <li><span class="impact-bad">▼</span> Salute Ambientale: -25</li>
                    </ul>
                    <div style="position: absolute; top: 8px; right: 8px; background: transparent; color: var(--secondary-color); border-radius: 50%; width: 20px; height: 20px; font-size: 1.2em; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: help;">❓</div>
                </div>
                
                <p><strong>❓ Significato del simbolo:</strong> Gli effetti reali possono variare leggermente rispetto alle stime (±5 punti), simulando l'incertezza tipica delle decisioni di policy reali.</p>
                <p><strong>🌊 Eventi imprevisti:</strong> Durante il gioco, eventi climatici casuali possono influenzare la tua città, mettendo alla prova le tue strategie.</p>
            </div>

            <div id="tutorial-step-3" class="tutorial-step" style="display: none;">
                <h4>🎯 Obiettivi e Strategia</h4>
                <p>Non c'è un unico modo "giusto" di giocare. Puoi scegliere diverse strategie:</p>
                <ul>
                    <li><strong>🛡️ Focus sulla Resilienza:</strong> Massimizza la protezione dai rischi climatici</li>
                    <li><strong>🗳️ Consenso Popolare:</strong> Mantieni alta l'opinione pubblica per la rielezione</li>
                    <li><strong>🌱 Sostenibilità Ambientale:</strong> Privilegia soluzioni eco-compatibili</li>
                    <li><strong>⚖️ Approccio Bilanciato:</strong> Cerca equilibri tra tutti gli obiettivi</li>
                </ul>
                
                <p><strong>🔄 Dinamiche a lungo termine:</strong> Alcune decisioni hanno effetti che si manifestano nei turni successivi. Pensa strategicamente!</p>
            </div>

            <div class="tutorial-navigation">
                <button id="tutorial-prev" class="button button-secondary" onclick="previousTutorialStep()" style="display: none;">◀ Precedente</button>
                <span id="tutorial-progress">Passo 1 di 3</span>
                <button id="tutorial-next" class="button" onclick="nextTutorialStep()">Successivo ▶</button>
            </div>
        </div>
    </div>

    <div id="view-methodology" class="view" style="display: none;">
        <div class="container">
            <header> <h2>Spiegazione del Disegno Sperimentale</h2> </header>
            <main>
                <h4>Perché non posso scegliere il percorso?</h4>
                <p>Il prototipo simula un'<strong>assegnazione casuale</strong> a una delle due condizioni (gioco interattivo o documento informativo), come previsto dal disegno sperimentale "between-subjects" del progetto di ricerca. Questo metodo è cruciale per la validità scientifica dei risultati e permette di confrontare l'efficacia dei due approcci didattici.</p>
                
                <h4>Cosa succede dopo l'assegnazione?</h4>
                <ul>
                    <li><strong>Gruppo "Simulazione":</strong> Giocherai il ruolo del sindaco per 20-25 minuti</li>
                    <li><strong>Gruppo "Documento":</strong> Leggerai informazioni dettagliate sulle stesse strategie di adattamento</li>
                </ul>
                
                <p>Entrambi i gruppi completeranno poi lo stesso questionario finale per confrontare le preferenze e percezioni sviluppate.</p>
                
                <div class="text-center"> <button class="button" onclick="showView('view-start')">Torna alla Home</button> </div>
            </main>
        </div>
    </div>
    
    <div id="view-game" class="view" style="display: none;">
        <div class="container">
            <header> <h2>Sindaco di Costa Futura</h2> <p>Il tuo obiettivo è guidare la città per i prossimi 30 anni, bilanciando resilienza climatica, consenso popolare e sostenibilità ambientale.</p> </header>
            <div id="game-dashboard">
                <div class="metric"><div class="label">Anno</div><div class="value" id="game-year"></div></div>
                <div class="metric"><div class="label">Budget</div><div class="value" id="game-budget"></div></div>
                <div class="metric"><div class="label">Resilienza</div><div class="value" id="game-resilience"></div></div>
                <div class="metric"><div class="label">Op. Pubblica</div><div class="value" id="game-opinion"></div></div>
                <div class="metric"><div class="label">Ambiente</div><div class="value" id="game-environment"></div></div>
            </div>
            <div id="news-panel"></div>
            <div id="event-log" style="display:none;"></div>
            <h4>Decisioni di Mandato (scegli un'azione)</h4>
            <div id="choices-container"></div>
            <div class="text-center" id="pass-turn-container" style="display: none;">
                <button class="button" id="pass-turn-btn" onclick="passTurn()">Risparmia Budget e Passa al Turno Successivo</button>
            </div>
        </div>
    </div>
    
    <div id="view-report" class="view" style="display: none;">
        <div class="container">
            <header><h2>Documento Informativo: Strategie di Adattamento Climatico</h2></header>
            <p>Le comunità costiere devono affrontare crescenti rischi climatici. Le seguenti strategie rappresentano le principali opzioni disponibili per la pianificazione dell'adattamento, ognuna con specifici costi, benefici e impatti sistemici.</p>
            <div id="report-content"></div>
            <div class="text-center" style="margin-top: 2rem;"> <button class="button" onclick="showView('view-questionnaire')">Vai al Questionario Finale</button> </div>
        </div>
    </div>

    <div id="view-questionnaire" class="view" style="display: none;">
        <div class="container">
            <header><h3>Questionario Finale</h3><p>Le tue risposte ci aiuteranno a comprendere l'efficacia di diversi approcci comunicativi sui temi dell'adattamento climatico.</p></header>
            <form id="questionnaire-form" onsubmit="event.preventDefault(); handleQuestionnaireSubmit()">
                
                <!-- Choice Experiment -->
                <div class="question-group">
                    <h4>1. Esperimento di Scelta</h4>
                    <p>Immagina che la tua comunità debba scegliere un piano di adattamento climatico. Quale delle due opzioni preferiresti?</p>
                    <div class="choice-experiment">
                        <div class="policy-option" id="policy-a" onclick="selectPolicy('a')">
                            <h4>Piano Alfa</h4>
                            <ul>
                                <li><span class="icon">💰</span><strong>Costo:</strong> 50€/anno per famiglia</li>
                                <li><span class="icon">🛡️</span><strong>Protezione:</strong> Alta (90% eventi)</li>
                                <li class="impact-negative"><span class="icon">🌿</span><strong>Impatto Ambientale:</strong> Negativo</li>
                                <li><span class="icon">🏗️</span><strong>Tipo:</strong> Infrastrutture "dure"</li>
                            </ul>
                        </div>
                        <div class="policy-option" id="policy-b" onclick="selectPolicy('b')">
                            <h4>Piano Beta</h4>
                            <ul>
                                <li><span class="icon">💰</span><strong>Costo:</strong> 30€/anno per famiglia</li>
                                <li><span class="icon">🛡️</span><strong>Protezione:</strong> Media (70% eventi)</li>
                                <li class="impact-positive"><span class="icon">🌿</span><strong>Impatto Ambientale:</strong> Positivo</li>
                                <li><span class="icon">🌱</span><strong>Tipo:</strong> Soluzioni basate sulla natura</li>
                            </ul>
                        </div>
                    </div>
                    <input type="hidden" id="policy-choice-input" required>
                </div>

                <!-- Percezione Autoefficacia -->
                <div class="question-group">
                    <div class="perception-question">
                        <span class="icon">💪</span>
                        <div class="text">
                            <h4>2. Senso di Autoefficacia</h4>
                            <label>"Mi sento in grado di contribuire personalmente a ridurre gli effetti del cambiamento climatico nella mia comunità."</label>
                        </div>
                    </div>
                    <div class="likert-buttons" id="likert-efficacy" data-target-input="q-efficacy-input">
                        <button type="button" class="likert-btn likert-1" data-value="1" title="Per nulla d'accordo">1</button>
                        <button type="button" class="likert-btn likert-2" data-value="2" title="Poco d'accordo">2</button>
                        <button type="button" class="likert-btn likert-3" data-value="3" title="Neutrale">3</button>
                        <button type="button" class="likert-btn likert-4" data-value="4" title="D'accordo">4</button>
                        <button type="button" class="likert-btn likert-5" data-value="5" title="Pienamente d'accordo">5</button>
                    </div>
                    <input type="hidden" id="q-efficacy-input" required>
                </div>

                <!-- Percezione del Rischio -->
                <div class="question-group">
                    <div class="perception-question">
                        <span class="icon">⚠️</span>
                        <div class="text">
                            <h4>3. Percezione del Rischio</h4>
                            <label>Quanto percepisci alto il rischio di eventi climatici estremi nella tua regione nei prossimi 20 anni?</label>
                        </div>
                    </div>
                    <div class="likert-buttons" id="likert-risk" data-target-input="q-risk-input">
                        <button type="button" class="likert-btn likert-1" data-value="1" title="Molto basso">1</button>
                        <button type="button" class="likert-btn likert-2" data-value="2" title="Basso">2</button>
                        <button type="button" class="likert-btn likert-3" data-value="3" title="Medio">3</button>
                        <button type="button" class="likert-btn likert-4" data-value="4" title="Alto">4</button>
                        <button type="button" class="likert-btn likert-5" data-value="5" title="Molto alto">5</button>
                    </div>
                    <input type="hidden" id="q-risk-input" required>
                </div>

                <!-- Comprensione Trade-off -->
                <div class="question-group">
                    <div class="perception-question">
                        <span class="icon">⚖️</span>
                        <div class="text">
                            <h4>4. Comprensione delle Dinamiche Sistemiche</h4>
                            <label>"Le decisioni di adattamento climatico comportano sempre trade-off complessi tra costi economici, benefici ambientali e consenso sociale."</label>
                        </div>
                    </div>
                    <div class="likert-buttons" id="likert-tradeoff" data-target-input="q-tradeoff-input">
                        <button type="button" class="likert-btn likert-1" data-value="1" title="Per nulla d'accordo">1</button>
                        <button type="button" class="likert-btn likert-2" data-value="2" title="Poco d'accordo">2</button>
                        <button type="button" class="likert-btn likert-3" data-value="3" title="Neutrale">3</button>
                        <button type="button" class="likert-btn likert-4" data-value="4" title="D'accordo">4</button>
                        <button type="button" class="likert-btn likert-5" data-value="5" title="Pienamente d'accordo">5</button>
                    </div>
                    <input type="hidden" id="q-tradeoff-input" required>
                </div>

                <!-- Preferenza Temporale -->
                <div class="question-group">
                    <div class="perception-question">
                        <span class="icon">🕐</span>
                        <div class="text">
                            <h4>5. Preferenza Temporale</h4>
                            <label>"È più importante investire in soluzioni di adattamento che diano benefici immediati piuttosto che in soluzioni costose con benefici a lungo termine."</label>
                        </div>
                    </div>
                    <div class="likert-buttons" id="likert-temporal" data-target-input="q-temporal-input">
                        <button type="button" class="likert-btn likert-1" data-value="1" title="Per nulla d'accordo">1</button>
                        <button type="button" class="likert-btn likert-2" data-value="2" title="Poco d'accordo">2</button>
                        <button type="button" class="likert-btn likert-3" data-value="3" title="Neutrale">3</button>
                        <button type="button" class="likert-btn likert-4" data-value="4" title="D'accordo">4</button>
                        <button type="button" class="likert-btn likert-5" data-value="5" title="Pienamente d'accordo">5</button>
                    </div>
                    <input type="hidden" id="q-temporal-input" required>
                </div>

                <!-- Supporto Politiche Collettive -->
                <div class="question-group">
                    <div class="perception-question">
                        <span class="icon">🤝</span>
                        <div class="text">
                            <h4>6. Supporto per Azioni Collettive</h4>
                            <label>"I problemi di adattamento climatico richiedono principalmente soluzioni coordinate a livello pubblico piuttosto che azioni individuali."</label>
                        </div>
                    </div>
                    <div class="likert-buttons" id="likert-collective" data-target-input="q-collective-input">
                        <button type="button" class="likert-btn likert-1" data-value="1" title="Per nulla d'accordo">1</button>
                        <button type="button" class="likert-btn likert-2" data-value="2" title="Poco d'accordo">2</button>
                        <button type="button" class="likert-btn likert-3" data-value="3" title="Neutrale">3</button>
                        <button type="button" class="likert-btn likert-4" data-value="4" title="D'accordo">4</button>
                        <button type="button" class="likert-btn likert-5" data-value="5" title="Pienamente d'accordo">5</button>
                    </div>
                    <input type="hidden" id="q-collective-input" required>
                </div>

                <div class="text-center"> <button type="submit" class="button">Invia Questionario</button> </div>
            </form>
        </div>
    </div>
    
    <div id="view-debriefing" class="view" style="display: none;">
        <div class="container">
            <header><h3>Debriefing e Riflessioni Finali</h3></header>
            <p>Grazie per aver completato la simulazione! Ecco un riepilogo del tuo percorso e alcune domande di riflessione.</p>
            
            <div class="debriefing-section">
                <h4>📊 Riepilogo delle tue Performance</h4>
                <div id="debriefing-dashboard"></div>
                <div id="debriefing-analysis"></div>
            </div>

            <div class="debriefing-section">
                <h4>🤔 Domande di Riflessione Aperta</h4>
                
                <div class="open-question">
                    <label><strong>1. Quale è stata la decisione più difficile che hai dovuto prendere e perché?</strong></label>
                    <textarea id="reflection-1" placeholder="Descrivi la situazione e i fattori che hanno reso la decisione complessa..."></textarea>
                </div>

                <div class="open-question">
                    <label><strong>2. Se dovessi ricominciare, cambieresti qualcosa nella tua strategia? Cosa e perché?</strong></label>
                    <textarea id="reflection-2" placeholder="Rifletti su cosa hai imparato durante l'esperienza..."></textarea>
                </div>

                <div class="open-question">
                    <label><strong>3. Quanto ritieni che questa simulazione rifletta le sfide reali che affrontano i decisori politici?</strong></label>
                    <textarea id="reflection-3" placeholder="Considera realismo, complessità e utilità dell'esperienza..."></textarea>
                </div>
            </div>

            <div class="debriefing-section">
                <h4>📈 I Tuoi Dati di Gioco (per Ricerca)</h4>
                <p>I seguenti dati sono stati raccolti durante la tua sessione per scopi di ricerca:</p>
                <div class="data-export">
                    <button class="button button-secondary" onclick="exportGameData()">Mostra/Esporta Dati della Sessione</button>
                    <div id="exported-data" style="display: none;">
                        <h5>Dati Raccolti:</h5>
                        <pre id="game-data-display"></pre>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button class="button" onclick="saveReflectionsAndFinish()">Salva Riflessioni e Concludi</button>
                <br><br>
                <button class="button button-secondary" onclick="showView('view-start')">Torna alla Home</button>
            </div>
        </div>
    </div>

    <script>
        // --- ENHANCED GAME & EXPERIMENT CONFIG ---
        let wasInGame = false;
        let gameData = { decisions: [], events: [], startTime: null, endTime: null, condition: null };
        let tutorialStep = 1;

        // Bilanciamento migliorato con incertezza
        const INVESTMENTS = { 
            diga: { 
                name: "Costruzione Diga", 
                category: "infrastructure", 
                cost: 40, 
                effects: { 'Resilienza': 25, 'Opinione Pubblica': -15, 'Salute Ambientale': -25 },
                uncertainty: { 'Resilienza': 5, 'Opinione Pubblica': 5, 'Salute Ambientale': 5 },
                delayedTurns: 0
            }, 
            ripascimento: { 
                name: "Ripascimento Spiagge", 
                category: "constructive", 
                cost: 20, 
                effects: { 'Resilienza': 15, 'Opinione Pubblica': 15, 'Salute Ambientale': 5 },
                uncertainty: { 'Resilienza': 3, 'Opinione Pubblica': 3, 'Salute Ambientale': 2 },
                delayedTurns: 0
            }, 
            delocalizzazione: { 
                name: "Piano di Delocalizzazione", 
                category: "political", 
                cost: 50, 
                effects: { 'Resilienza': 25, 'Opinione Pubblica': -20, 'Salute Ambientale': 10 },
                uncertainty: { 'Resilienza': 4, 'Opinione Pubblica': 8, 'Salute Ambientale': 3 },
                delayedTurns: 1
            }, 
            allerta: { 
                name: "Sistema di Allerta Precoce", 
                category: "constructive", 
                cost: 10, 
                effects: { 'Resilienza': 8, 'Opinione Pubblica': 12, 'Salute Ambientale': 0 },
                uncertainty: { 'Resilienza': 2, 'Opinione Pubblica': 3, 'Salute Ambientale': 0 },
                delayedTurns: 0
            },
            ecosistema: {
                name: "Ripristino Ecosistemi Costieri",
                category: "constructive",
                cost: 30,
                effects: { 'Resilienza': 18, 'Opinione Pubblica': 8, 'Salute Ambientale': 20 },
                uncertainty: { 'Resilienza': 4, 'Opinione Pubblica': 4, 'Salute Ambientale': 3 },
                delayedTurns: 2
            }
        };

        const DILEMMAS = { 
            bonus: { 
                name: "Bonus Popolarità", 
                category: "political", 
                cost: 10, 
                effects: { 'Opinione Pubblica': 25, 'budget_next': -15 },
                uncertainty: { 'Opinione Pubblica': 5 }
            }, 
            manutenzione: { 
                name: "Fondo Manutenzione", 
                category: "infrastructure", 
                cost: 15, 
                effects: { 'Resilienza': 12, 'Opinione Pubblica': -8 },
                uncertainty: { 'Resilienza': 3, 'Opinione Pubblica': 3 }
            } 
        };

        const SOCIAL_NORMS = [ 
            "📊 Report IPCC: il 75% delle città costiere europee sta investendo in soluzioni basate sulla natura per l'adattamento climatico.",
            "🏆 Studio governance: I sindaci che privilegiano investimenti a lungo termine hanno tassi di rielezione del 15% superiori alla media.",
            "💡 Raccomandazione UE: Dare priorità a strategie di adattamento che combinino resilienza e co-benefici ambientali.",
            "📈 Analisi economica: Gli investimenti in resilienza generano un ritorno di 4€ per ogni euro speso in riduzione danni futuri.",
            "🌍 Trend internazionale: Il 60% dei piani di adattamento europei integra criteri di giustizia distributiva nelle decisioni di policy."
        ];

        const EVENTS = [ 
            { name: "una forte mareggiata eccezionale", effects: { resilience: -25, opinion: -18, environment: -8 }, probability: 0.3 },
            { name: "un'ondata di calore prolungata", effects: { opinion: -15, environment: -12, budget: -5 }, probability: 0.25 }, 
            { name: "un boom del turismo ecologico", effects: { budget: 20, opinion: 12, environment: 5 }, probability: 0.2 },
            { name: "una crisi idrica stagionale", effects: { opinion: -20, environment: -15, resilience: -10 }, probability: 0.15 },
            { name: "finanziamenti UE straordinari", effects: { budget: 25, opinion: 8 }, probability: 0.1 }
        ];

        let gameState = {};
        let decisionStartTime = 0;

        // --- TUTORIAL LOGIC ---
        function nextTutorialStep() {
            document.getElementById(`tutorial-step-${tutorialStep}`).style.display = 'none';
            tutorialStep++;
            
            if (tutorialStep <= 3) {
                document.getElementById(`tutorial-step-${tutorialStep}`).style.display = 'block';
                document.getElementById('tutorial-progress').textContent = `Passo ${tutorialStep} di 3`;
                document.getElementById('tutorial-prev').style.display = 'inline-block';
                
                if (tutorialStep === 3) {
                    document.getElementById('tutorial-next').textContent = 'Inizia Esperimento';
                    document.getElementById('tutorial-next').onclick = startExperiment;
                }
            }
        }

        function previousTutorialStep() {
            document.getElementById(`tutorial-step-${tutorialStep}`).style.display = 'none';
            tutorialStep--;
            document.getElementById(`tutorial-step-${tutorialStep}`).style.display = 'block';
            document.getElementById('tutorial-progress').textContent = `Passo ${tutorialStep} di 3`;
            
            if (tutorialStep === 1) {
                document.getElementById('tutorial-prev').style.display = 'none';
            }
            
            document.getElementById('tutorial-next').textContent = 'Successivo ▶';
            document.getElementById('tutorial-next').onclick = nextTutorialStep;
        }

        // --- CORE NAVIGATION & SETUP ---
        function showView(viewId) { 
            window.scrollTo(0, 0); 
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); 
            document.getElementById(viewId).style.display = 'block'; 
        }

        function resetQuestionnaire() { 
            const form = document.getElementById('questionnaire-form'); 
            if(form) { form.reset(); } 
            document.querySelectorAll('.policy-option').forEach(el => el.classList.remove('selected')); 
            document.querySelectorAll('.likert-btn').forEach(el => el.classList.remove('selected')); 
        }

        function startExperiment() { 
            resetQuestionnaire(); 
            wasInGame = false; 
            gameData.startTime = new Date().toISOString();
            
            if (Math.random() > 0.5) { 
                wasInGame = true; 
                gameData.condition = 'game';
                initializeGame(); 
                showView('view-game'); 
            } else { 
                gameData.condition = 'report';
                renderReport(); 
                showView('view-report'); 
            } 
        }

        // --- ENHANCED GAME LOGIC ---
        function initializeGame() { 
            gameState = { 
                turn: 0, 
                year: 2025, 
                budget: 100, 
                resilience: 20, 
                opinion: 50, 
                environment: 50,
                delayedEffects: []
            }; 
            
            document.getElementById('event-log').style.display = 'none'; 
            document.getElementById('pass-turn-container').style.display = 'block'; 
            decisionStartTime = Date.now();
            runTurn(); 
        }

        function applyUncertainty(baseEffect, uncertainty) {
            const variation = (Math.random() - 0.5) * 2 * uncertainty; // -uncertainty to +uncertainty
            return Math.round(baseEffect + variation);
        }

        function advanceTurnAndTriggerEvent() { 
            const eventLog = document.getElementById('event-log');
            
            // Apply delayed effects
            gameState.delayedEffects = gameState.delayedEffects.filter(effect => {
                if (effect.turnsLeft <= 0) {
                    for (const eff in effect.effects) {
                        let keyToUpdate = eff.toLowerCase().replace(/ /g, '');
                        if (keyToUpdate === 'opinionepubblica') keyToUpdate = 'opinion';
                        else if (keyToUpdate === 'saluteambientale') keyToUpdate = 'environment';
                        
                        gameState[keyToUpdate] = Math.max(0, Math.min(100, gameState[keyToUpdate] + effect.effects[eff]));
                    }
                    return false; // Remove from array
                }
                effect.turnsLeft--;
                return true;
            });
            
            // Random events with probability
            const eventRoll = Math.random();
            let cumulativeProbability = 0;
            let triggeredEvent = null;
            
            for (const event of EVENTS) {
                cumulativeProbability += event.probability;
                if (eventRoll < cumulativeProbability && gameState.turn > 0) {
                    triggeredEvent = event;
                    break;
                }
            }
            
            if (triggeredEvent) {
                eventLog.innerHTML = `<strong>⚡ Evento Imprevisto!</strong> Nel ${gameState.year+2}, ${triggeredEvent.name} ha colpito la città.`;
                
                for (const eff in triggeredEvent.effects) {
                    let keyToUpdate = eff === 'resilience' ? 'resilience' : eff;
                    if (keyToUpdate === 'opinion') keyToUpdate = 'opinion';
                    else if (keyToUpdate === 'environment') keyToUpdate = 'environment';
                    
                    gameState[keyToUpdate] = Math.max(0, Math.min(100, gameState[keyToUpdate] + triggeredEvent.effects[eff]));
                }
                
                gameData.events.push({
                    turn: gameState.turn,
                    year: gameState.year,
                    event: triggeredEvent.name,
                    effects: triggeredEvent.effects
                });
                
                eventLog.style.display = 'block';
            } else {
                eventLog.style.display = 'none';
            }
            
            gameState.turn++;
            gameState.year += 5;
            
            if (gameState.nextBudgetEffect) {
                gameState.budget += gameState.nextBudgetEffect;
                delete gameState.nextBudgetEffect;
            }
            
            runTurn();
        }

        function passTurn() { 
            const eventLog = document.getElementById('event-log'); 
            eventLog.innerHTML = `💰 Hai deciso di risparmiare il budget per questo mandato, evitando nuovi investimenti.`; 
            eventLog.style.display = 'block';
            
            gameData.decisions.push({
                turn: gameState.turn,
                year: gameState.year,
                decision: 'pass',
                timeSpent: Date.now() - decisionStartTime,
                stateBeforeDecision: {...gameState}
            });
            
            advanceTurnAndTriggerEvent(); 
        }

        function runTurn() { 
            if (gameState.turn >= 6) { 
                endGame(); 
                return; 
            } 
            
            updateGameUI(); 
            decisionStartTime = Date.now();
            
            document.getElementById('news-panel').style.display = 'block'; 
            document.getElementById('news-panel').innerHTML = `📰 <strong>Notiziario Policy:</strong> ${SOCIAL_NORMS[Math.floor(Math.random() * SOCIAL_NORMS.length)]}`; 
            
            const choicesContainer = document.getElementById('choices-container'); 
            choicesContainer.innerHTML = ''; 
            
            if (gameState.turn === 1 || gameState.turn === 4) { 
                choicesContainer.innerHTML += createChoiceCard('bonus', DILEMMAS.bonus, true); 
                choicesContainer.innerHTML += createChoiceCard('manutenzione', DILEMMAS.manutenzione, true); 
            } else { 
                for (const key in INVESTMENTS) { 
                    choicesContainer.innerHTML += createChoiceCard(key, INVESTMENTS[key]); 
                } 
            } 
            
            choicesContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', handleChoice)); 
        }

        function createChoiceCard(key, item, isDilemma=false) { 
            let effectsHTML = '<ul>'; 
            for (const eff_raw in item.effects) { 
                const value = item.effects[eff_raw]; 
                const uncertainty = item.uncertainty ? item.uncertainty[eff_raw] : 0;
                const eff = eff_raw.replace('_next',''); 
                let label = eff.charAt(0).toUpperCase() + eff.slice(1); 
                let text = `${label}: ${value > 0 ? '+' : ''}${value}`;
                
                if(eff === 'budget') text = `Budget prox. turno: ${value > 0 ? '+' : ''}${value}M €`;
                if(uncertainty > 0) text += ` <span class="effect-range">(±${uncertainty})</span>`;
                
                const icon = value >= 0 ? '<span class="impact-good">▲</span>' : '<span class="impact-bad">▼</span>'; 
                effectsHTML += `<li>${icon} ${text}</li>`; 
            } 
            effectsHTML += '</ul>'; 
            
            const buttonClass = `btn-${item.category || 'infrastructure'}`; 
            const uncertaintyBadge = item.uncertainty ? '<div class="uncertainty" title="Effetti incerti: i risultati reali possono variare rispetto alle stime"></div>' : '';
            const delayedNote = item.delayedTurns > 0 ? `<small>⏱️ Effetti in ${item.delayedTurns + 1} turni</small>` : '';
            
            return `<div class="choice-card card-${item.category || 'infrastructure'}">
                ${uncertaintyBadge}
                <h4>${item.name}</h4>
                <p class="cost">${item.cost}M €</p>
                ${effectsHTML}
                ${delayedNote}
                <button class="button ${buttonClass}" data-key="${key}" data-is-dilemma="${isDilemma}">Approva</button>
            </div>`; 
        }

        function handleChoice(event) { 
            const key = event.target.dataset.key; 
            const isDilemma = event.target.dataset.isDilemma === 'true'; 
            const choice = isDilemma ? DILEMMAS[key] : INVESTMENTS[key]; 
            
            if (gameState.budget < choice.cost) { 
                alert("Budget insufficiente per questo investimento!"); 
                return; 
            } 
            
            const timeSpent = Date.now() - decisionStartTime;
            const actualEffects = {};
            
            gameState.budget -= choice.cost; 
            
            for (const eff_raw in choice.effects) { 
                const eff = eff_raw.replace('_next', ''); 
                const baseValue = choice.effects[eff_raw];
                const uncertainty = choice.uncertainty ? choice.uncertainty[eff_raw] || 0 : 0;
                const actualValue = applyUncertainty(baseValue, uncertainty);
                actualEffects[eff_raw] = actualValue;
                
                if (eff_raw.includes('_next')) { 
                    gameState.nextBudgetEffect = (gameState.nextBudgetEffect || 0) + actualValue; 
                } else { 
                    let keyToUpdate = eff.toLowerCase().replace(/ /g, ''); 
                    if (keyToUpdate === 'opinionepubblica') keyToUpdate = 'opinion'; 
                    else if (keyToUpdate === 'saluteambientale') keyToUpdate = 'environment'; 
                    
                    if (choice.delayedTurns > 0) {
                        gameState.delayedEffects.push({
                            effects: { [eff]: actualValue },
                            turnsLeft: choice.delayedTurns
                        });
                    } else {
                        gameState[keyToUpdate] = Math.max(0, Math.min(100, gameState[keyToUpdate] + actualValue)); 
                    }
                } 
            }
            
            gameData.decisions.push({
                turn: gameState.turn,
                year: gameState.year,
                decision: key,
                timeSpent: timeSpent,
                cost: choice.cost,
                expectedEffects: choice.effects,
                actualEffects: actualEffects,
                stateBeforeDecision: {...gameState}
            });
            
            advanceTurnAndTriggerEvent(); 
        }

        function updateGameUI() { 
            document.getElementById('game-year').textContent = gameState.year; 
            document.getElementById('game-budget').textContent = `${gameState.budget}M €`; 
            document.getElementById('game-resilience').textContent = `${gameState.resilience}/100`; 
            document.getElementById('game-opinion').textContent = `${gameState.opinion}/100`; 
            document.getElementById('game-environment').textContent = `${gameState.environment}/100`; 
        }

        function endGame() { 
            gameData.endTime = new Date().toISOString();
            const choicesContainer = document.getElementById('choices-container'); 
            const finalState = gameState; 
            
            let feedbackText = ''; 
            let strategyAnalysis = '';
            
            if (finalState.resilience < 30) { 
                feedbackText = `<p class='impact-bad'>⚠️ La città è rimasta molto vulnerabile agli eventi climatici estremi.</p>`; 
            } else if (finalState.resilience > 70) { 
                feedbackText = `<p class='impact-good'>🛡️ Eccellente! Hai reso la città molto resiliente ai cambiamenti climatici.</p>`; 
            } else { 
                feedbackText = `<p>🏛️ Hai mantenuto un discreto livello di resilienza per la città.</p>`; 
            }
            
            // Strategy analysis
            const avgEnvironment = finalState.environment;
            const avgOpinion = finalState.opinion;
            
            if (avgEnvironment > 60 && avgOpinion > 60) {
                strategyAnalysis = "🌟 Strategia bilanciata: Hai trovato un ottimo equilibrio tra sostenibilità e consenso.";
            } else if (finalState.resilience > 70) {
                strategyAnalysis = "🛡️ Strategia resilience-focused: Hai privilegiato la protezione climatica.";
            } else if (avgOpinion > 70) {
                strategyAnalysis = "🗳️ Strategia consenso-focused: Hai mantenuto alto il gradimento pubblico.";
            } else {
                strategyAnalysis = "⚖️ Strategia di compromesso: Hai cercato equilibri in situazioni complesse.";
            }
            
            let summaryHTML = `<div class="end-game-summary">
                <h4>Mandato Concluso: Riepilogo Finale (Anno ${finalState.year})</h4>
                <div class="final-metrics">
                    <div class="final-metric">
                        <div class="label">Resilienza</div>
                        <div class="value" style="color:var(--success-color)">${finalState.resilience}/100</div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar progress-resilience" style="width: ${finalState.resilience}%;"></div>
                        </div>
                    </div>
                    <div class="final-metric">
                        <div class="label">Opinione Pubblica</div>
                        <div class="value" style="color:var(--warning-color)">${finalState.opinion}/100</div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar progress-opinion" style="width: ${finalState.opinion}%;"></div>
                        </div>
                    </div>
                    <div class="final-metric">
                        <div class="label">Salute Ambientale</div>
                        <div class="value" style="color:var(--teal-color)">${finalState.environment}/100</div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar progress-environment" style="width: ${finalState.environment}%;"></div>
                        </div>
                    </div>
                </div>
                <div class="final-feedback">${feedbackText}</div>
                <div class="final-feedback">${strategyAnalysis}</div>
                <div class="text-center">
                    <button class="button" onclick="showView('view-questionnaire')">Prosegui al Questionario</button>
                </div>
            </div>`; 
            
            choicesContainer.innerHTML = summaryHTML; 
            document.getElementById('news-panel').style.display = 'none'; 
            document.getElementById('event-log').style.display = 'none'; 
            document.getElementById('pass-turn-container').style.display = 'none'; 
        }
        
        // --- ENHANCED REPORT LOGIC ---
        function renderReport() { 
            const container = document.getElementById('report-content'); 
            container.innerHTML = ''; 
            
            for (const key in INVESTMENTS) { 
                const inv = INVESTMENTS[key]; 
                const section = document.createElement('div'); 
                section.className = 'report-section'; 
                
                let effectsHTML = '<ul>'; 
                for (const eff in inv.effects) { 
                    const impact = inv.effects[eff] > 0 ? 'positivo' : 'negativo';
                    const magnitude = Math.abs(inv.effects[eff]);
                    effectsHTML += `<li><strong>${eff}:</strong> Impatto ${impact} (${magnitude} punti)</li>`; 
                } 
                effectsHTML += '</ul>'; 
                
                let uncertaintyNote = '';
                if (inv.uncertainty) {
                    uncertaintyNote = '<p><em>Nota: Gli effetti reali possono variare in base a condizioni locali e fattori imprevisti.</em></p>';
                }
                
                let delayNote = '';
                if (inv.delayedTurns > 0) {
                    delayNote = `<p><strong>⏱️ Tempistiche:</strong> I benefici principali si manifestano dopo ${inv.delayedTurns * 5} anni dall'implementazione.</p>`;
                }
                
                section.innerHTML = `
                    <h4>${inv.name}</h4>
                    <p><strong>Investimento richiesto:</strong> ${inv.cost} milioni di euro</p>
                    <strong>Impatti attesi:</strong>${effectsHTML}
                    ${delayNote}
                    ${uncertaintyNote}
                `; 
                container.appendChild(section); 
            } 
        }

        // --- ENHANCED QUESTIONNAIRE LOGIC ---
        function selectPolicy(choice) { 
            document.getElementById('policy-a').classList.remove('selected'); 
            document.getElementById('policy-b').classList.remove('selected'); 
            document.getElementById(`policy-${choice}`).classList.add('selected'); 
            document.getElementById('policy-choice-input').value = choice; 
        }

        function handleLikertSelection(event) { 
            const button = event.target.closest('.likert-btn'); 
            if (!button) return; 
            
            const value = button.dataset.value; 
            const container = button.parentElement; 
            const targetInputId = container.dataset.targetInput; 
            const input = document.getElementById(targetInputId); 
            
            if (input) { 
                input.value = value; 
                container.querySelectorAll('.likert-btn').forEach(btn => btn.classList.remove('selected')); 
                button.classList.add('selected'); 
            } 
        }

        // Enhanced event listeners for all Likert scales
        document.addEventListener('DOMContentLoaded', () => { 
            ['likert-efficacy', 'likert-risk', 'likert-tradeoff', 'likert-temporal', 'likert-collective'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', handleLikertSelection);
                }
            });
        });

        function handleQuestionnaireSubmit() { 
            // Collect all questionnaire data
            const questionnaireData = {
                policyChoice: document.getElementById('policy-choice-input').value,
                efficacy: document.getElementById('q-efficacy-input').value,
                risk: document.getElementById('q-risk-input').value,
                tradeoff: document.getElementById('q-tradeoff-input').value,
                temporal: document.getElementById('q-temporal-input').value,
                collective: document.getElementById('q-collective-input').value,
                submissionTime: new Date().toISOString()
            };
            
            gameData.questionnaire = questionnaireData;
            
            if (wasInGame) { 
                renderDebriefing(); 
                showView('view-debriefing'); 
            } else { 
                // For report condition, show a simple completion message
                alert('Grazie per aver partecipato alla ricerca! I tuoi dati sono stati registrati.');
                showView('view-start'); 
            } 
        }

        // --- ENHANCED DEBRIEFING LOGIC ---
        function renderDebriefing() { 
            const dashboard = document.getElementById('debriefing-dashboard'); 
            dashboard.innerHTML = `
                <div id="game-dashboard"> 
                    <div class="metric">
                        <div class="label">Resilienza Finale</div>
                        <div class="value" style="color:var(--success-color)">${gameState.resilience}/100</div>
                    </div> 
                    <div class="metric">
                        <div class="label">Consenso Finale</div>
                        <div class="value" style="color:var(--warning-color)">${gameState.opinion}/100</div>
                    </div> 
                    <div class="metric">
                        <div class="label">Ambiente Finale</div>
                        <div class="value" style="color:var(--teal-color)">${gameState.environment}/100</div>
                    </div>
                    <div class="metric">
                        <div class="label">Budget Residuo</div>
                        <div class="value" style="color:var(--primary-color)">${gameState.budget}M €</div>
                    </div>
                    <div class="metric">
                        <div class="label">Decisioni Prese</div>
                        <div class="value">${gameData.decisions.length}</div>
                    </div>
                </div>`; 
            
            const analysis = document.getElementById('debriefing-analysis'); 
            
            // Detailed analysis
            let strategicProfile = '';
            const decisions = gameData.decisions.filter(d => d.decision !== 'pass');
            const constructiveCount = decisions.filter(d => INVESTMENTS[d.decision] && INVESTMENTS[d.decision].category === 'constructive').length;
            const infrastructureCount = decisions.filter(d => INVESTMENTS[d.decision] && INVESTMENTS[d.decision].category === 'infrastructure').length;
            const politicalCount = decisions.filter(d => INVESTMENTS[d.decision] && INVESTMENTS[d.decision].category === 'political').length;
            
            if (constructiveCount > infrastructureCount && constructiveCount > politicalCount) {
                strategicProfile = '🌱 <strong>Profilo "Nature-Based":</strong> Hai privilegiato soluzioni basate sulla natura e approcci costruttivi.';
            } else if (infrastructureCount > 0) {
                strategicProfile = '🏗️ <strong>Profilo "Infrastructure-Heavy":</strong> Hai puntato su soluzioni infrastrutturali tradizionali.';
            } else if (politicalCount > 0) {
                strategicProfile = '🗳️ <strong>Profilo "Politics-Aware":</strong> Hai considerato attentamente le dinamiche politiche e di consenso.';
            } else {
                strategicProfile = '💰 <strong>Profilo "Conservativo":</strong> Hai adottato un approccio prudente nella gestione delle risorse.';
            }
            
            const avgDecisionTime = gameData.decisions.reduce((sum, d) => sum + d.timeSpent, 0) / gameData.decisions.length / 1000;
            const timeProfile = avgDecisionTime > 30 ? 'decisore riflessivo' : avgDecisionTime > 15 ? 'decisore bilanciato' : 'decisore rapido';
            
            analysis.innerHTML = `
                <p>${strategicProfile}</p>
                <p><strong>🕐 Stile Decisionale:</strong> Sei un <em>${timeProfile}</em> (tempo medio: ${avgDecisionTime.toFixed(1)} secondi per decisione).</p>
                <p><strong>🎯 Impatto delle tue scelte:</strong> Le tue decisioni hanno portato la città a un equilibrio finale che riflette le priorità che hai dato durante il mandato.</p>
                <p><strong>📚 Cosa illustra questo gioco:</strong> Questa simulazione evidenzia i complessi <strong>trade-off</strong> che i decisori pubblici devono affrontare nel bilanciare resilienza climatica, consenso sociale, sostenibilità ambientale e vincoli economici.</p>
            `; 
        }

        // Data export functionality
        function exportGameData() {
            const exportButton = document.querySelector('.data-export button');
            const dataDisplay = document.getElementById('game-data-display');
            const exportContainer = document.getElementById('exported-data');
            
            if (exportContainer.style.display === 'none') {
                const fullData = {
                    experimentalCondition: gameData.condition,
                    startTime: gameData.startTime,
                    endTime: gameData.endTime,
                    finalGameState: gameState,
                    allDecisions: gameData.decisions,
                    randomEvents: gameData.events,
                    questionnaireResponses: gameData.questionnaire,
                    participantBrowser: navigator.userAgent,
                    screenSize: `${window.innerWidth}x${window.innerHeight}`
                };
                
                dataDisplay.textContent = JSON.stringify(fullData, null, 2);
                exportContainer.style.display = 'block';
                exportButton.textContent = 'Nascondi Dati';
            } else {
                exportContainer.style.display = 'none';
                exportButton.textContent = 'Mostra/Esporta Dati della Sessione';
            }
        }

        function saveReflectionsAndFinish() {
            // Collect reflection responses
            const reflections = {
                difficultDecision: document.getElementById('reflection-1').value,
                strategyChange: document.getElementById('reflection-2').value,
                realism: document.getElementById('reflection-3').value,
                timestamp: new Date().toISOString()
            };
            
            gameData.reflections = reflections;
            
            // In a real implementation, this would send data to server
            console.log('Complete session data:', gameData);
            
            alert('Grazie per aver partecipato! Le tue riflessioni e dati di gioco sono stati salvati per la ricerca.');
            showView('view-start');
        }

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Playing for Resilience - Prototipo Migliorato caricato');
            
            // Reset tutorial on page load
            tutorialStep = 1;
            document.querySelectorAll('[id^="tutorial-step-"]').forEach((step, index) => {
                step.style.display = index === 0 ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>