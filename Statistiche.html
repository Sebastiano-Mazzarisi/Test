<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Famiglia Pricci</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDF9E4; 
            color: #402E32;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');
        h1, h2, h3 {
            font-family: 'Lora', serif;
            color: #9A3B3B;
        }
        .nav-link {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .nav-link.active {
            background-color: #F8EAD8;
            border-left-color: #9A3B3B;
            color: #9A3B3B;
            font-weight: 600;
        }
        .nav-link:not(.exit-link):not(.print-link):hover {
            background-color: #F8EAD8;
            border-left-color: #C08261;
        }
        .kpi-card {
            background-color: #F8EAD8;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            position: relative;
            background-color: #F8EAD8;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            height: 400px;
            width: 100%;
            margin: auto;
        }
        .section-divider {
            border-bottom: 3px solid #C08261;
            margin: 3rem 0;
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>

    <!-- Fixed Header -->
    <header class="fixed top-0 left-0 w-full bg-[#F6E9B2] p-4 z-50 shadow-md">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold">Dashboard Famiglia Pricci</h1>
            <div class="flex gap-4">
                <button id="print-btn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Report
                </button>
                <button id="exit-btn" class="flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Esci
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Menu -->
    <nav class="fixed top-20 left-0 w-full bg-[#F8EAD8] p-2 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto">
            <ul class="flex justify-center space-x-6 text-sm">
                <li><a href="#panoramica" class="nav-anchor px-3 py-2 rounded hover:bg-[#C08261] hover:text-white transition-colors">üìä Panoramica</a></li>
                <li><a href="#generazioni" class="nav-anchor px-3 py-2 rounded hover:bg-[#C08261] hover:text-white transition-colors">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Generazioni</a></li>
                <li><a href="#matrimoni" class="nav-anchor px-3 py-2 rounded hover:bg-[#C08261] hover:text-white transition-colors">‚ö≠ Matrimoni</a></li>
                <li><a href="#nascite" class="nav-anchor px-3 py-2 rounded hover:bg-[#C08261] hover:text-white transition-colors">üë∂ Nascite</a></li>
                <li><a href="#dati" class="nav-anchor px-3 py-2 rounded hover:bg-[#C08261] hover:text-white transition-colors">üìã Dati</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-32 px-4 md:px-8 max-w-7xl mx-auto">

        <!-- Panoramica Section -->
        <section id="panoramica" class="section-divider">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold">Panoramica Demografica</h2>
                <p class="mt-2 text-lg text-gray-600">Una visione d'insieme dei dati chiave della famiglia Pricci</p>
            </header>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <div class="kpi-card">
                    <div class="text-4xl font-bold" id="total-members">33</div>
                    <div class="text-sm mt-2">Membri Totali</div>
                </div>
                <div class="kpi-card">
                    <div class="text-4xl font-bold" id="avg-age">48.9</div>
                    <div class="text-sm mt-2">Et√† Media</div>
                </div>
                <div class="kpi-card">
                    <div class="text-4xl font-bold" id="time-span">86</div>
                    <div class="text-sm mt-2">Arco Temporale</div>
                </div>
                <div class="kpi-card">
                    <div class="text-4xl font-bold" id="median-birth-year">1974</div>
                    <div class="text-sm mt-2">Anno Nascita Med.</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-center mb-4">Distribuzione per Genere</h3>
                    <canvas id="gender-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-center mb-4">Composizione Generazionale</h3>
                    <canvas id="generation-pie-chart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                 <h3 class="text-xl font-bold text-center mb-4">Calendario Sociale: Gli Onomastici</h3>
                 <canvas id="onomastici-chart"></canvas>
            </div>
        </section>

        <!-- Generazioni Section -->
        <section id="generazioni" class="section-divider">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold">Analisi Generazionale</h2>
                <p class="mt-2 text-lg text-gray-600">Un confronto tra le generazioni per osservare l'evoluzione della famiglia</p>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-center mb-4">Numerosit√† delle Generazioni</h3>
                    <canvas id="generation-bar-chart"></canvas>
                </div>
                 <div class="chart-container">
                    <h3 class="text-xl font-bold text-center mb-4">Et√† Media alla Genitorialit√†</h3>
                    <canvas id="parenting-age-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Matrimoni Section -->
        <section id="matrimoni" class="section-divider">
             <header class="text-center mb-8">
                <h2 class="text-3xl font-bold">Statistiche Matrimoniali</h2>
                <p class="mt-2 text-lg text-gray-600">Un'analisi delle unioni che hanno formato i nuclei familiari</p>
            </header>
            <div class="chart-container mb-8 max-w-4xl mx-auto">
                <h3 class="text-xl font-bold text-center mb-4">Et√† Media al Matrimonio: Uomini vs Donne</h3>
                <canvas id="marriage-age-chart"></canvas>
            </div>
            <div class="bg-[#F8EAD8] p-6 rounded-lg shadow-md">
                 <h3 class="text-xl font-bold mb-4 text-center">Dettaglio delle Unioni</h3>
                 <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b-2 border-[#C08261]">
                                <th class="p-3">Coppia</th>
                                <th class="p-3">Data Matrimonio</th>
                                <th class="p-3">Et√† Marito</th>
                                <th class="p-3">Et√† Moglie</th>
                                <th class="p-3">Differenza</th>
                            </tr>
                        </thead>
                        <tbody id="marriage-table"></tbody>
                    </table>
                 </div>
            </div>
        </section>

        <!-- Nascite Section -->
        <section id="nascite" class="section-divider">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold">Natalit√† e Fertilit√†</h2>
                <p class="mt-2 text-lg text-gray-600">L'evoluzione dei modelli di procreazione nella storia della famiglia</p>
            </header>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-center mb-4">Distribuzione Mensile Nascite</h3>
                    <canvas id="birth-month-chart"></canvas>
                </div>
                 <div class="chart-container">
                    <h3 class="text-xl font-bold text-center mb-4">Numero di Figli per Coppia</h3>
                    <canvas id="children-per-couple-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Dati Completi Section -->
        <section id="dati">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold">Esplora i Dati Completi</h2>
                <p class="mt-2 text-lg text-gray-600">Cerca, filtra e ordina i dati anagrafici di tutti i membri della famiglia</p>
            </header>
            <div class="bg-[#F8EAD8] p-6 rounded-lg shadow-md">
                <input type="text" id="search-input" class="w-full p-3 mb-4 border border-gray-300 rounded-lg" placeholder="Cerca per nome, cognome...">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b-2 border-[#C08261]">
                            <tr>
                                <th class="p-3 cursor-pointer" onclick="sortTable(0)">Cognome ‚Üì</th>
                                <th class="p-3 cursor-pointer" onclick="sortTable(1)">Nome ‚Üì</th>
                                <th class="p-3 cursor-pointer" onclick="sortTable(2)">Sesso ‚Üì</th>
                                <th class="p-3 cursor-pointer" onclick="sortTable(3)">Nascita ‚Üì</th>
                                <th class="p-3 cursor-pointer" onclick="sortTable(4)">Gen. ‚Üì</th>
                                <th class="p-3 cursor-pointer" onclick="sortTable(5)">Et√† ‚Üì</th>
                            </tr>
                        </thead>
                        <tbody id="full-data-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <footer class="mt-16 py-8 text-center text-gray-500">
        <p>&copy; 2025 Dashboard Famiglia Pricci - Generato con amore per la famiglia</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // Verifica che Chart.js sia caricato
            if (typeof Chart === 'undefined') {
                console.error('Chart.js non √® caricato correttamente');
                return;
            }

            // Registra il plugin dei data labels
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }
            
            window.chartInstances = {};

            const familyData = [
                { id: 3, cognome: "Pricci", nome: "Luigi", sesso: "M", nascita: "1933-11-16", morte: null, gen: "G1" },
                { id: 4, cognome: "Grilletti", nome: "Teresa", sesso: "F", nascita: "1937-03-05", morte: null, gen: "G1" },
                { id: 5, cognome: "Lorusso", nome: "Onofrio", sesso: "M", nascita: "1951-08-05", morte: null, gen: "G2" },
                { id: 6, cognome: "Chiarappa", nome: "Saverio", sesso: "M", nascita: "1951-11-26", morte: null, gen: "G2" },
                { id: 7, cognome: "Pricci", nome: "Angela", sesso: "F", nascita: "1957-01-13", morte: null, gen: "G2" },
                { id: 8, cognome: "Lefemine", nome: "Domenico", sesso: "M", nascita: "1957-02-06", morte: null, gen: "G2" },
                { id: 9, cognome: "Mazzarisi", nome: "Sebastiano", sesso: "M", nascita: "1957-05-07", morte: null, gen: "G2" },
                { id: 10, cognome: "Pricci", nome: "Maria Antonietta", sesso: "F", nascita: "1958-05-21", morte: null, gen: "G2" },
                { id: 11, cognome: "Pricci", nome: "Marica", sesso: "F", nascita: "1961-04-12", morte: null, gen: "G2" },
                { id: 12, cognome: "Pricci", nome: "Vanna", sesso: "F", nascita: "1963-09-11", morte: null, gen: "G2" },
                { id: 13, cognome: "Pricci", nome: "Giovanni", sesso: "M", nascita: "1964-10-24", morte: null, gen: "G2" },
                { id: 14, cognome: "Pricci", nome: "Giuseppe", sesso: "M", nascita: "1968-08-12", morte: null, gen: "G2" },
                { id: 15, cognome: "Trivisani", nome: "Anna", sesso: "F", nascita: "1969-07-12", morte: null, gen: "G2" },
                { id: 16, cognome: "Bianco", nome: "Rosa", sesso: "F", nascita: "1971-09-02", morte: null, gen: "G2" },
                { id: 17, cognome: "Pricci", nome: "Tiziana", sesso: "F", nascita: "1972-06-27", morte: null, gen: "G2" },
                { id: 18, cognome: "Dalena", nome: "Riccardo", sesso: "M", nascita: "1973-04-11", morte: null, gen: "G2" },
                { id: 19, cognome: "Rotondi", nome: "Gianni", sesso: "M", nascita: "1974-03-08", morte: null, gen: "G3" },
                { id: 20, cognome: "Lepore", nome: "Genny", sesso: "F", nascita: "1975-07-04", morte: null, gen: "G3" },
                { id: 21, cognome: "Lorusso", nome: "Benny", sesso: "M", nascita: "1975-11-17", morte: null, gen: "G3" },
                { id: 22, cognome: "Lorusso", nome: "Cinzia", sesso: "F", nascita: "1980-04-06", morte: null, gen: "G3" },
                { id: 23, cognome: "Mazzarisi", nome: "Maria Grazia", sesso: "F", nascita: "1989-01-21", morte: null, gen: "G3" },
                { id: 24, cognome: "Mazzarisi", nome: "Onofrio", sesso: "M", nascita: "1992-06-05", morte: null, gen: "G3" },
                { id: 25, cognome: "Mazzarisi", nome: "Teresa", sesso: "F", nascita: "1994-04-01", morte: null, gen: "G3" },
                { id: 26, cognome: "Lefemine", nome: "Flavia", sesso: "F", nascita: "1996-11-16", morte: null, gen: "G3" },
                { id: 27, cognome: "Chiarappa", nome: "Martino", sesso: "M", nascita: "1997-05-24", morte: null, gen: "G3" },
                { id: 28, cognome: "Lefemine", nome: "Francesco", sesso: "M", nascita: "2000-03-20", morte: null, gen: "G3" },
                { id: 29, cognome: "Chiarappa", nome: "Cristiano", sesso: "M", nascita: "2001-06-20", morte: null, gen: "G3" },
                { id: 30, cognome: "Pricci", nome: "Gilda", sesso: "F", nascita: "2004-06-29", morte: null, gen: "G3" },
                { id: 31, cognome: "Pricci", nome: "Asia", sesso: "F", nascita: "2006-06-07", morte: null, gen: "G3" },
                { id: 32, cognome: "Lorusso", nome: "Alessandro", sesso: "M", nascita: "2010-07-17", morte: null, gen: "G4" },
                { id: 33, cognome: "Lorusso", nome: "Alice", sesso: "F", nascita: "2013-07-20", morte: null, gen: "G4" },
                { id: 34, cognome: "Lorusso", nome: "Nina", sesso: "F", nascita: "2015-11-29", morte: null, gen: "G4" },
                { id: 35, cognome: "Rotondi", nome: "Nicoletta", sesso: "F", nascita: "2019-02-12", morte: null, gen: "G4" }
            ];

            const marriageData = [
                { marito: "Luigi Pricci", moglie: "Teresa Grilletti", data: "1956-12-03" },
                { marito: "Onofrio Lorusso", moglie: "Angela Pricci", data: "1975-08-09" },
                { marito: "Sebastiano Mazzarisi", moglie: "Marica Pricci", data: "1987-07-04" },
                { marito: "Domenico Lefemine", moglie: "Vanna Pricci", data: "1991-08-28" },
                { marito: "Giuseppe Pricci", moglie: "Anna Trivisani", data: "1997-07-09" },
                { marito: "Saverio Chiarappa", moglie: "Maria Antonietta Pricci", data: "2000-09-09" },
                { marito: "Riccardo Dalena", moglie: "Tiziana Pricci", data: "2002-10-04" },
                { marito: "Giovanni Pricci", moglie: "Rosa Bianco", data: "2004-12-29" },
                { marito: "Benny Lorusso", moglie: "Genny Lepore", data: "2008-07-26" },
                { marito: "Gianni Rotondi", moglie: "Cinzia Lorusso", data: "2014-09-13" }
            ];

            const onomasticiData = {
                "Gennaio": { "20": ["Sebastiano Mazzarisi"] },
                "Febbraio": { "13": ["Gilda Pricci"], "19": ["Asia Pricci"] },
                "Marzo": { "3": ["Tiziana Pricci"], "19": ["Giuseppe Pricci"], "21": ["Benny Lorusso"] },
                "Aprile": { "3": ["Riccardo Dalena"], "7": ["Cristiano Chiarappa"], "11": ["Genny Lepore"] },
                "Maggio": { "7": ["Flavia Lefemine"] },
                "Giugno": { "12": ["Onofrio Lorusso", "Onofrio Mazzarisi"], "13": ["Maria Antonietta Pricci", "Alice Lorusso", "Cinzia Lorusso"], "21": ["Luigi Pricci"], "24": ["Giovanni Pricci", "Vanna Pricci", "Gianni Rotondi"] },
                "Luglio": { "26": ["Anna Trivisani"] },
                "Agosto": { "2": ["Angela Pricci"], "4": ["Domenico Lefemine"], "23": ["Rosa Bianco"], "26": ["Alessandro Lorusso"] },
                "Settembre": { "12": ["Marica Pricci", "Maria Grazia Mazzarisi"] },
                "Ottobre": { "4": ["Francesco Lefemine"], "15": ["Teresa Grilletti", "Teresa Mazzarisi"] },
                "Novembre": { "11": ["Martino Chiarappa"] },
                "Dicembre": { "3": ["Saverio Chiarappa"], "6": ["Nicoletta Rotondi"], "15": ["Nina Lorusso"] }
            };

            const childrenData = [
                { coppia: "Luigi & Teresa", figli: 7, gen: "G1" },
                { coppia: "Onofrio & Angela", figli: 2, gen: "G2" },
                { coppia: "Saverio & M.A.", figli: 2, gen: "G2" },
                { coppia: "Sebastiano & Marica", figli: 3, gen: "G2" },
                { coppia: "Domenico & Vanna", figli: 2, gen: "G2" },
                { coppia: "Giuseppe & Anna", figli: 2, gen: "G2" },
                { coppia: "Giovanni & Rosa", figli: 0, gen: "G2" },
                { coppia: "Riccardo & Tiziana", figli: 0, gen: "G2" },
                { coppia: "Benny & Genny", figli: 3, gen: "G3" },
                { coppia: "Gianni & Cinzia", figli: 1, gen: "G3" }
            ];

            Chart.register(ChartDataLabels);
            
            const getAge = (birthDate, deathDate = null) => {
                const start = new Date(birthDate);
                const end = deathDate ? new Date(deathDate) : new Date();
                let age = end.getFullYear() - start.getFullYear();
                const m = end.getMonth() - start.getMonth();
                if (m < 0 || (m === 0 && end.getDate() < start.getDate())) {
                    age--;
                }
                return age;
            };

            const findPerson = (fullName) => {
                const parts = fullName.split(' ');
                const lastName = parts.pop();
                const firstName = parts.join(' ');
                return familyData.find(p => p.nome === firstName && p.cognome === lastName);
            };

            familyData.forEach(p => p.eta = getAge(p.nascita, p.morte));
            
            // KPI Cards
            const totalMembers = familyData.length;
            const totalAge = familyData.reduce((sum, p) => sum + p.eta, 0);
            const birthYears = familyData.map(p => new Date(p.nascita).getFullYear()).sort();
            document.getElementById('total-members').textContent = totalMembers;
            document.getElementById('avg-age').textContent = (totalAge / totalMembers).toFixed(1);
            document.getElementById('time-span').textContent = birthYears[birthYears.length - 1] - birthYears[0];
            document.getElementById('median-birth-year').textContent = birthYears[Math.floor(birthYears.length / 2)];

            // Chart Colors
            const chartColors = {
                primary: '#9A3B3B',
                secondary: '#C08261',
                accent: '#E2C799',
                background: '#F8EAD8',
                text: '#402E32'
            };

            const chartDefaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: chartColors.text,
                            font: { family: "'Inter', sans-serif" }
                        }
                    },
                    datalabels: {
                        color: chartColors.text,
                        font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: chartColors.text, font: { family: "'Inter', sans-serif" } },
                        grid: { color: '#E2C79950' }
                    },
                    x: {
                        ticks: { color: chartColors.text, font: { family: "'Inter', sans-serif" } },
                        grid: { color: '#E2C79950' }
                    }
                }
            };
            
            // Gender Chart
            const maleCount = familyData.filter(p => p.sesso === 'M').length;
            const femaleCount = familyData.filter(p => p.sesso === 'F').length;
            window.chartInstances['gender-chart'] = new Chart(document.getElementById('gender-chart'), {
                type: 'doughnut',
                data: {
                    labels: ['Maschi', 'Femmine'],
                    datasets: [{
                        label: 'Distribuzione per Genere',
                        data: [maleCount, femaleCount],
                        backgroundColor: [chartColors.secondary, chartColors.primary],
                        borderColor: chartColors.background,
                        borderWidth: 4
                    }]
                },
                options: { 
                    ...chartDefaultOptions, 
                    scales: {},
                    plugins: {
                        ...chartDefaultOptions.plugins,
                        datalabels: {
                            color: '#FFFFFF',
                            formatter: (value, ctx) => {
                                const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = (value * 100 / sum).toFixed(1) + '%';
                                return percentage;
                            },
                            font: { weight: 'bold' }
                        }
                    } 
                }
            });

            // Generation Pie Chart
            const genCounts = familyData.reduce((acc, p) => {
                acc[p.gen] = (acc[p.gen] || 0) + 1;
                return acc;
            }, {});
            
            window.chartInstances['generation-pie-chart'] = new Chart(document.getElementById('generation-pie-chart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(genCounts).sort(),
                    datasets: [{
                        data: Object.keys(genCounts).sort().map(k => genCounts[k]),
                        backgroundColor: [chartColors.primary, chartColors.secondary, chartColors.accent, '#A94438'],
                        borderColor: chartColors.background,
                        borderWidth: 4
                    }]
                },
                options: { 
                    ...chartDefaultOptions, 
                    scales: {},
                    plugins: {
                        ...chartDefaultOptions.plugins,
                        datalabels: {
                            color: '#FFFFFF',
                            formatter: (value) => value,
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
            
            // Onomastici Chart
            const onomasticiCounts = Object.keys(onomasticiData).map(month => {
                 return Object.values(onomasticiData[month]).reduce((sum, arr) => sum + arr.length, 0);
            });
            
            window.chartInstances['onomastici-chart'] = new Chart(document.getElementById('onomastici-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(onomasticiData),
                    datasets: [{
                        label: 'Numero di Onomastici',
                        data: onomasticiCounts,
                        backgroundColor: chartColors.secondary
                    }]
                },
                options: {
                    ...chartDefaultOptions,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#FFFFFF'
                        }
                    }
                }
            });

            // Generation Bar Chart
            window.chartInstances['generation-bar-chart'] = new Chart(document.getElementById('generation-bar-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(genCounts).sort(),
                    datasets: [{
                        label: 'Numero di Membri',
                        data: Object.keys(genCounts).sort().map(k => genCounts[k]),
                        backgroundColor: chartColors.secondary
                    }]
                },
                options: {
                    ...chartDefaultOptions,
                    plugins: {
                        ...chartDefaultOptions.plugins,
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#FFFFFF'
                        }
                    }
                }
            });

            // Parenting Age Chart
            window.chartInstances['parenting-age-chart'] = new Chart(document.getElementById('parenting-age-chart'), {
                type: 'bar',
                data: {
                    labels: ['Genitori G1', 'Genitori G2', 'Genitori G3'],
                    datasets: [
                        {
                            label: 'Et√† Media Madri',
                            data: [26.1, 28.4, 37.7],
                            backgroundColor: chartColors.primary,
                        },
                        {
                            label: 'Et√† Media Padri',
                            data: [30.1, 30.8, 39.5],
                            backgroundColor: chartColors.secondary,
                        }
                    ]
                },
                options: {
                    ...chartDefaultOptions,
                    plugins: {
                        ...chartDefaultOptions.plugins,
                        datalabels: {
                           color: '#FFFFFF',
                           anchor: 'center',
                           align: 'center',
                           formatter: (value) => value.toFixed(1)
                        }
                    }
                }
            });

            // Marriage Age Chart
            const marriageAges = marriageData.map(m => {
                const maritoData = findPerson(m.marito);
                const moglieData = findPerson(m.moglie);
                if (!maritoData || !moglieData) return null;
                return {
                    maritoAge: getAge(maritoData.nascita, m.data),
                    moglieAge: getAge(moglieData.nascita, m.data),
                };
            }).filter(Boolean);

            const avgMaritoAge = marriageAges.length > 0 ? marriageAges.reduce((s, a) => s + a.maritoAge, 0) / marriageAges.length : 0;
            const avgMoglieAge = marriageAges.length > 0 ? marriageAges.reduce((s, a) => s + a.moglieAge, 0) / marriageAges.length : 0;
            
            window.chartInstances['marriage-age-chart'] = new Chart(document.getElementById('marriage-age-chart'), {
                type: 'bar',
                data: {
                    labels: ['Et√† Media al Matrimonio'],
                    datasets: [
                        { label: 'Uomini', data: [avgMaritoAge], backgroundColor: chartColors.secondary },
                        { label: 'Donne', data: [avgMoglieAge], backgroundColor: chartColors.primary }
                    ]
                },
                options: {
                    ...chartDefaultOptions,
                    plugins: {
                        ...chartDefaultOptions.plugins,
                        datalabels: {
                           anchor: 'center',
                           align: 'center',
                           color: '#FFFFFF',
                           formatter: (value) => value.toFixed(1)
                        }
                    }
                }
            });

            // Marriage Table
            const marriageTableBody = document.getElementById('marriage-table');
            marriageData.forEach(m => {
                const maritoData = findPerson(m.marito);
                const moglieData = findPerson(m.moglie);
                if (!maritoData || !moglieData) return;

                const maritoAge = getAge(maritoData.nascita, m.data);
                const moglieAge = getAge(moglieData.nascita, m.data);
                const diff = maritoAge - moglieAge;

                const row = document.createElement('tr');
                row.className = 'border-b border-[#E2C799] hover:bg-[#F6E9B2]';
                row.innerHTML = `
                    <td class="p-3">${m.marito} & ${m.moglie}</td>
                    <td class="p-3">${new Date(m.data).toLocaleDateString('it-IT')}</td>
                    <td class="p-3">${maritoAge}</td>
                    <td class="p-3">${moglieAge}</td>
                    <td class="p-3">${diff > 0 ? '+' : ''}${diff}</td>
                `;
                marriageTableBody.appendChild(row);
            });
            
            // Birth Month Chart
            const birthMonths = familyData.map(p => new Date(p.nascita).getMonth());
            const monthCounts = Array(12).fill(0);
            birthMonths.forEach(m => monthCounts[m]++);
            
            window.chartInstances['birth-month-chart'] = new Chart(document.getElementById('birth-month-chart'), {
                type: 'bar',
                data: {
                    labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Numero di Nascite',
                        data: monthCounts,
                        backgroundColor: chartColors.accent,
                        borderColor: chartColors.secondary,
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartDefaultOptions,
                    plugins: {
                        ...chartDefaultOptions.plugins,
                        datalabels: {
                           anchor: 'center',
                           align: 'center',
                           color: chartColors.text
                        }
                    }
                }
            });

            // Children per Couple Chart
            window.chartInstances['children-per-couple-chart'] = new Chart(document.getElementById('children-per-couple-chart'), {
                type: 'bar',
                data: {
                    labels: childrenData.map(c => c.coppia),
                    datasets: [{
                        label: 'Numero di Figli',
                        data: childrenData.map(c => c.figli),
                        backgroundColor: (context) => {
                            const gen = childrenData[context.dataIndex].gen;
                            return gen === 'G1' ? chartColors.primary : (gen === 'G2' ? chartColors.secondary : chartColors.accent);
                        }
                    }]
                },
                options: {
                    ...chartDefaultOptions,
                    plugins: {
                         ...chartDefaultOptions.plugins,
                         datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#FFFFFF'
                         }
                    },
                    scales: {
                        ...chartDefaultOptions.scales,
                        x: { 
                            ...chartDefaultOptions.scales.x,
                            ticks: {
                                ...chartDefaultOptions.scales.x.ticks,
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 15 ? label.split(' & ') : label;
                                }
                            }
                        }
                    }
                }
            });

            // Full Data Table
            const fullDataTable = document.getElementById('full-data-table');
            const searchInput = document.getElementById('search-input');
            let currentSort = { column: 0, direction: 'asc' };

            const populateTable = (data) => {
                fullDataTable.innerHTML = '';
                data.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-[#E2C799] hover:bg-[#F6E9B2]';
                    row.innerHTML = `
                        <td class="p-3">${p.cognome}</td>
                        <td class="p-3">${p.nome}</td>
                        <td class="p-3">${p.sesso}</td>
                        <td class="p-3">${new Date(p.nascita).toLocaleDateString('it-IT')}</td>
                        <td class="p-3">${p.gen}</td>
                        <td class="p-3">${p.eta}</td>
                    `;
                    fullDataTable.appendChild(row);
                });
            };
            
            window.sortTable = (columnIndex) => {
                const direction = (currentSort.column === columnIndex && currentSort.direction === 'asc') ? 'desc' : 'asc';
                const headers = [ 'cognome', 'nome', 'sesso', 'nascita', 'gen', 'eta'];
                const key = headers[columnIndex];
                
                const sortedData = [...familyData].sort((a, b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                currentSort = { column: columnIndex, direction };
                populateTable(sortedData);
                 
                document.querySelectorAll('#dati thead th').forEach((th, i) => {
                    th.textContent = th.textContent.replace(/[‚Üë‚Üì]/g, '').trim();
                    if(i === columnIndex) {
                         th.textContent += ` ${direction === 'asc' ? '‚Üë' : '‚Üì'}`;
                    } else {
                        th.textContent += ` ‚Üì`;
                    }
                });
            };

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = familyData.filter(p => 
                    p.nome.toLowerCase().includes(searchTerm) ||
                    p.cognome.toLowerCase().includes(searchTerm) ||
                    p.nascita.startsWith(searchTerm)
                );
                populateTable(filteredData);
            });

            // Navigation for smooth scrolling
            document.querySelectorAll('.nav-anchor').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // Exit and Print buttons
            document.getElementById('exit-btn').addEventListener('click', (e) => {
                e.preventDefault();
                window.close();
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 100);
            });

            document.getElementById('print-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                await generatePdf();
            });

            const generatePdf = async () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                const margin = 40;
                const docWidth = pdf.internal.pageSize.getWidth();
                const docHeight = pdf.internal.pageSize.getHeight();
                let yPos = margin;

                const addTitle = (title, y) => {
                    pdf.setFontSize(18);
                    pdf.setTextColor('#9A3B3B');
                    pdf.text(title, docWidth / 2, y, { align: 'center' });
                    return y + 30;
                }
                
                const addSubTitle = (title, y) => {
                     if (y + 20 > docHeight - margin) {
                        pdf.addPage();
                        y = margin;
                    }
                    pdf.setFontSize(14);
                    pdf.setTextColor('#402E32');
                    pdf.text(title, margin, y);
                    return y + 20;
                }

                const addChart = (canvasId, x, y, width) => {
                    const chart = window.chartInstances[canvasId];
                    if (!chart || chart.width === 0 || chart.height === 0) {
                        console.error(`Grafico non valido: ${canvasId}`);
                        return { width: 0, height: 0, y: y };
                    }
                    
                    // Forza il ridisegno del grafico con sfondo bianco
                    const originalBg = chart.canvas.style.backgroundColor;
                    chart.canvas.style.backgroundColor = '#FFFFFF';
                    chart.update('none');
                    
                    const imgData = chart.toBase64Image('image/png', 1.0);
                    
                    // Ripristina lo sfondo originale
                    chart.canvas.style.backgroundColor = originalBg;
                    
                    const imgWidth = width;
                    const imgHeight = chart.height * imgWidth / chart.width;
                    if (y + imgHeight > docHeight - margin) {
                        pdf.addPage();
                        y = margin;
                    }
                    pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                    return { width: imgWidth, height: imgHeight, y: y };
                }
                
                // === PAGE 1 ===
                yPos = addTitle('Report Dashboard Famiglia Pricci', yPos);
                pdf.autoTable({
                    theme: 'striped', 
                    styles: { cellPadding: 8, font: 'helvetica' },
                    body: [
                        [{ content: 'Membri Totali:', styles: { fontStyle: 'bold' } }, document.getElementById('total-members').textContent],
                        [{ content: 'Et√† Media:', styles: { fontStyle: 'bold' } }, document.getElementById('avg-age').textContent + ' Anni'],
                        [{ content: 'Arco Temporale:', styles: { fontStyle: 'bold' } }, document.getElementById('time-span').textContent + ' Anni'],
                        [{ content: 'Anno Nascita Mediano:', styles: { fontStyle: 'bold' } }, document.getElementById('median-birth-year').textContent],
                    ],
                    startY: yPos
                });
                yPos = pdf.previousAutoTable.finalY + 20;

                const halfWidth = (docWidth - margin * 2 - 20) / 2;
                const genderDim = addChart('gender-chart', margin, yPos, halfWidth);
                const genPieDim = addChart('generation-pie-chart', margin + halfWidth + 20, yPos, halfWidth);
                yPos += Math.max(genderDim.height, genPieDim.height) + 20;
                
                yPos = addSubTitle('Calendario Sociale: Gli Onomastici', yPos);
                yPos = addChart('onomastici-chart', margin, yPos, docWidth - margin*2).height + yPos + 20;

                // === PAGE 2 ===
                pdf.addPage();
                yPos = margin;
                yPos = addTitle('Analisi Dettagliata', yPos);
                
                yPos = addSubTitle('Generazioni e Genitorialit√†', yPos);
                const genBarDim = addChart('generation-bar-chart', margin, yPos, halfWidth);
                const parentAgeDim = addChart('parenting-age-chart', margin + halfWidth + 20, yPos, halfWidth);
                yPos += Math.max(genBarDim.height, parentAgeDim.height) + 20;
                
                const marriageAgeDim = addChart('marriage-age-chart', margin, yPos, halfWidth);
                yPos = addSubTitle('Dettaglio Unioni', marriageAgeDim.y + marriageAgeDim.height + 20);
                pdf.autoTable({ 
                    html: '#marriage-table', 
                    startY: yPos, 
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [154, 59, 59] }
                });
                yPos = pdf.previousAutoTable.finalY + 20;

                // === PAGE 3 ===
                pdf.addPage();
                yPos = margin;
                yPos = addTitle('Natalit√† e Dati Anagrafici', yPos);
                
                // Posiziono i sottotitoli sopra i rispettivi grafici
                const leftSubtitleY = yPos;
                const rightSubtitleY = yPos;
                
                // Aggiungo sottotitolo sinistro
                pdf.setFontSize(14);
                pdf.setTextColor('#402E32');
                pdf.text('Distribuzione Mensile Nascite', margin, leftSubtitleY);
                
                // Aggiungo sottotitolo destro
                pdf.text('Numero Figli per Coppia', margin + halfWidth + 20, rightSubtitleY);
                
                // I grafici iniziano alla stessa altezza sotto i sottotitoli
                const chartsY = leftSubtitleY + 20;
                const birthMonthDim = addChart('birth-month-chart', margin, chartsY, halfWidth);
                const childrenDim = addChart('children-per-couple-chart', margin + halfWidth + 20, chartsY, halfWidth);
                
                yPos = Math.max(birthMonthDim.y + birthMonthDim.height, childrenDim.y + childrenDim.height) + 20;
                
                yPos = addSubTitle('Elenco Completo Membri Famiglia', yPos);
                pdf.autoTable({
                    html: '#full-data-table',
                    startY: yPos,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: {fillColor: [154, 59, 59]}
                });

                pdf.autoPrint();
                window.open(pdf.output('bloburl'), '_blank');
            }
            
            populateTable(familyData);
            sortTable(0);
        });
    </script>
</body>
</html>