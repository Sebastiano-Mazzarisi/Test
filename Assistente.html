<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente Virtuale</title>
    <script>
        async function fetchCSV() {
            const url = 'https://sebastiano-mazzarisi.github.io/Test/Assistente.csv';
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                const rows = csvText.split('\n').slice(1).map(row => row.split(','));
                return rows;
            } catch (error) {
                console.error('Errore nel caricamento del CSV:', error);
                return [];
            }
        }

        function getDayOfWeek(dateStr) {
            const [day, month, year] = dateStr.split('/').map(Number);
            const date = new Date(year, month - 1, day);
            const daysOfWeek = ['domenica', 'lunedì', 'martedì', 'mercoledì', 'giovedì', 'venerdì', 'sabato'];
            return daysOfWeek[date.getDay()];
        }

        function getMonthName(month) {
            const months = [
                'gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
                'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'
            ];
            return months[month - 1];
        }

        function calculateYears(dateStr) {
            const [day, month, year] = dateStr.split('/').map(Number);
            const today = new Date();
            let age = today.getFullYear() - year;
            if (today.getMonth() + 1 < month || (today.getMonth() + 1 === month && today.getDate() < day)) {
                age--;
            }
            return age;
        }

async function search(partialName) {
    const rows = await fetchCSV();
    const matches = [];
    const nameParts = partialName.toLowerCase().split(' ');

    for (const row of rows) {
        const name = row[0]?.trim().toLowerCase();
        if (nameParts.every(part => name?.includes(part))) {
            matches.push({
                Nome: row[0]?.trim(),
                Sesso: row[1]?.trim(),
                Nascita: row[2]?.trim(),
                Onomastico: row[3]?.trim(),
                Matrimonio: row[4]?.trim(),
                Coniuge: row[5]?.trim()
            });
        }
    }

    if (matches.length === 0) {
        return 'Nessuna corrispondenza trovata.';
    } else if (matches.length === 1) {
        const person = matches[0];
        let response = `${person.Nome}. `;

        if (person.Nascita) {
            const [day, month, year] = person.Nascita.split('/').map(Number);
            const age = calculateYears(person.Nascita);
            response += `${person.Nome} è ${person.Sesso === 'M' ? 'nato' : 'nata'} il ${day}/${month}/${year}. Ha ${age} anni. `;
        }

        if (person.Onomastico) {
            const [day, month] = person.Onomastico.split('/').map(Number);
            response += `L'onomastico è il ${day}/${month}. `;
        }

        if (person.Matrimonio) {
            const [day, month, year] = person.Matrimonio.split('/').map(Number);
            response += `Si è sposato il ${day}/${month}/${year}. `;
            if (person.Coniuge) {
                response += `Il coniuge si chiama ${person.Coniuge}. `;
            }
        }

        return response.trim();
    } else {
        const names = matches.map(match => match.Nome);
        const namesFormatted = names.join(', ');
        return `Trovate ${matches.length} corrispondenze: ${namesFormatted}. Specifica meglio il nome.`;
    }
}

async function handleInteraction() {
    let nome;
    do {
        // Chiedi il nome
        nome = prompt('Inserisci il nome da cercare (scrivi "basta" per uscire):');

        if (nome && nome.toLowerCase() === "basta") {
            // Saluta e termina la procedura
            const speech = new SpeechSynthesisUtterance("Arrivederci! Alla prossima.");
            speech.lang = 'it-IT';
            window.speechSynthesis.speak(speech);
            alert("Arrivederci! Alla prossima.");
            break;
        }

        if (nome) {
            // Cerca nel database
            const result = await search(nome);
            const speech = new SpeechSynthesisUtterance(result);
            speech.lang = 'it-IT';
            window.speechSynthesis.speak(speech);
            alert(result);
        } else {
            // Se nessun nome è fornito
            alert("Nessun nome fornito. Riprova.");
        }
    } while (true);
}



        window.onload = handleInteraction;
    </script>
</head>
<body>
</body>
</html>
