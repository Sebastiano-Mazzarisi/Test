<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Contatori visite per agenzia</title>

<!-- Meta / icone come in Vendesi.html per "Aggiungi a Home" -->
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
<link rel="shortcut icon" href="./favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<link rel="manifest" href="./site.webmanifest">
<link rel="icon" sizes="192x192" href="./android-chrome-192x192.png">
<link rel="icon" sizes="512x512" href="./android-chrome-512x512.png">
<meta name="theme-color" content="#2563eb">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Via Fanelli - Contatori">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  :root{ --ink:#0f172a; --muted:#475569; --bg:#e9edf5; --blue:#2563eb; --fs:20px; --rad:10px; }
  html, body { height:100%; }
  * { min-width:0; box-sizing:border-box; }
  body{
    margin:0; padding:0 4px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
    font-size:var(--fs); line-height:1.25; color:var(--ink); background:var(--bg);
    overflow:hidden;
  }
  header{ padding:8px; background:var(--blue); color:#fff; text-align:center; border-radius:var(--rad); margin:4px auto 6px; }
  h1{ margin:2px 0; font-size:clamp(1.4rem,6vw,1.8rem); font-weight:700; }
  .hdr-sub{ margin:0; opacity:.95; font-size:1.1rem; }
  main{ height:calc(100% - 96px); display:flex; flex-direction:column; gap:6px; }

  /* bottone centrato */
  .refresh-section{ display:flex; justify-content:center; align-items:center; }
  button{ font:inherit; padding:10px 20px; border:1px solid #1e4fd1; border-radius:var(--rad);
          background:var(--blue); color:#fff; cursor:pointer; font-size:1.2rem; font-weight:600; }

  .box{ background:#fff; border:1px solid #e5e7eb; border-radius:var(--rad); padding:8px; box-shadow:0 1px 0 rgba(0,0,0,.03); }

  /* tabella + riquadri per riga */
  table{ width:100%; table-layout:fixed; border-collapse:separate; border-spacing:0 8px; font-size:1.2rem; }
  thead th{ padding:8px 10px; background:#f3f4f6; font-weight:600; font-size:1.1rem; position:sticky; top:0; z-index:1; }
  tbody td{ padding:10px; background:#fff; }
  /* bordo grigio per ogni riga (riquadro) */
  tbody td{ border-top:1px solid #d1d5db; border-bottom:1px solid #d1d5db; }
  tbody td:first-child{ border-left:1px solid #d1d5db; border-right:none; border-radius:10px 0 0 10px; }
  tbody td:last-child { border-right:1px solid #d1d5db; border-left:none; border-radius:0 10px 10px 0; }

  /* larghezze colonne */
  thead th:first-child, tbody td:first-child { width:calc(100% - 100px); }
  thead th:nth-child(2), tbody td:nth-child(2) { width:100px; text-align:right; white-space:nowrap; }

  /* descrizione: un po' più piccola del th; solo codice in bold e link */
  td .ag-descr{ font-size:1.0rem; font-weight:400; }
  td .ag-descr .ag-code{ font-weight:700; text-decoration:none; color:inherit; }
  td .ag-descr .ag-rest{ font-weight:400; }

  tfoot td{ padding:10px 12px; border-top:2px solid #d1d5db; text-align:center; font-weight:700; background:#fff; border-radius:10px; }
  .foot-mini{ color:var(--muted); font-size:1.05rem; text-align:center; margin:6px 0 2px; }
  .foot-link{ text-align:center; margin:2px 0 8px; }
  .foot-link a{ color:#2563eb; text-decoration:underline; font-size:1.05rem; }

  @media(max-width:320px){
    td .ag-descr{ font-size:.95rem; }
    thead th:first-child, tbody td:first-child { width:calc(100% - 100px); }
  }
</style>
</head>
<body>
<header>
  <h1>Contatori visite per agenzia</h1>
  <p class="hdr-sub">Mostra i valori globali letti, non incrementa nulla</p>
</header>

<main>
  <div class="refresh-section">
    <button id="refresh">Aggiorna</button>
  </div>

  <div class="box">
    <table id="tbl">
      <thead>
        <tr><th>Agenzia</th><th>Visite</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="2"><strong>Totale complessivo: <span id="totalValue">—</span></strong></td></tr>
      </tfoot>
    </table>
  </div>

  <p class="foot-mini">(?ag=Agenzia) Sito agenzia · (?nohit=1) Non incrementa</p>
  <p class="foot-link"><a href="https://tinyurl.com/Via-Fanelli" target="_blank" rel="noopener">https://tinyurl.com/Via-Fanelli</a></p>
</main>

<script>
const AGENZIE_CSV = "https://sebastiano-mazzarisi.github.io/Test/Agenzie.csv";

/* backends in fallback */
const backends = [
  { get: (ns,key)=>`https://countapi.mileshilliard.com/api/v1/get/${ns}_${key}`, map:j=>Number(j.value??j.count) },
  { get: (ns,key)=>`https://countapi.store/get/${encodeURIComponent(key)}/visite`, map:j=>Number(j.value) },
  { get: (ns,key)=>`https://api.countapi.xyz/get/${encodeURIComponent(ns)}/${encodeURIComponent(key)}`, map:j=>Number(j.value) }
];
const fetchJSON = (u,ms=3000)=>{const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);
 return fetch(u,{signal:c.signal,cache:'no-store'}).then(r=>{clearTimeout(t);if(!r.ok)throw new Error();return r.json();});};

function parseCSV(text){
  const clean=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim();
  const lines=clean.split('\n').filter(Boolean); if(!lines.length) return [];
  const first=lines[0];
  const delim=((first.match(/,/g)||[]).length>(first.match(/;/g)||[]).length)?',':';';
  const rows=[];
  for(const line of lines){
    const out=[]; let cur='',q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch=='"'){ if(q&&line[i+1]=='"'){cur+='"';i++;} else q=!q; }
      else if(ch==delim && !q){ out.push(cur.trim()); cur=''; }
      else cur+=ch;
    }
    out.push(cur.trim()); rows.push(out);
  }
  return rows;
}

async function loadAgenzie(){
  const r=await fetch(AGENZIE_CSV,{cache:'no-store'}); if(!r.ok) throw new Error('CSV HTTP '+r.status);
  const rows=parseCSV(await r.text()); if(!rows.length) throw new Error('CSV vuoto');
  const head=rows[0].map(s=>s.trim().toLowerCase());
  const idx=(...names)=>{for(const n of names){const i=head.findIndex(h=>h===n.toLowerCase()); if(i>=0) return i;} return -1;};
  const iCod=idx('codice'), iNom=idx('nome agenzia','nome'),
        iInd=idx('via e numero','indirizzo'),
        iCit=idx('città (provincia)','citta (provincia)','città','citta'),
        iTel=idx('telefono','cellulare','tel'),
        iLink=idx('link','url','short','shortlink');

  const out=rows.slice(1).map(c=>({
    codice:(c[iCod]??'').trim(),
    nome:(c[iNom]??'').trim(),
    indirizzo:(c[iInd]??'').trim(),
    cittaProv:(c[iCit]??'').trim(),
    telefono:(c[iTel]??'').trim(),
    link:(c[iLink]??'').trim()
  })).filter(a=>a.codice);

  // ordine alfabetico per codice
  out.sort((a,b)=>a.codice.localeCompare(b.codice,'it',{sensitivity:'base'}));
  return out;
}

async function getCount(ns,key){
  for(const b of backends){
    try{ const data=await fetchJSON(b.get(ns,key)); const v=b.map(data); if(Number.isFinite(v)) return v; }catch{}
  }
  return null;
}

function h(tag,attrs,...kids){
  const el=document.createElement(tag);
  if(attrs) for(const[k,v] of Object.entries(attrs)){ if(k==='class') el.className=v; else el.setAttribute(k,v); }
  for(const k of kids) el.append(k);
  return el;
}

async function refresh(){
  const ns='socim', prefix='vendesi-';
  const ags=await loadAgenzie();
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML="";
  let total=0, ok=0;

  for(const ag of ags){
    const key=`${prefix}${ag.codice.trim().toUpperCase()}`;
    const parts=[ag.nome, ag.indirizzo, ag.cittaProv, ag.telefono ? `Tel ${ag.telefono}` : ""]
      .filter(Boolean).join(' - ');

    const cell=h('td',null);
    const span=h('span',{class:'ag-descr'});
    const href=(ag.link&&/^https?:\/\//i.test(ag.link)) ? ag.link : '#';
    const anchor=h('a',{class:'ag-code', href, target:'_blank', rel:'noopener'}, ag.codice);
    span.append(anchor, ': ', h('span',{class:'ag-rest'}, parts));
    cell.append(span);

    const row=h('tr',null, cell, h('td',null, '—'));
    tb.append(row);

    const v=await getCount(ns,key);
    if(v!=null){ row.children[1].textContent=v; total+=v; ok++; }
  }
  document.getElementById('totalValue').textContent = ok ? total : '—';
}

document.getElementById('refresh').addEventListener('click', refresh);
document.addEventListener('DOMContentLoaded', refresh);
</script>
</body>
</html>
