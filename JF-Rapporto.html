<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JF Report Manager</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f2f2f7; 
            padding: 15px; 
            /* Forza larghezza smartphone anche su PC */
            max-width: 400px; 
            margin: 0 auto; 
            color: #1c1c1e; 
        }
        h1 { text-align: center; color: #000; font-size: 1.5rem; margin-bottom: 20px; }
        
        .card { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 15px; 
        }
        
        label { display: block; margin-top: 10px; margin-bottom: 4px; font-weight: 600; font-size: 0.95rem; color: #3a3a3c; }
        
        /* Input impilati verticalmente */
        input[type="text"], input[type="date"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px; /* Spazio tra i campi */
            border: 1px solid #d1d1d6; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px; /* Evita zoom su iOS */
            background-color: #f9f9f9;
        }
        
        /* Checkbox */
        .checkbox-wrapper { display: flex; align-items: center; margin-bottom: 10px; }
        input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; accent-color: #007aff; }
        
        /* Bottoni */
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 10px; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
        }
        
        .btn-cerca { background-color: #007aff; } /* iOS Blue */
        .btn-pdf { background-color: #ff3b30; }   /* iOS Red */

        /* Radio Buttons */
        .radio-group { margin-top: 5px; display: flex; flex-direction: column; gap: 8px; }
        .radio-group label { font-weight: normal; display: flex; align-items: center; margin: 0; }
        .radio-group input { margin-right: 10px; transform: scale(1.2); accent-color: #007aff; }

        /* Riquadro Totali */
        .summary-box { 
            background-color: #eef9ff; border: 1px solid #bce0fd; 
            padding: 15px; border-radius: 10px; margin: 20px 0;
            text-align: center;
        }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; border-bottom: 1px solid #daeefc; padding-bottom: 4px; }
        .summary-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .summary-row strong { color: #007aff; }
        .summary-row span { font-weight: bold; }

        /* Tabella Risultati */
        .table-container { 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid #d1d1d6;
            background: white;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e5ea; font-size: 0.9rem; }
        th { background-color: #f2f2f7; font-weight: 600; color: #636366; }
        td.num { text-align: right; font-weight: bold; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }

        .status { text-align: center; margin-top: 15px; font-weight: bold; font-size: 0.9rem; min-height: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>üñ®Ô∏è JF Report</h1>

    <div class="card">
        <label>üìÖ Periodo</label>
        <div class="checkbox-wrapper">
            <input type="checkbox" id="chk_tutto" checked onchange="toggleDates()">
            <span style="font-size: 1rem;">Tutto il periodo</span>
        </div>
        
        <label>Da:</label>
        <input type="date" id="date_start" disabled>
        
        <label>A:</label>
        <input type="date" id="date_end" disabled>
    </div>

    <div class="card">
        <label>üìÑ Formato Stampa (Solo PDF)</label>
        <div class="radio-group">
            <label><input type="radio" name="formato" value="SINT" checked> Sintetico (3 Colonne)</label>
            <label><input type="radio" name="formato" value="STD"> Standard</label>
        </div>
    </div>

    <div class="card">
        <label>üîç Cerca Nominativo</label>
        <label style="font-weight:normal; font-size:0.8em; margin-top:0;">Contiene:</label>
        <input type="text" id="filter_inc" placeholder="es. giulia">
        
        <label style="font-weight:normal; font-size:0.8em; margin-top:0;">NON contiene:</label>
        <input type="text" id="filter_exc" placeholder="es. rossi">
    </div>

    <div class="btn-group">
        <button class="btn-cerca" onclick="avviaProcesso('CERCA')">üîç CERCA</button>
        <button class="btn-pdf" onclick="avviaProcesso('PDF')">‚¨áÔ∏è SCARICA PDF</button>
    </div>
    
    <div class="status" id="statusMsg"></div>

    <div id="resultsArea" class="hidden">
        
        <div class="summary-box">
            <div class="summary-row"><strong>Totale</strong><span id="sumTot">0 ‚Ç¨</span></div>
            <div class="summary-row"><strong>Contanti</strong><span id="sumCont">0 ‚Ç¨</span></div>
            <div class="summary-row"><strong>Pos</strong><span id="sumPos">0 ‚Ç¨</span></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 25%">Data</th>
                        <th>Nominativo</th>
                        <th style="text-align:right">Totale</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div style="height: 30px;"></div> </div>

<script>
    const CSV_FILENAME = 'JF-DB.csv';

    function toggleDates() {
        const isAll = document.getElementById('chk_tutto').checked;
        document.getElementById('date_start').disabled = isAll;
        document.getElementById('date_end').disabled = isAll;
    }

    function formatEuro(n) {
        return n.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 2}) + " ‚Ç¨";
    }

    async function avviaProcesso(azione) {
        const status = document.getElementById('statusMsg');
        const resultsArea = document.getElementById('resultsArea');
        
        status.textContent = "Elaborazione...";
        status.style.color = "#007aff";
        
        if(azione === 'CERCA') resultsArea.classList.add('hidden');

        try {
            const response = await fetch(CSV_FILENAME);
            if (!response.ok) throw new Error("File CSV non trovato.");
            const csvText = await response.text();
            const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            let data = parsed.data;

            // Pulizia
            data.forEach(row => {
                if (row.Data) {
                    const parts = row.Data.split('/');
                    if (parts.length === 3) row.dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                }
                ['Contanti', 'Pos', 'Uscite'].forEach(k => {
                    let val = row[k] ? row[k].toString().replace(/\./g, '').replace(',', '.') : "0";
                    row[k] = parseFloat(val) || 0;
                });
                if (!row.Nominativo) row.Nominativo = "";
                let n = row.Nominativo.trim().toLowerCase();
                if (n === 'marica') row.Nominativo = "Pricci Marica";
                if (n === 'checco') row.Nominativo = "Di Stasio Checco";
            });

            data = data.filter(r => r.dateObj && !isNaN(r.dateObj));

            // Filtri
            if (!document.getElementById('chk_tutto').checked) {
                const sVal = document.getElementById('date_start').value;
                const eVal = document.getElementById('date_end').value;
                if (sVal && eVal) {
                    const s = new Date(sVal);
                    const e = new Date(eVal);
                    data = data.filter(r => r.dateObj >= s && r.dateObj <= e);
                }
            }

            const inc = document.getElementById('filter_inc').value.toLowerCase().trim();
            const exc = document.getElementById('filter_exc').value.toLowerCase().trim();
            
            if (inc) inc.split(' ').forEach(t => { if(t) data = data.filter(r => r.Nominativo.toLowerCase().includes(t)); });
            if (exc) exc.split(' ').forEach(t => { if(t) data = data.filter(r => !r.Nominativo.toLowerCase().includes(t)); });

            if (data.length === 0) {
                status.textContent = "Nessun dato trovato.";
                status.style.color = "#ff3b30";
                return;
            }

            data.sort((a, b) => (a.dateObj - b.dateObj) || a.Nominativo.localeCompare(b.Nominativo));

            if (azione === 'CERCA') {
                renderTable(data);
                status.textContent = `Risultati: ${data.length}`;
                status.style.color = "#34c759";
            } else {
                generatePDF(data);
                status.textContent = "PDF Pronto!";
                status.style.color = "#34c759";
            }

        } catch (err) {
            console.error(err);
            status.textContent = "Errore: " + err.message;
            status.style.color = "red";
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        
        let tC = 0, tP = 0;

        data.forEach(r => {
            const totRow = r.Contanti + r.Pos;
            if (totRow === 0 && r.Uscite === 0) return;

            tC += r.Contanti;
            tP += r.Pos;

            const tr = document.createElement('tr');
            // Formato Data breve per mobile: GG/MM
            const dShort = r.dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
            
            tr.innerHTML = `
                <td>${dShort}</td>
                <td>${r.Nominativo}</td>
                <td class="num" style="color:#007aff">${formatEuro(totRow)}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('sumTot').textContent = formatEuro(tC + tP);
        document.getElementById('sumCont').textContent = formatEuro(tC);
        document.getElementById('sumPos').textContent = formatEuro(tP);
        
        document.getElementById('resultsArea').classList.remove('hidden');
        // Scroll automatico ai risultati
        document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
    }

    function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const isSint = document.querySelector('input[name="formato"]:checked').value === "SINT";

        let y = 15;
        let grandTotC = 0, grandTotP = 0, grandTotU = 0;

        const groups = {};
        data.forEach(r => {
            const k = r.dateObj.getTime();
            if (!groups[k]) groups[k] = [];
            groups[k].push(r);
        });

        Object.keys(groups).sort().forEach(key => {
            const group = groups[key];
            group.sort((a,b) => a.Nominativo.localeCompare(b.Nominativo));

            let tc = 0, tp = 0, tu = 0;
            const income = [], expense = [];

            group.forEach(r => {
                if (r.Uscite > 0) expense.push(r);
                else income.push(r);
                tc += r.Contanti; tp += r.Pos; tu += r.Uscite;
            });

            if ((tc + tp) === 0 && tu === 0) return;

            grandTotC += tc; grandTotP += tp; grandTotU += tu;

            const dObj = group[0].dateObj;
            const wdFull = dObj.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const wdShort = dObj.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
            const headerTot = formatEuro(tc + tp);

            if (y > 270) { doc.addPage(); y = 15; }

            if (isSint) {
                doc.setFillColor(230, 230, 230); doc.setDrawColor(0); doc.rect(14, y, 182, 7, 'FD');
                doc.setFont("helvetica", "normal"); doc.setFontSize(10);
                doc.text(`${wdShort} - Totale: ${headerTot}`, 105, y + 5, { align: "center" });
                y += 7;

                const body = [];
                income.forEach(r => body.push([r.Nominativo, formatEuro(r.Contanti), formatEuro(r.Pos)]));
                expense.forEach(r => body.push([`${r.Nominativo} (${formatEuro(r.Uscite)})`, "", ""]));

                doc.autoTable({
                    startY: y, body: body, theme: 'grid', showHead: 'firstPage',
                    styles: { fontSize: 8, cellPadding: 1, lineColor: 0, lineWidth: 0.1 },
                    columnStyles: { 0: { cellWidth: 'auto' }, 1: { cellWidth: 20, halign: 'right' }, 2: { cellWidth: 20, halign: 'right' } }
                });
                y = doc.lastAutoTable.finalY + 3;
            } else {
                doc.setFillColor(230, 230, 230); doc.rect(14, y, 182, 8, 'FD');
                doc.setFontSize(11);
                doc.text(`${wdFull} - Totale ${headerTot}`, 105, y + 5.5, { align: "center" });
                y += 8;

                const head = [["Nominativo", "Attivit√†", "Abbonamento", "Contanti", "Pos", "Uscite", "Operatore", "X", "Reg"]];
                const body = [];
                [...income, ...expense].forEach(r => {
                    body.push([r.Nominativo, r.Attivit√†, r.Abbonamento, formatEuro(r.Contanti), formatEuro(r.Pos), formatEuro(r.Uscite), r.Operatore, r.CassaX, r.Registrato]);
                });
                body.push(["TOTALI", "", "", formatEuro(tc), formatEuro(tp), formatEuro(tu), "", "", ""]);

                doc.autoTable({
                    startY: y, head: head, body: body, theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1, lineColor: 0 },
                    headStyles: { fillColor: 255, textColor: 0, fontStyle: 'normal', lineWidth: 0.1 },
                    columnStyles: { 3: {halign:'right'}, 4: {halign:'right'}, 5: {halign:'right'} },
                    didParseCell: function(data) { if (data.row.index === body.length - 1) data.cell.styles.fontStyle = 'bold'; }
                });
                y = doc.lastAutoTable.finalY + 10;
            }
        });

        if (y > 250) { doc.addPage(); y = 20; } else { y += 10; }
        doc.setFont("helvetica", "normal"); doc.setFontSize(11);
        const rX = 190;
        doc.text(`TOTALE: ${formatEuro(grandTotC + grandTotP)}`, rX, y, { align: "right" }); y += 6;
        doc.text(`Contanti: ${formatEuro(grandTotC)}`, rX, y, { align: "right" }); y += 6;
        doc.text(`Pos: ${formatEuro(grandTotP)}`, rX, y, { align: "right" }); y += 10;
        doc.text(`Uscite: ${formatEuro(grandTotU)}`, rX, y, { align: "right" });

        doc.save("JF-Stampa.pdf");
    }
</script>

</body>
</html>