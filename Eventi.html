<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
    <title>Prossimi eventi</title>

    <!-- Azure Speech SDK -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <!-- Confetti per effetti visivi -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f0f0f0;
        }

        /* Header and controls */
        h1 {
            color: #444;
            text-align: center;
            margin-bottom: 5px;
            font-size: 2.5em;
            cursor: pointer;
        }

        #oggi {
            text-align: center;
            color: #666;
            font-size: 1em;
            margin-bottom: 30px;
        }

        /* Data controls */
        .pulsanti-data {
            text-align: center;
            margin-bottom: 10px;
        }

        .pulsanti-data button {
            margin: 0 5px;
            padding: 5px 10px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none !important;
        }

        /* Eventi list */
        #eventi-lista {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #000;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1.6;
        }

        /* Event types */
        .compleanno {
            background-color: #e6f3ff;
        }

        .onomastico {
            background-color: #e6ffe6;
        }

        .anniversario {
            background-color: #fff0f0;
        }

        .compleanno strong { color: #00008B; }
        .onomastico strong { color: #006400; }
        .anniversario strong { color: #8B0000; }

        /* Images */
        .image-container img {
            height: 300px;
            width: auto;
            border: 4px solid #B4A28C;
            background: white;
            margin: 10px auto;
            display: block;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .image-container img:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        /* Error messages */
        .error-message {
            color: red;
            font-size: 0.9em;
        }

        /* Confetti canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <h1 id="titolo">Prossimi eventi</h1>
    <div class="pulsanti-data">
        <button id="cambia-data">Cambia data</button>
        <button id="reset-data">Torna alla data reale</button>
    </div>
    <div id="oggi"></div>
    <canvas id="confetti-canvas"></canvas>
    <ul id="eventi-lista"></ul>

    <script>
        // Configurazione Azure
        const AZURE_CONFIG = {
            key: "GXmSkX5oMKs4N7KNBUghseLTkbMIOsVuwlgVhFbqFVwiwjy77p7VJQQJ99BAAC5RqLJXJ3w3AAAYACOGN9Hv",
            region: "westeurope",
            language: "it-IT",
            voices: {
                female: "it-IT-ElsaNeural",
                male: "it-IT-GiuseppeNeural"
            }
        };

        // Stato dell'applicazione
        const appState = {
            dataSimulata: null,
            nomiAnniversari: new Map(),
            descrizioni: new Map(),
            speechSynthesizer: null
        };

        // Costanti
        const GIORNI_SETTIMANA = ["domenica", "lunedì", "martedì", "mercoledì", "giovedì", "venerdì", "sabato"];
        const MESI = ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno",
                     "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"];

        // Utility functions
        function getDataCorrente() {
            return appState.dataSimulata || new Date();
        }

        function parseDataMMGG(data) {
            const [giorno, mese] = data.split("/").map(Number);
            return new Date(2000, mese - 1, giorno);
        }

        function calcolaGiorniMancanti(dataEvento, oggiMMGG) {
            const diff = dataEvento - oggiMMGG;
            return diff >= 0
                ? Math.ceil(diff / (1000 * 60 * 60 * 24))
                : Math.ceil((diff + 365 * 24 * 60 * 60 * 1000) / (1000 * 60 * 60 * 24));
        }

        // Gestione età e date
        function calcolaEta(evento) {
            if (evento.Tipo !== "Compleanno" && evento.Tipo !== "Anniversario") return null;

            let annoNascita = parseInt(evento.Anno);
            if (isNaN(annoNascita)) {
                const parti = evento.Data.split("/");
                if (parti.length === 3) {
                    const maybeYear = parseInt(parti[2]);
                    if (!isNaN(maybeYear)) {
                        annoNascita = maybeYear;
                    }
                }
            }
            if (isNaN(annoNascita)) return null;

            const oggi = getDataCorrente();
            const annoCorrente = oggi.getFullYear();
            const [gg, mm] = evento.Data.split("/").map(Number);
            const dataEventoQuestAnno = new Date(annoCorrente, mm - 1, gg);

            let anni = annoCorrente - annoNascita;
            if (oggi > dataEventoQuestAnno) {
                anni++;
            }
            return anni;
        }

        // Gestione immagini e link
        function correggiLink(link) {
            if (!link) return null;
            
            if (link.includes("drive.google.com")) {
                const fileIdMatch = link.match(/\bid=([^&]+)/);
                if (fileIdMatch) {
                    return `https://drive.google.com/uc?id=${fileIdMatch[1]}`;
                }
                const fileIdPath = link.match(/\/d\/(.*?)\//);
                if (fileIdPath) {
                    return `https://drive.google.com/uc?id=${fileIdPath[1]}`;
                }
            }
            
            if (link.includes("drive.usercontent.google.com")) {
                return link;
            }
            
            return link.startsWith('http') ? link : link;
        }

        // Speech Manager Class
        class SpeechManager {
            constructor() {
                this.speechConfig = null;
                this.synthesizer = null;
                this.initialize();
            }

            initialize() {
                this.speechConfig = new SpeechSDK.SpeechConfig(
                    AZURE_CONFIG.key, 
                    AZURE_CONFIG.region
                );
                this.speechConfig.speechSynthesisLanguage = AZURE_CONFIG.language;
                
                this.synthesizer = new SpeechSDK.SpeechSynthesizer(
                    this.speechConfig, 
                    null
                );
            }

            async speakText(text, voiceType = 'female', rate = '1.15') {
                const voice = AZURE_CONFIG.voices[voiceType];
                const ssml = `
                    <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="${AZURE_CONFIG.language}">
                        <voice name="${voice}">
                            <prosody rate="${rate}">
                                ${text}
                            </prosody>
                        </voice>
                    </speak>`;

                try {
                    const result = await this.synthesizer.speakSsmlAsync(ssml);
                    
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        return true;
                    } else {
                        console.error("Synthesis failed:", result.errorDetails);
                        return false;
                    }
                } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                return [];
            }
        }

        async function caricaNomiAnniversari() {
            const rows = await caricaCSV('https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/refs/heads/main/Eventi-Nozze.csv');
            rows.forEach(([anno, nome]) => {
                if (anno && nome) {
                    appState.nomiAnniversari.set(anno.trim(), nome.trim());
                }
            });
        }

        async function caricaDescrizioni() {
            const rows = await caricaCSV('https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/refs/heads/main/EventiDescrizioni.csv');
            rows.forEach(row => {
                if (row.length >= 2) {
                    const speechManager = new SpeechManager();
                    const nominativo = speechManager.normalizzaNominativo(row[0]);
                    const descrizione = row[1];
                    appState.descrizioni.set(nominativo, descrizione);
                }
            });
        }

        async function caricaEventi() {
            const eventiRaw = await caricaCSV('https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/refs/heads/main/Eventi-Link.csv');
            const [headers, ...rows] = eventiRaw;
            
            const eventi = rows.map(row => {
                const evento = {};
                headers.forEach((header, index) => {
                    evento[header.trim()] = row[index]?.trim();
                });
                return evento;
            });

            return ordinaEventi(eventi);
        }

        // Gestione UI
        function aggiornaDataOggi() {
            const oggi = getDataCorrente();
            const dataOggi = `${GIORNI_SETTIMANA[oggi.getDay()]} ${oggi.getDate()} ${MESI[oggi.getMonth()]} ${oggi.getFullYear()}`;
            document.getElementById('oggi').innerText = `Oggi: ${dataOggi}`;
        }

        function costruisciEventoHtml(evento) {
            const li = document.createElement('li');
            li.classList.add(evento.Tipo.toLowerCase());

            const imgSrc = evento.Link ? correggiLink(evento.Link) : `${evento.Nominativo}.JPG`;

            let tipoEventoText = "";
            if (evento.Tipo === "Compleanno" || evento.Tipo === "Anniversario") {
                if (evento.eta) {
                    let giorniText = evento.giorniMancanti === 0 ? "oggi" :
                                   evento.giorniMancanti === 1 ? "domani" :
                                   `tra ${evento.giorniMancanti} giorni`;
                    tipoEventoText = `${evento.eta}° ${evento.Tipo} ${giorniText}`;
                } else {
                    tipoEventoText = `${evento.Tipo} in ${evento.giorniMancanti} giorni`;
                }
            } else if (evento.Tipo === "Onomastico") {
                tipoEventoText = evento.giorniMancanti === 0 ? "Onomastico oggi" :
                                evento.giorniMancanti === 1 ? "Onomastico domani" :
                                `Onomastico tra ${evento.giorniMancanti} giorni`;
            }

            let nomeAnniversarioHtml = "";
            if (evento.Tipo === "Anniversario" && evento.eta) {
                const nomeAnniversario = appState.nomiAnniversari.get(evento.eta.toString());
                if (nomeAnniversario) {
                    nomeAnniversarioHtml = `${nomeAnniversario}<br>`;
                }
            }

            li.innerHTML = `
                <a href="javascript:void(0)" onclick="mostraAlert('${evento.Nominativo}')" style="text-decoration:none; color: inherit;">
                    <strong>${evento.Nominativo}</strong>
                </a>
                <br>
                <span class="tipo-evento">${tipoEventoText}</span><br>
                ${nomeAnniversarioHtml}
                <div class="image-container">
                    <img
                        src="${imgSrc}"
                        alt="${evento.Tipo} di ${evento.Nominativo}"
                        onerror="this.onerror=null; this.src='default-thumbnail.jpg';"
                    >
                </div>
            `;

            const imgElement = li.querySelector('img');
            imgElement.addEventListener('click', () => {
                if (evento.giorniMancanti === 0) {
                    suonaBeepSingolo();
                    lanciaCoriandoli10s();
                }
                mostraAlert(evento.Nominativo);
            });

            return li;
        }

        // Gestione della data
        function promptData() {
            const dataString = prompt(
                "Inserisci la data nel formato DD/MM/YYYY:",
                appState.dataSimulata
                    ? `${appState.dataSimulata.getDate().toString().padStart(2, '0')}/${(appState.dataSimulata.getMonth() + 1).toString().padStart(2, '0')}/${appState.dataSimulata.getFullYear()}`
                    : new Date().toLocaleDateString('it-IT')
            );
            
            if (dataString === null) return;

            const [giorno, mese, anno] = dataString.split("/").map(num => parseInt(num.trim()));
            if (!giorno || !mese || !anno ||
                giorno < 1 || giorno > 31 ||
                mese < 1 || mese > 12 ||
                anno < 1900 || anno > 2100) {
                alert("Data non valida! Usa il formato DD/MM/YYYY");
                return;
            }

            appState.dataSimulata = new Date(anno, mese - 1, giorno);
            document.getElementById('reset-data').style.display = 'block';

            aggiornaUI();
        }

        function resetData() {
            appState.dataSimulata = null;
            document.getElementById('reset-data').style.display = 'none';
            aggiornaUI();
        }

        // Aggiornamento UI
        async function aggiornaUI() {
            aggiornaDataOggi();
            const eventi = await caricaEventi();
            
            const lista = document.getElementById('eventi-lista');
            lista.innerHTML = '';
            
            eventi.forEach(evento => {
                lista.appendChild(costruisciEventoHtml(evento));
            });
        }

        // Gestione descrizioni e lettura
        async function mostraAlert(nominativo) {
            const speechManager = new SpeechManager();
            await speechManager.leggiTesto(nominativo);
        }

        // Inizializzazione
        async function initApp() {
            try {
                // Carica i dati necessari
                await Promise.all([
                    caricaNomiAnniversari(),
                    caricaDescrizioni()
                ]);

                // Setup event listeners
                document.getElementById('titolo').addEventListener('click', promptData);
                document.addEventListener('keydown', e => {
                    if (e.key === 'F2') {
                        e.preventDefault();
                        promptData();
                    }
                });
                document.getElementById('reset-data')?.addEventListener('click', resetData);

                // Aggiorna UI iniziale
                await aggiornaUI();

            } catch (error) {
                console.error('Errore durante l\'inizializzazione:', error);
                alert('Si è verificato un errore durante il caricamento dell\'applicazione. Riprova più tardi.');
            }
        }

        // Avvio dell'applicazione
        document.addEventListener('DOMContentLoaded', initApp); (error) {
                    console.error("Speech synthesis error:", error);
                    return false;
                }
            }

            dividiTestoInFrammenti(testo, maxLength = 150) {
                const frammenti = [];
                const frasiPunti = testo.split(".")
                    .filter(f => f.trim().length > 0)
                    .map(f => f.trim() + ".");
                
                for (let frase of frasiPunti) {
                    if (frase.length > maxLength) {
                        const parole = frase.split(" ");
                        let frammentoCorrente = "";
                        
                        for (const parola of parole) {
                            if ((frammentoCorrente + " " + parola).length <= maxLength) {
                                frammentoCorrente += (frammentoCorrente ? " " : "") + parola;
                            } else {
                                if (frammentoCorrente) {
                                    frammenti.push(frammentoCorrente.trim() + "...");
                                }
                                frammentoCorrente = parola;
                            }
                        }
                        if (frammentoCorrente) {
                            frammenti.push(frammentoCorrente.trim() + ".");
                        }
                    } else {
                        frammenti.push(frase);
                    }
                }
                
                return frammenti;
            }

            async leggiTesto(nominativo) {
                const nomeNormalizzato = this.normalizzaNominativo(nominativo);
                const descrizione = appState.descrizioni.get(nomeNormalizzato) || nominativo;

                const frammenti = this.dividiTestoInFrammenti(descrizione);
                for (let i = 0; i < frammenti.length; i++) {
                    const voiceType = (i % 2 === 0) ? 'female' : 'male';
                    await this.speakText(frammenti[i], voiceType);
                }
            }

            normalizzaNominativo(nome) {
                let testo = nome.toLowerCase().trim();
                if (testo.startsWith("am ")) {
                    testo = testo.substring(3);
                }
                if (testo.includes("lefemine")) {
                    testo = testo.replace("lefemine", "le femmine");
                }
                return testo.replace(/\s+/g, ' ').trim();
            }

            stop() {
                if (this.synthesizer) {
                    this.synthesizer.close();
                }
            }
        }

        // Effetti sonori e visivi
        function suonaBeepSingolo() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, ctx.currentTime);
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.2);
        }

        function suonaTreBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 3; i++) {
                const startTime = ctx.currentTime + i * 0.5;
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, startTime);
                osc.connect(ctx.destination);
                osc.start(startTime);
                osc.stop(startTime + 0.2);
            }
        }

        function lanciaCoriandoli10s() {
            const end = Date.now() + 10 * 1000;
            
            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 }
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 }
                });
                
                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            })();
        }

        // Ordinamento eventi
        function ordinaEventi(eventi) {
            const oggi = getDataCorrente();
            const oggiMMGG = new Date(2000, oggi.getMonth(), oggi.getDate());

            return eventi
                .filter(e => e.Data)
                .map(e => {
                    const dataEvento = parseDataMMGG(e.Data);
                    const giorniMancanti = calcolaGiorniMancanti(dataEvento, oggiMMGG);
                    const eta = calcolaEta(e);
                    return { ...e, dataEvento, giorniMancanti, eta };
                })
                .sort((a, b) => {
                    const diffA = a.dataEvento - oggiMMGG;
                    const diffB = b.dataEvento - oggiMMGG;
                    const tA = (diffA >= 0 ? diffA : diffA + 365*24*60*60*1000);
                    const tB = (diffB >= 0 ? diffB : diffB + 365*24*60*60*1000);
                    return tA - tB;
                });
        }

        // Caricamento dati
        async function caricaCSV(url) {
            try {
                const response = await fetch(url);
                const text = await response.text();
                return text.split('\n')
                    .filter(row => row.trim())
                    .map(row => row.split(',')
                        .map(cell => cell.trim()));
            } catch