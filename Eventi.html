<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <title>Prossimi eventi</title>
  
  <link rel="icon" type="image/png" href="https://sebastiano-mazzarisi.github.io/Test/Eventi.png">
  <link rel="apple-touch-icon" href="https://sebastiano-mazzarisi.github.io/Test/Eventi.png">
  
  <meta property="og:title" content="Prossimi eventi di famiglia">
  <meta property="og:description" content="Scopri tutti i prossimi compleanni, onomastici e anniversari!">
  <meta property="og:image" content="https://sebastiano-mazzarisi.github.io/Test/Eventi.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sebastiano-mazzarisi.github.io/Test/Eventi.html">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Prossimi eventi di famiglia">
  <meta name="twitter:description" content="Scopri tutti i prossimi compleanni, onomastici e anniversari!">
  <meta name="twitter:image" content="https://sebastiano-mazzarisi.github.io/Test/Eventi.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 5px;
      background-color: #f0f0f0;
    }
    
    /* Media query per schermi più grandi */
    @media (min-width: 768px) {
      body {
        margin: 10px;
      }
    }
    
    /* Pulsanti disabilitati di default, JavaScript li abiliterà su desktop */
    #reset-data, #cambia-data {
      display: none !important; 
      margin: 0 5px;
      padding: 5px 10px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #reset-data {
      background-color: #ff4444;
    }
    #reset-data:hover {
      background-color: #cc0000;
    }
    #cambia-data {
      background-color: #4444ff;
    }
    #cambia-data:hover {
      background-color: #0000cc;
    }
    
    /* Pulsanti data nascosti di default, JavaScript li mostrerà su desktop */
    .pulsanti-data {
      display: none !important;
      text-align: center;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #444;
      text-align: center;
      margin-bottom: 5px;
      font-size: 2.5em;
      cursor: pointer;
    }
    
    #oggi {
      text-align: center;
      color: #666;
      font-size: 1em;
      margin-bottom: 15px; 
      position: relative;
    }

    /* Stili base per tutti i pulsanti uniformati */
    .action-button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 1.5em; 
      height: 1.5em; 
      font-size: 1.2em; 
      color: #333; 
      cursor: pointer; 
      border: 1px solid #999; 
      border-radius: 3px; 
      box-sizing: border-box; 
      line-height: 1; 
      vertical-align: middle; 
      background-color: #FFFFE0;
      position: relative;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .action-button:hover {
      color: #000;
      border-color: #444;
      background-color: #FFD700;
    }

    /* Tooltip/Nuvola al hover */
    .action-button::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-5px);
      white-space: nowrap;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      z-index: 10001;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    }

    .action-button:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .tree-icon {
      margin-right: 4px;
    }
    
    .datario-icon {
      margin-left: 4px;
      margin-right: 2px;
    }
    
    .info-icon {
      margin-left: 2px;
    }

    /* Stili per il campo di ricerca */
    #search-container {
      text-align: center;
      margin-bottom: 15px; 
      position: relative;
    }
    #search-input-wrapper {
        display: inline-block;
        position: relative;
        width: 330px;
        max-width: 90%;
    }
    #searchInput {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1em;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-sizing: border-box;
      padding-right: 105px;
    }
    #searchInput:focus {
      border-color: #888;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(136, 136, 136, 0.6);
    }

    /* Stili per il contatore degli eventi */
    #event-counter {
        position: absolute; 
        right: 45px;
        top: 50%; 
        transform: translateY(-50%);
        padding: 5px 8px; 
        background-color: white; 
        border: 1px solid black; 
        border-radius: 5px;
        font-size: 0.9em;
        color: #555;
        white-space: nowrap; 
        box-sizing: border-box;
        line-height: 1; 
        cursor: default; 
    }

    /* Stili per il pulsante X di cancellazione */
    #clear-search-button {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 25px;
        height: 25px;
        border: 1px solid #ccc;
        background-color: white;
        color: black;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        font-weight: normal; /* Rimosso grassetto */
        display: none;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    #clear-search-button:hover {
        background-color: #f0f0f0;
        border-color: #999;
    }

    /* Stili per le barre divisorie per anno */
    .year-divider {
      width: 100%;
      max-width: 1200px;
      margin: 15px auto 10px auto;
      position: relative;
      height: 3px;
      background-color: #F0E68C; /* Giallo paglierino */
      border-radius: 2px;
      flex-basis: 100%; /* Forza la barra a occupare l'intera larghezza, andando a capo */
    }
    
    .year-label {
      position: absolute;
      right: 0;
      top: -12px;
      background-color: #F0E68C; /* Giallo paglierino */
      padding: 2px 8px;
      border-radius: 3px;
      font-weight: bold;
      font-size: 0.9em;
      color: #333;
      border: 1px solid #DAA520;
    }

    ul {
      list-style-type: none;
      padding: 0;
      max-width: 1200px; 
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    li {
      flex: 1 1 calc(50% - 10px);
      min-width: 220px;
      max-width: 280px;
      margin-bottom: 0;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #000; 
      box-shadow: 4px 4px 12px rgba(0,0,0,0.3);
      text-align: center;
      line-height: 1.4;
      position: relative;
    }

    /* Media queries per responsive design */
    @media (min-width: 768px) {
      li {
        flex: 1 1 calc(33.333% - 10px);
      }
    }

    @media (min-width: 1024px) {
      li {
        flex: 1 1 calc(25% - 10px);
      }
    }

    @media (min-width: 1200px) {
      li {
        flex: 1 1 calc(20% - 10px);
      }
    }

    @media (max-width: 600px) {
      body {
        margin: 3px;
      }
      
      ul {
        gap: 5px;
      }
      
      li {
        min-width: 120px;
        padding: 10px;
        font-size: 0.85em;
      }
      
      strong {
        font-size: 1.2em;
      }
      
      #search-container {
        margin-bottom: 10px;
      }
      
      .year-divider {
        margin: 10px auto 8px auto;
      }
    }
    
    li.compleanno {
      background-color: #e6f3ff;
    }
    li.onomastico {
      background-color: #e6ffe6;
    }
    li.anniversario {
      background-color: #fff0f0;
    }
    
    .evento-oggi {
      animation: pulseGlowYellowLi 2s ease-in-out infinite;
    }
    strong {
      font-size: 1.5em;
    }
    .tipo-evento {
      color: #000;
    }
    .compleanno strong {
      color: #00008B;
    }
    .onomastico strong {
      color: #006400;
    }
    .anniversario strong {
      color: #8B0000;
    }
    
    /* Animazione per l'ombra del box LI */
    @keyframes pulseGlowYellowLi {
      0% {
        box-shadow: 4px 4px 12px rgba(0,0,0,0.3), 0 0 10px rgba(240, 230, 140, 0.5);
      }
      50% {
        box-shadow: 4px 4px 12px rgba(0,0,0,0.3), 0 0 20px rgba(240, 230, 140, 0.8);
      }
      100% {
        box-shadow: 4px 4px 12px rgba(0,0,0,0.3), 0 0 10px rgba(240, 230, 140, 0.5);
      }
    }

    /* Badge per giorni mancanti */
    .giorni-badge {
      position: absolute;
      top: 5px;
      left: 5px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      font-weight: bold;
      font-size: 1.1em;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(255, 107, 107, 0.4);
      z-index: 2;
      line-height: 1;
    }

    .giorni-badge.oggi {
      background: linear-gradient(135deg, #ffd93d, #ff6b6b);
      animation: pulseBadge 1.5s ease-in-out infinite alternate;
    }

    .giorni-badge.domani {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
    }

    @keyframes pulseBadge {
      0% { 
        transform: scale(1);
        box-shadow: 0 2px 6px rgba(255, 107, 107, 0.4);
      }
      100% { 
        transform: scale(1.05);
        box-shadow: 0 3px 8px rgba(255, 107, 107, 0.6);
      }
    }
    .star-badge {
      position: absolute; 
      top: 5px; 
      right: 5px; 
      font-size: 1.2em; 
      color: gold; 
      text-shadow: 0 0 3px rgba(255, 215, 0, 0.6); 
      animation: blinkStar 0.6s infinite alternate;
      display: none;
      z-index: 1; 
    }
    
    li.evento-oggi .star-badge {
        display: block;
    }
    @keyframes blinkStar {
      0% { 
        opacity: 0.1; 
        color: gold; 
      }
      100% { 
        opacity: 1; 
        color: #DAA520; 
      }
    }

    /* Stili per la freccia gialla (per eventi NON di oggi) */
    .arrow-badge {
      position: absolute; 
      top: 5px;
      right: 5px;
      font-size: 1.2em; 
      color: gold;
      text-shadow: 0 0 3px rgba(255, 215, 0, 0.6); 
      cursor: pointer;
      z-index: 1; 
      text-decoration: none;
      transition: transform 0.2s ease;
      display: none;
    }
    .arrow-badge:hover {
        transform: scale(1.1);
    }
    
    li:not(.evento-oggi) .arrow-badge {
        display: block;
    }

    /* Stili per i pop-up generici (overlay e content) */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000; 
      display: none; 
    }

    .popup-content {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      position: relative;
      width: 90%; 
      max-width: fit-content; 
      min-width: 300px; 
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .popup-header h2 {
      margin: 0;
      flex-grow: 1; 
      text-align: center;
    }

    /* Stili specifici per il contenuto dell'Albero Genealogico */
    #treeContent {
      font-family: 'Courier New', Courier, monospace; 
      white-space: pre; 
      text-align: left; 
      overflow-x: auto; 
      overflow-y: auto; 
      max-height: 80vh; 
      font-size: clamp(0.7em, 3.5vw, 1em); 
      line-height: 1; 
      margin-top: 10px;
    }

    /* Stili per la modalità datario */
    #datario-container {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
      padding: 5px;
    }

    .datario-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    .mese-container {
      border: 2px solid #DAA520;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }

    .mese-container.passato {
      background: linear-gradient(135deg, #f8f8f8 0%, #f5f5f5 100%);
      border-color: #ccc;
    }

    .mese-container.corrente {
      background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
    }

    .mese-container.passato.vuoto {
      background: linear-gradient(135deg, #f5f5f5 0%, #f2f2f2 100%);
      border-color: #bbb;
    }

    .mese-container.passato .mese-header {
      background-color: #e8e8e8;
      border-bottom-color: #ccc;
      color: #666;
    }

    .evento-datario.passato {
      background-color: rgba(248, 248, 248, 0.8);
      padding: 2px 4px;
      border-radius: 3px;
      margin: 2px 0;
    }

    .evento-datario.oggi {
      background-color: rgba(255, 235, 160, 0.5);
      padding: 2px 4px;
      border-radius: 3px;
      margin: 2px 0;
      border-left: 3px solid #DAA520;
      font-weight: 500;
    }

    /* Separatore nel mese corrente tra eventi passati e futuri */
    .separatore-giorni {
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, #DAA520 0%, #ddd 100%);
      margin: 8px 0;
      border-radius: 1px;
      position: relative;
    }

    .separatore-giorni::after {
      content: "oggi " attr(data-giorno);
      position: absolute;
      right: -2px;
      top: -10px;
      background-color: #DAA520;
      color: white;
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 0.7em;
      font-weight: bold;
    }

    .mese-header {
      background-color: #F0E68C;
      padding: 8px 12px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      color: #333;
      border-bottom: 2px solid #DAA520;
      border-radius: 6px 6px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mese-container.vuoto .mese-header {
      background-color: #f0f0f0;
      border-bottom-color: #ddd;
      color: #999;
    }

    .mese-nome {
      flex: 1;
      text-align: center;
    }

    .mese-counter {
      background-color: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
      font-weight: normal;
      color: #666;
      min-width: 20px;
      text-align: center;
    }

    .mese-container.vuoto .mese-counter {
      background-color: rgba(200, 200, 200, 0.5);
      color: #999;
    }

    .mese-content {
      padding: 12px;
      font-size: 0.85em;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .mese-container.vuoto .mese-content {
      background-color: #f8f8f8;
      justify-content: center;
      align-items: center;
    }

    .evento-datario {
      margin-bottom: 6px;
      line-height: 1.3;
    }

    .evento-datario.compleanno {
      color: #00008B;
    }

    .evento-datario.onomastico {
      color: #006400;
    }

    .evento-datario.anniversario {
      color: #8B0000;
    }

    .giorno-numero {
      font-weight: bold;
    }

    .anni-parentesi {
      font-weight: normal;
      color: #666;
    }

    /* Responsive per datario */
    @media (max-width: 1200px) {
      .datario-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
    }

    @media (max-width: 900px) {
      .datario-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .mese-header {
        font-size: 1em;
        padding: 6px 8px;
      }
      
      .mese-counter {
        font-size: 0.8em;
        padding: 1px 4px;
      }
      
      .mese-content {
        padding: 8px;
        font-size: 0.8em;
      }
      
      .evento-datario {
        margin-bottom: 4px;
      }
    }

    @media (max-width: 600px) {
      #datario-container {
        padding: 5px;
      }
      
      .datario-grid {
        gap: 6px;
      }
      
      .mese-container {
        min-height: 160px;
      }
      
      .mese-header {
        font-size: 0.9em;
        padding: 5px 6px;
      }
      
      .mese-counter {
        font-size: 0.75em;
        padding: 1px 3px;
      }
      
      .mese-content {
        padding: 6px;
        font-size: 0.75em;
      }
      
      .evento-datario {
        margin-bottom: 3px;
        line-height: 1.2;
      }
    }

    /* Stili per contenitori dinamici quando ci sono pochi eventi */
    .datario-compatto .mese-container {
      min-height: auto;
    }

    .datario-compatto .mese-content {
      min-height: auto;
      padding: 8px;
    }

    .datario-compatto .mese-container.vuoto {
      min-height: 80px;
    }

    .datario-compatto .mese-container.vuoto .mese-content {
      min-height: 40px;
      padding: 4px;
    }

    /* Finestrella di conferma copia non bloccante */
    #copyConfirmation {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 123, 255, 0.85); 
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 1em;
        text-align: center;
        z-index: 11000; 
        opacity: 0; 
        pointer-events: none; 
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; transform: translateX(-50%) translateY(0); }
        to { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
    .fade-in {
        animation: fadeIn 0.3s forwards;
    }
    .fade-out {
        animation: fadeOut 0.3s forwards;
    }

    #loading-indicator {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: #666;
      display: none; 
    }

    #end-of-list-message {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: #999;
      display: none; 
    }

  </style>
</head>

<body>
  <h1 id="titolo">Prossimi eventi</h1>

  <div class="pulsanti-data">
    <button id="cambia-data">Cambia data</button>
    <button id="reset-data">Torna alla data reale</button>
  </div>
  
  <div id="oggi">
    <span class="action-button tree-icon" id="tree-icon" data-tooltip="Albero genealogico">a</span> 
    <span id="data-corrente-testo"></span>
    <span class="action-button datario-icon" id="datario-icon" data-tooltip="Modalità datario">d</span>
    <span class="action-button info-icon" id="info-icon" data-tooltip="Informazioni">i</span>
  </div>

  <div id="search-container">
    <div id="search-input-wrapper">
        <input type="text" id="searchInput" placeholder="Cerca eventi...">
        <div id="event-counter" class="search-addon">0/0</div>
        <button id="clear-search-button" title="Cancella ricerca">×</button>
    </div>
  </div>

  <div id="datario-container"></div>

  <ul id="eventi-lista"></ul>

  <div id="loading-indicator">Caricamento eventi...</div>
  <div id="end-of-list-message">Non ci sono altri eventi da mostrare.</div>

  <div id="bookmarkPopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Istruzioni per il Segnalibro</h2>
        <button class="action-button" id="bookmark-close-button" data-tooltip="Chiudi finestra">x</button>
      </div>
      <p>Per un'esperienza ottimale, aggiungi questa pagina alla schermata Home del tuo dispositivo.</p>
      <p>Su iOS: Clicca sull'icona "Condividi" (il quadrato con la freccia in alto) e poi "Aggiungi alla schermata Home".</p>
      <p>Su Android: Clicca sul menu (i tre puntini in alto a destra) e poi "Aggiungi a schermata Home".</p>
    </div>
  </div>

  <div id="treePopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Albero Genealogico</h2>
        <div>
          <button class="action-button" id="tree-copy-button" data-tooltip="Copia negli appunti">c</button>
          <button class="action-button" id="tree-close-button" data-tooltip="Chiudi finestra">x</button>
        </div>
      </div>
      <pre id="treeContent">Caricamento albero...</pre>
    </div>
  </div>

  <div id="copyConfirmation">Copiato negli appunti!</div>

<script>
// ===== VARIABILI GLOBALI =====
const eventiData = [
  {"Nominativo": "AM Angela e Onofrio", "Tipo": "Anniversario", "Data": "09/08/1975", "Anno": "1975"},
  {"Nominativo": "AM Anna e Giuseppe", "Tipo": "Anniversario", "Data": "09/07/1997", "Anno": "1997"},
  {"Nominativo": "AM Antonietta e Saverio", "Tipo": "Anniversario", "Data": "09/09/2000", "Anno": "2000"},
  {"Nominativo": "AM Cinzia e Gianni", "Tipo": "Anniversario", "Data": "13/09/2014", "Anno": "2014"},
  {"Nominativo": "AM Genny e Benny", "Tipo": "Anniversario", "Data": "26/07/2008", "Anno": "2008"},
  {"Nominativo": "AM Marica e Nino", "Tipo": "Anniversario", "Data": "04/07/1987", "Anno": "1987"},
  {"Nominativo": "AM Rosa e Giovanni", "Tipo": "Anniversario", "Data": "29/12/2004", "Anno": "2004"},
  {"Nominativo": "AM Teresa e Luigi", "Tipo": "Anniversario", "Data": "03/12/1956", "Anno": "1956"},
  {"Nominativo": "AM Tiziana e Riccardo", "Tipo": "Anniversario", "Data": "04/10/2002", "Anno": "2002"},
  {"Nominativo": "AM Vanna e Domenico", "Tipo": "Anniversario", "Data": "28/08/1991", "Anno": "1991"},
  {"Nominativo": "Bianco Rosa", "Tipo": "Compleanno", "Data": "02/09/1971", "Anno": "1971"},
  {"Nominativo": "Bianco Rosa", "Tipo": "Onomastico", "Data": "23/08", "Anno": ""},
  {"Nominativo": "Chiarappa Cristiano", "Tipo": "Compleanno", "Data": "20/06/2001", "Anno": "2001"},
  {"Nominativo": "Chiarappa Cristiano", "Tipo": "Onomastico", "Data": "07/04", "Anno": ""},
  {"Nominativo": "Chiarappa Martino", "Tipo": "Compleanno", "Data": "24/05/1997", "Anno": "1997"},
  {"Nominativo": "Chiarappa Martino", "Tipo": "Onomastico", "Data": "11/11", "Anno": ""},
  {"Nominativo": "Chiarappa Saverio", "Tipo": "Compleanno", "Data": "26/11/1951", "Anno": "1951"},
  {"Nominativo": "Chiarappa Saverio", "Tipo": "Onomastico", "Data": "03/12", "Anno": ""},
  {"Nominativo": "Dalena Riccardo", "Tipo": "Compleanno", "Data": "11/04/1973", "Anno": "1973"},
  {"Nominativo": "Dalena Riccardo", "Tipo": "Onomastico", "Data": "03/04", "Anno": ""},
  {"Nominativo": "Grilletti Teresa", "Tipo": "Compleanno", "Data": "05/03/1937", "Anno": "1937"},
  {"Nominativo": "Grilletti Teresa", "Tipo": "Onomastico", "Data": "15/10", "Anno": ""},
  {"Nominativo": "Lefemine Domenico", "Tipo": "Compleanno", "Data": "06/02/1957", "Anno": "1957"},
  {"Nominativo": "Lefemine Domenico", "Tipo": "Onomastico", "Data": "04/08", "Anno": ""},
  {"Nominativo": "Lefemine Flavia", "Tipo": "Compleanno", "Data": "16/11/1996", "Anno": "1996"},
  {"Nominativo": "Lefemine Flavia", "Tipo": "Onomastico", "Data": "07/05", "Anno": ""},
  {"Nominativo": "Lefemine Francesco", "Tipo": "Compleanno", "Data": "20/03/2000", "Anno": "2000"},
  {"Nominativo": "Lefemine Francesco", "Tipo": "Onomastico", "Data": "04/10", "Anno": ""},
  {"Nominativo": "Lepore Genny", "Tipo": "Compleanno", "Data": "04/07/1975", "Anno": "1975"},
  {"Nominativo": "Lepore Genny", "Tipo": "Onomastico", "Data": "11/04", "Anno": ""},
  {"Nominativo": "Lorusso Alessandro", "Tipo": "Compleanno", "Data": "17/07/2010", "Anno": "2010"},
  {"Nominativo": "Lorusso Alessandro", "Tipo": "Onomastico", "Data": "26/08", "Anno": ""},
  {"Nominativo": "Lorusso Alice", "Tipo": "Compleanno", "Data": "20/07/2013", "Anno": "2013"},
  {"Nominativo": "Lorusso Alice", "Tipo": "Onomastico", "Data": "13/06", "Anno": ""},
  {"Nominativo": "Lorusso Benny", "Tipo": "Compleanno", "Data": "17/11/1975", "Anno": "1975"},
  {"Nominativo": "Lorusso Benny", "Tipo": "Onomastico", "Data": "21/03", "Anno": ""},
  {"Nominativo": "Lorusso Cinzia", "Tipo": "Compleanno", "Data": "06/04/1980", "Anno": "1980"},
  {"Nominativo": "Lorusso Nina", "Tipo": "Compleanno", "Data": "29/11/2015", "Anno": "2015"},
  {"Nominativo": "Lorusso Nina", "Tipo": "Onomastico", "Data": "15/12", "Anno": ""},
  {"Nominativo": "Lorusso Onofrio", "Tipo": "Compleanno", "Data": "05/08/1951", "Anno": "1951"},
  {"Nominativo": "Lorusso Onofrio", "Tipo": "Onomastico", "Data": "12/06", "Anno": ""},
  {"Nominativo": "Mazzarisi Maria Grazia", "Tipo": "Compleanno", "Data": "21/01/1989", "Anno": "1989"},
  {"Nominativo": "Mazzarisi Maria Grazia", "Tipo": "Onomastico", "Data": "12/09", "Anno": ""},
  {"Nominativo": "Mazzarisi Nino", "Tipo": "Compleanno", "Data": "07/05/1957", "Anno": "1957"},
  {"Nominativo": "Mazzarisi Nino", "Tipo": "Onomastico", "Data": "20/01", "Anno": ""},
  {"Nominativo": "Mazzarisi Onofrio", "Tipo": "Compleanno", "Data": "05/06/1992", "Anno": "1992"},
  {"Nominativo": "Mazzarisi Onofrio", "Tipo": "Onomastico", "Data": "12/06", "Anno": ""},
  {"Nominativo": "Mazzarisi Teresa", "Tipo": "Compleanno", "Data": "01/04/1994", "Anno": "1994"},
  {"Nominativo": "Mazzarisi Teresa", "Tipo": "Onomastico", "Data": "15/10", "Anno": ""},
  {"Nominativo": "Pricci Angela", "Tipo": "Compleanno", "Data": "13/01/1957", "Anno": "1957"},
  {"Nominativo": "Pricci Angela", "Tipo": "Onomastico", "Data": "02/08", "Anno": ""},
  {"Nominativo": "Pricci Asia", "Tipo": "Compleanno", "Data": "07/06/2006", "Anno": "2006"},
  {"Nominativo": "Pricci Asia", "Tipo": "Onomastico", "Data": "19/02", "Anno": ""},
  {"Nominativo": "Pricci Gilda", "Tipo": "Compleanno", "Data": "29/06/2004", "Anno": "2004"},
  {"Nominativo": "Pricci Gilda", "Tipo": "Onomastico", "Data": "13/02", "Anno": ""},
  {"Nominativo": "Pricci Giovanni", "Tipo": "Compleanno", "Data": "24/10/1964", "Anno": "1964"},
  {"Nominativo": "Pricci Giovanni", "Tipo": "Onomastico", "Data": "24/06", "Anno": ""},
  {"Nominativo": "Pricci Giuseppe", "Tipo": "Compleanno", "Data": "12/08/1968", "Anno": "1968"},
  {"Nominativo": "Pricci Giuseppe", "Tipo": "Onomastico", "Data": "19/03", "Anno": ""},
  {"Nominativo": "Pricci Luigi", "Tipo": "Compleanno", "Data": "16/11/1933", "Anno": "1933"},
  {"Nominativo": "Pricci Luigi", "Tipo": "Onomastico", "Data": "21/06", "Anno": ""},
  {"Nominativo": "Pricci Maria Antonietta", "Tipo": "Compleanno", "Data": "21/05/1958", "Anno": "1958"},
  {"Nominativo": "Pricci Maria Antonietta", "Tipo": "Onomastico", "Data": "13/06", "Anno": ""},
  {"Nominativo": "Pricci Marica", "Tipo": "Compleanno", "Data": "12/04/1961", "Anno": "1961"},
  {"Nominativo": "Pricci Marica", "Tipo": "Onomastico", "Data": "12/09", "Anno": ""},
  {"Nominativo": "Pricci Tiziana", "Tipo": "Compleanno", "Data": "27/06/1972", "Anno": "1972"},
  {"Nominativo": "Pricci Tiziana", "Tipo": "Onomastico", "Data": "03/03", "Anno": ""},
  {"Nominativo": "Pricci Vanna", "Tipo": "Compleanno", "Data": "11/09/1963", "Anno": "1963"},
  {"Nominativo": "Pricci Vanna", "Tipo": "Onomastico", "Data": "24/06", "Anno": ""},
  {"Nominativo": "Rotondi Gianni", "Tipo": "Compleanno", "Data": "08/03/1974", "Anno": "1974"},
  {"Nominativo": "Rotondi Gianni", "Tipo": "Onomastico", "Data": "24/06", "Anno": ""},
  {"Nominativo": "Rotondi Nicoletta", "Tipo": "Compleanno", "Data": "12/02/2019", "Anno": "2019"},
  {"Nominativo": "Rotondi Nicoletta", "Tipo": "Onomastico", "Data": "06/12", "Anno": ""},
  {"Nominativo": "Trivisani Anna", "Tipo": "Compleanno", "Data": "12/07/1969", "Anno": "1969"},
  {"Nominativo": "Trivisani Anna", "Tipo": "Onomastico", "Data": "26/07", "Anno": ""}
];

const nomiNozze = {
  "1": "Nozze di Carta", "2": "Nozze di Cotone", "3": "Nozze di Cuoio", "4": "Nozze di Lino",
  "5": "Nozze di Legno", "6": "Nozze di Ferro", "7": "Nozze di Lana", "8": "Nozze di Bronzo",
  "9": "Nozze di Argilla", "10": "Nozze di Alluminio", "11": "Nozze di Acero", "12": "Nozze di Seta",
  "13": "Nozze di Pizzo", "14": "Nozze di Avorio", "15": "Nozze di Cristallo", "16": "Nozze di Edera",
  "17": "Nozze di Viola", "18": "Nozze di Quarzo", "19": "Nozze di Caprifoglio", "20": "Nozze di Porcellana",
  "21": "Nozze di Rovere", "22": "Nozze di Rame", "23": "Nozze di Acqua", "24": "Nozze di Granito",
  "25": "Nozze di Argento", "26": "Nozze di Rosa", "27": "Nozze di Gaietto", "28": "Nozze di Ambra",
  "29": "Nozze di Velluto", "30": "Nozze di Perla", "31": "Nozze di Ebano", "32": "Nozze di Rame",
  "33": "Nozze di Stagno", "34": "Nozze di Ampolla", "35": "Nozze di Corallo", "36": "Nozze di Silice",
  "37": "Nozze di Pietra", "38": "Nozze di Giada", "39": "Nozze di Agata", "40": "Nozze di Rubino",
  "41": "Nozze di Topazio", "42": "Nozze di Diaspro", "43": "Nozze di Opale", "44": "Nozze di Turchese",
  "45": "Nozze di Zaffiro", "46": "Nozze di Perla", "47": "Nozze di Ametista", "48": "Nozze di Feldspato",
  "49": "Nozze di Zircone", "50": "Nozze di Oro", "51": "Nozze di Camelia", "52": "Nozze di Tormalina",
  "53": "Nozze di Ciliegio", "54": "Nozze di Zibellino", "55": "Nozze di Smeraldo", "56": "Nozze di Lapislazzuli",
  "57": "Nozze di Azalea", "58": "Nozze di Acero", "59": "Nozze di Visone", "60": "Nozze di Diamante",
  "61": "Nozze di Platano", "62": "Nozze di Avorio", "63": "Nozze di Giglio", "64": "Nozze di Astrakan",
  "65": "Nozze di Platino", "66": "Nozze di Gelsomino", "67": "Nozze di Cincillà", "68": "Nozze di Granito",
  "69": "Nozze di Melenzio", "70": "Nozze di Titanio", "75": "Nozze di Brillanti", "80": "Nozze di Quercia",
  "85": "Nozze di Marmo", "90": "Nozze di Granito", "95": "Nozze di Onice", "100": "Nozze di Ossido"
};

let tuttiGliEventi = [];
let dataPersonalizzata = null;
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let modalitaDatario = false;

// ===== FUNZIONI UTILITY =====
function getDataOdierna() {
  return dataPersonalizzata || new Date();
}

function parseData(dataStr) {
  if (!dataStr) return null;
  const parti = dataStr.split("/").map(Number);
  if (parti.length < 2) return null;
  return new Date(2000, parti[1] - 1, parti[0]);
}

function calcolaGiorni(dataEvento, oggi) {
  if (!dataEvento || !oggi) return 0;
  
  // Normalizza entrambe le date a mezzanotte per confronto preciso
  const oggiNormalizzato = new Date(oggi.getFullYear(), oggi.getMonth(), oggi.getDate());
  const eventoNormalizzato = new Date(dataEvento.getFullYear(), dataEvento.getMonth(), dataEvento.getDate());
  
  const diff = eventoNormalizzato - oggiNormalizzato;
  const giorni = Math.round(diff / (1000 * 60 * 60 * 24));
  
  return giorni >= 0 ? giorni : giorni + 365;
}

function calcolaAnni(evento) {
  if (!evento || (evento.Tipo !== "Compleanno" && evento.Tipo !== "Anniversario")) return null;
  const anno = parseInt(evento.Anno);
  if (isNaN(anno)) return null;
  
  const oggi = getDataOdierna();
  const annoCorrente = oggi.getFullYear();
  const parti = evento.Data.split("/").map(Number);
  const giornoEvento = parti[0];
  const meseEvento = parti[1];
  
  // Determina l'anno per cui calcolare gli anni
  // Se stiamo visualizzando un evento che si verifica nell'anno prossimo,
  // dobbiamo usare l'anno prossimo per il calcolo
  let annoCalcolo = annoCorrente;
  
  // Crea la data dell'evento nell'anno corrente
  const dataEventoQuestAnno = new Date(annoCorrente, meseEvento - 1, giornoEvento);
  const oggiNormalizzato = new Date(oggi.getFullYear(), oggi.getMonth(), oggi.getDate());
  
  // Se l'evento è già passato quest'anno, per eventi futuri useremo l'anno prossimo
  if (dataEventoQuestAnno < oggiNormalizzato) {
    // L'evento si verificherà l'anno prossimo
    annoCalcolo = annoCorrente + 1;
  }
  
  // Calcola gli anni che si compiranno/sono stati compiuti
  let anni = annoCalcolo - anno;
  
  return anni;
}

function getDataCompleta(evento) {
  if (!evento?.Data) return { giorno: '', mese: '', anno: '' };
  
  const oggi = getDataOdierna();
  const annoCorrente = oggi.getFullYear();
  const parti = evento.Data.split("/").map(Number);
  
  let dataEvento = new Date(annoCorrente, parti[1] - 1, parti[0]);
  
  // Normalizza la data di oggi a mezzanotte per il confronto
  const oggiSenzaOra = new Date(oggi.getFullYear(), oggi.getMonth(), oggi.getDate());
  
  // Se la data è già passata quest'anno (ma non oggi), usa l'anno prossimo
  if (dataEvento < oggiSenzaOra) {
    dataEvento.setFullYear(annoCorrente + 1);
  }
  
  const giorni = ["domenica", "lunedì", "martedì", "mercoledì", "giovedì", "venerdì", "sabato"];
  const mesi = ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno", "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"];
  
  return {
    giornoSettimana: giorni[dataEvento.getDay()],
    giorno: dataEvento.getDate(),
    mese: mesi[dataEvento.getMonth()],
    annoCorrente: dataEvento.getFullYear()
  };
}

function ordinaEventi(eventi) {
  const oggi = getDataOdierna();
  
  return eventi.filter(e => e.Data).map(e => {
    const dataEvento = parseData(e.Data);
    if (!dataEvento) return null;
    
    // Usa l'anno corrente o prossimo per il calcolo
    const annoCorrente = oggi.getFullYear();
    let dataEventoCompleta = new Date(annoCorrente, dataEvento.getMonth(), dataEvento.getDate());
    
    // Normalizza la data di oggi a mezzanotte per il confronto
    const oggiSenzaOra = new Date(oggi.getFullYear(), oggi.getMonth(), oggi.getDate());
    
    // Se la data è già passata quest'anno (ma non oggi), usa l'anno prossimo
    if (dataEventoCompleta < oggiSenzaOra) {
      dataEventoCompleta.setFullYear(annoCorrente + 1);
    }
    
    const giorni = calcolaGiorni(dataEventoCompleta, oggiSenzaOra);
    const anni = calcolaAnni(e);
    
    return { ...e, dataEvento: dataEventoCompleta, giorni, anni };
  }).filter(e => e?.dataEvento).sort((a, b) => {
    // Ordina per giorni mancanti
    return a.giorni - b.giorni;
  });
}

function aggiornaData() {
  const oggi = getDataOdierna();
  const giorni = ["Domenica", "Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato"];
  const mesi = ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno", "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"];
  const testo = `${giorni[oggi.getDay()]} ${oggi.getDate()} ${mesi[oggi.getMonth()]} ${oggi.getFullYear()}`;
  document.getElementById('data-corrente-testo').innerText = testo;
}

function suonaBeep() {
  if (isMobile) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(500, ctx.currentTime);
    osc.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.2);
  } catch (error) {
    console.error("Errore audio:", error);
  }
}

function creaElementoEvento(evento) {
  const li = document.createElement('li');
  li.classList.add(evento.Tipo.toLowerCase());
  
  let icona = '';
  let badgeGiorni = '';
  
  if (evento.giorni === 0) {
    li.classList.add('evento-oggi');
    icona = '<span class="star-badge">⭐</span>';
    badgeGiorni = '<div class="giorni-badge oggi">OGGI</div>';
  } else {
    icona = '<a href="#titolo" class="arrow-badge" title="Torna su">⬆️</a>';
    // Aggiungi sempre il badge, ma sarà nascosto/mostrato dalla logica in mostraEventi
    if (evento.giorni === 1) {
      badgeGiorni = '<div class="giorni-badge domani">1</div>';
    } else if (evento.giorni > 1) {
      badgeGiorni = `<div class="giorni-badge">${evento.giorni}</div>`;
    }
  }
  
  const { giornoSettimana, giorno, mese, annoCorrente } = getDataCompleta(evento);
  const dataCompleta = `${giornoSettimana} ${giorno} ${mese} ${annoCorrente}`;
  
  let tipoTesto = "";
  if (evento.Tipo === "Compleanno" || evento.Tipo === "Anniversario") {
    if (evento.anni !== null && evento.anni !== undefined) {
      const quando = evento.giorni === 0 ? "oggi" : evento.giorni === 1 ? "domani" : `tra ${evento.giorni} giorni`;
      tipoTesto = `${evento.anni}° ${evento.Tipo} ${quando}`;
    } else {
      const quando = evento.giorni === 0 ? "oggi" : evento.giorni === 1 ? "domani" : `tra ${evento.giorni} giorni`;
      tipoTesto = `${evento.Tipo} ${quando}`;
    }
  } else {
    const quando = evento.giorni === 0 ? "oggi" : evento.giorni === 1 ? "domani" : `tra ${evento.giorni} giorni`;
    tipoTesto = `Onomastico ${quando}`;
  }
  
  let nomeNozze = "";
  if (evento.Tipo === "Anniversario" && evento.anni !== null && evento.anni !== undefined) {
    if (nomiNozze[evento.anni]) {
      nomeNozze = `${nomiNozze[evento.anni]}`;
    }
  }
  
  const nomeEscaped = evento.Nominativo.replace(/'/g, "\\'");
  
  // Creiamo il testo completo per la ricerca - questo sarà memorizzato come proprietà dell'elemento
  const testoCompleto = [
    evento.Nominativo,
    evento.Tipo,
    tipoTesto,
    dataCompleta,
    nomeNozze,
    giornoSettimana,
    giorno.toString(),
    mese,
    annoCorrente.toString(),
    evento.Data // Include anche la data originale (es: "17/07")
  ].filter(t => t).join(' ').toLowerCase();
  
  li.innerHTML = `
    ${badgeGiorni}
    ${icona}
    <a href="javascript:void(0)" onclick="clickEvento('${nomeEscaped}')" style="text-decoration:none; color: inherit;">
      <strong>${evento.Nominativo}</strong>
    </a>
    <br>
    <span class="tipo-evento">${tipoTesto}</span><br>
    ${dataCompleta}<br>
    ${nomeNozze ? nomeNozze + '<br>' : ''}
  `;
  
  // Memorizziamo il testo completo come proprietà dell'elemento per la ricerca
  li.testoCompleto = testoCompleto;
  
  li.addEventListener('click', () => {
    if (evento.giorni === 0) {
      suonaBeep();
    }
  });
  
  return li;
}

function creaBarraAnno(anno) {
  const barra = document.createElement('div');
  barra.className = 'year-divider';
  barra.innerHTML = `<div class="year-label">${anno}</div>`;
  return barra;
}

function creaMeseDatario(mese, anno, eventi, termineRicerca = '') {
  const nomiMesi = [
    'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
    'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
  ];
  
  const oggi = getDataOdierna();
  const meseCorrente = oggi.getMonth();
  const annoCorrente = oggi.getFullYear();
  const giornoCorrente = oggi.getDate();
  
  // Determina se il mese è passato, corrente o futuro
  let tipologiaMese = '';
  if (anno < annoCorrente || (anno === annoCorrente && mese < meseCorrente)) {
    tipologiaMese = 'passato';
  } else if (anno === annoCorrente && mese === meseCorrente) {
    tipologiaMese = 'corrente';
  } else {
    tipologiaMese = 'futuro';
  }
  
  let eventiMese = eventi.filter(evento => {
    if (!evento.Data) return false;
    const parti = evento.Data.split("/").map(Number);
    return parti[1] === (mese + 1); // mese è 0-based, parti[1] è 1-based
  });
  
  // Applica filtro di ricerca se presente
  if (termineRicerca.trim()) {
    const termini = termineRicerca.toLowerCase().trim().split(/\s+/);
    const parolePositive = [];
    const paroleNegative = [];
    
    termini.forEach(parola => {
      if (parola.startsWith('-') && parola.length > 1) {
        paroleNegative.push(parola.substring(1));
      } else if (parola.startsWith('-') && parola.length === 1) {
        return;
      } else {
        parolePositive.push(parola);
      }
    });
    
    eventiMese = eventiMese.filter(evento => {
      const testoCompleto = [
        evento.Nominativo,
        evento.Tipo,
        evento.Data
      ].filter(t => t).join(' ').toLowerCase();
      
      const contienePositive = parolePositive.length === 0 || 
                              parolePositive.every(parola => testoCompleto.includes(parola));
      
      const nonContieneNegative = paroleNegative.length === 0 || 
                                 paroleNegative.every(parola => !testoCompleto.includes(parola));
      
      return contienePositive && nonContieneNegative;
    });
  }
  
  // Raggruppa eventi per giorno
  const eventiPerGiorno = {};
  eventiMese.forEach(evento => {
    const parti = evento.Data.split("/").map(Number);
    const giorno = parti[0];
    if (!eventiPerGiorno[giorno]) {
      eventiPerGiorno[giorno] = [];
    }
    eventiPerGiorno[giorno].push(evento);
  });
  
  // Ordina i giorni
  const giorniOrdinati = Object.keys(eventiPerGiorno).map(Number).sort((a, b) => a - b);
  
  let contenuto = '';
  
  // Se è il mese corrente, dobbiamo inserire il separatore tra passato/oggi e futuro
  if (tipologiaMese === 'corrente') {
    const giorniPassatiEOggi = giorniOrdinati.filter(g => g <= giornoCorrente);
    const giorniFuturi = giorniOrdinati.filter(g => g > giornoCorrente);
    
    // Eventi passati e di oggi
    giorniPassatiEOggi.forEach(giorno => {
      eventiPerGiorno[giorno].forEach(evento => {
        let nome = evento.Nominativo;
        let anni = '';
        
        if (evento.Tipo === 'Compleanno' || evento.Tipo === 'Anniversario') {
          const annoNascita = parseInt(evento.Anno);
          if (!isNaN(annoNascita)) {
            // Per il datario, calcola sempre gli anni rispetto all'anno del mese visualizzato
            anni = ` (${anno - annoNascita})`;
          }
        }
        
        const classeTemporale = giorno === giornoCorrente ? ' oggi' : ' passato';
        const classeEvento = evento.Tipo.toLowerCase();
        contenuto += `<div class="evento-datario ${classeEvento}${classeTemporale}">
          <span class="giorno-numero">${giorno})</span> ${nome}<span class="anni-parentesi">${anni}</span>
        </div>`;
      });
    });
    
    // Separatore temporale (solo se ci sono eventi futuri)
    if (giorniFuturi.length > 0 && giorniPassatiEOggi.length > 0) {
      contenuto += `<div class="separatore-giorni" data-giorno="${giornoCorrente}"></div>`;
    }
    
    // Eventi futuri
    giorniFuturi.forEach(giorno => {
      eventiPerGiorno[giorno].forEach(evento => {
        let nome = evento.Nominativo;
        let anni = '';
        
        if (evento.Tipo === 'Compleanno' || evento.Tipo === 'Anniversario') {
          const annoNascita = parseInt(evento.Anno);
          if (!isNaN(annoNascita)) {
            // Per il datario, calcola sempre gli anni rispetto all'anno del mese visualizzato
            anni = ` (${anno - annoNascita})`;
          }
        }
        
        const classeEvento = evento.Tipo.toLowerCase();
        contenuto += `<div class="evento-datario ${classeEvento}">
          <span class="giorno-numero">${giorno})</span> ${nome}<span class="anni-parentesi">${anni}</span>
        </div>`;
      });
    });
  } else {
    // Per mesi completamente passati o futuri
    giorniOrdinati.forEach(giorno => {
      eventiPerGiorno[giorno].forEach(evento => {
        let nome = evento.Nominativo;
        let anni = '';
        
        if (evento.Tipo === 'Compleanno' || evento.Tipo === 'Anniversario') {
          const annoNascita = parseInt(evento.Anno);
          if (!isNaN(annoNascita)) {
            // Per il datario, calcola sempre gli anni rispetto all'anno del mese visualizzato
            anni = ` (${anno - annoNascita})`;
          }
        }
        
        const classeTemporale = tipologiaMese === 'passato' ? ' passato' : '';
        const classeEvento = evento.Tipo.toLowerCase();
        contenuto += `<div class="evento-datario ${classeEvento}${classeTemporale}">
          <span class="giorno-numero">${giorno})</span> ${nome}<span class="anni-parentesi">${anni}</span>
        </div>`;
      });
    });
  }
  
  const numeroEventi = eventiMese.length;
  let classiContainer = '';
  
  if (numeroEventi === 0) {
    classiContainer += ' vuoto';
  }
  if (tipologiaMese === 'passato') {
    classiContainer += ' passato';
  } else if (tipologiaMese === 'corrente') {
    classiContainer += ' corrente';
  }
  
  return `
    <div class="mese-container${classiContainer}">
      <div class="mese-header">
        <div class="mese-nome">${nomiMesi[mese]} ${anno}</div>
        <div class="mese-counter">${numeroEventi}</div>
      </div>
      <div class="mese-content">
        ${contenuto || '<div style="color: #bbb; font-style: italic; font-size: 0.9em;">Nessun evento</div>'}
      </div>
    </div>
  `;
}

function mostraDatario() {
  const oggi = getDataOdierna();
  const annoCorrente = oggi.getFullYear();
  const termineRicerca = document.getElementById('searchInput').value;
  
  const datarioContainer = document.getElementById('datario-container');
  const eventiLista = document.getElementById('eventi-lista');
  const searchContainer = document.getElementById('search-container');
  
  // Conta il numero totale di eventi che soddisfano la ricerca
  let totalEventiVisibili = 0;
  if (termineRicerca.trim()) {
    const termini = termineRicerca.toLowerCase().trim().split(/\s+/);
    const parolePositive = [];
    const paroleNegative = [];
    
    termini.forEach(parola => {
      if (parola.startsWith('-') && parola.length > 1) {
        paroleNegative.push(parola.substring(1));
      } else if (parola.startsWith('-') && parola.length === 1) {
        return;
      } else {
        parolePositive.push(parola);
      }
    });
    
    totalEventiVisibili = tuttiGliEventi.filter(evento => {
      const testoCompleto = [
        evento.Nominativo,
        evento.Tipo,
        evento.Data
      ].filter(t => t).join(' ').toLowerCase();
      
      const contienePositive = parolePositive.length === 0 || 
                              parolePositive.every(parola => testoCompleto.includes(parola));
      
      const nonContieneNegative = paroleNegative.length === 0 || 
                                 paroleNegative.every(parola => !testoCompleto.includes(parola));
      
      return contienePositive && nonContieneNegative;
    }).length;
  } else {
    totalEventiVisibili = tuttiGliEventi.length;
  }
  
  // Applica la classe compatta se ci sono pochi eventi
  const classeCompatta = totalEventiVisibili <= 20 ? ' datario-compatto' : '';
  datarioContainer.className = classeCompatta;
  
  let html = '';
  
  // Crea tutti i 12 mesi dell'anno corrente in gruppi di 4 (o 3 o 2 a seconda del responsive)
  for (let i = 0; i < 12; i += 4) {
    html += '<div class="datario-grid">';
    for (let j = 0; j < 4 && (i + j) < 12; j++) {
      const meseIndex = i + j;
      html += creaMeseDatario(meseIndex, annoCorrente, tuttiGliEventi, termineRicerca);
    }
    html += '</div>';
  }
  
  datarioContainer.innerHTML = html;
  
  // Aggiorna il contatore degli eventi in modalità datario
  aggiornaContatoreDatario(termineRicerca);
  
  // Mostra il datario e la ricerca, nasconde la lista
  datarioContainer.style.display = 'block';
  eventiLista.style.display = 'none';
  searchContainer.style.display = 'block';
  
  modalitaDatario = true;
  
  // Cambia l'icona e tooltip
  const datarioIcon = document.getElementById('datario-icon');
  datarioIcon.textContent = 'e';
  datarioIcon.setAttribute('data-tooltip', 'Modalità elenco');
}

function aggiornaContatoreDatario(termineRicerca) {
  const contatore = document.getElementById('event-counter');
  const btnCancella = document.getElementById('clear-search-button');
  
  if (termineRicerca.trim()) {
    // Conta gli eventi che soddisfano la ricerca
    const termini = termineRicerca.toLowerCase().trim().split(/\s+/);
    const parolePositive = [];
    const paroleNegative = [];
    
    termini.forEach(parola => {
      if (parola.startsWith('-') && parola.length > 1) {
        paroleNegative.push(parola.substring(1));
      } else if (parola.startsWith('-') && parola.length === 1) {
        return;
      } else {
        parolePositive.push(parola);
      }
    });
    
    const eventiFiltrati = tuttiGliEventi.filter(evento => {
      const testoCompleto = [
        evento.Nominativo,
        evento.Tipo,
        evento.Data
      ].filter(t => t).join(' ').toLowerCase();
      
      const contienePositive = parolePositive.length === 0 || 
                              parolePositive.every(parola => testoCompleto.includes(parola));
      
      const nonContieneNegative = paroleNegative.length === 0 || 
                                 paroleNegative.every(parola => !testoCompleto.includes(parola));
      
      return contienePositive && nonContieneNegative;
    });
    
    contatore.textContent = `${eventiFiltrati.length}/${tuttiGliEventi.length}`;
    btnCancella.style.display = 'flex';
  } else {
    contatore.textContent = `${tuttiGliEventi.length}/${tuttiGliEventi.length}`;
    btnCancella.style.display = 'none';
  }
}

function mostraElenco() {
  const datarioContainer = document.getElementById('datario-container');
  const eventiLista = document.getElementById('eventi-lista');
  const searchContainer = document.getElementById('search-container');
  
  // Nasconde il datario e mostra la lista
  datarioContainer.style.display = 'none';
  eventiLista.style.display = 'flex';
  searchContainer.style.display = 'block';
  
  modalitaDatario = false;
  
  // Cambia l'icona e tooltip
  const datarioIcon = document.getElementById('datario-icon');
  datarioIcon.textContent = 'd';
  datarioIcon.setAttribute('data-tooltip', 'Modalità datario');
  
  // Ricarica gli eventi nell'elenco
  const eventiOrdinati = ordinaEventi(tuttiGliEventi);
  const termineRicerca = document.getElementById('searchInput').value;
  mostraEventi(eventiOrdinati, termineRicerca);
}

function toggleDatario() {
  if (modalitaDatario) {
    mostraElenco();
  } else {
    mostraDatario();
  }
}

function mostraEventi(eventi, termine = '') {
  const lista = document.getElementById('eventi-lista');
  const contatore = document.getElementById('event-counter');
  const btnCancella = document.getElementById('clear-search-button');
  const messaggioFine = document.getElementById('end-of-list-message');
  
  // Filtra prima gli eventi originali per determinare i prossimi
  let eventiFiltrati = eventi;
  
  if (termine.trim()) {
    // Ricerca avanzata: separa parole positive e negative
    const termini = termine.toLowerCase().trim().split(/\s+/);
    const parolePositive = [];
    const paroleNegative = [];
    
    termini.forEach(parola => {
      if (parola.startsWith('-') && parola.length > 1) {
        paroleNegative.push(parola.substring(1));
      } else if (parola.startsWith('-') && parola.length === 1) {
        return;
      } else {
        parolePositive.push(parola);
      }
    });
    
    eventiFiltrati = eventi.filter(evento => {
      const testoCompleto = [
        evento.Nominativo,
        evento.Tipo,
        evento.Data
      ].filter(t => t).join(' ').toLowerCase();
      
      const contienePositive = parolePositive.length === 0 || 
                              parolePositive.every(parola => testoCompleto.includes(parola));
      
      const nonContieneNegative = paroleNegative.length === 0 || 
                                 paroleNegative.every(parola => !testoCompleto.includes(parola));
      
      return contienePositive && nonContieneNegative;
    });
    
    contatore.textContent = `${eventiFiltrati.length}/${eventi.length}`;
    btnCancella.style.display = 'flex';
  } else {
    contatore.textContent = `${eventi.length}/${eventi.length}`;
    btnCancella.style.display = 'none';
  }
  
  // Determina il numero di giorni del prossimo evento tra quelli filtrati
  const giorniProssimoEvento = eventiFiltrati.length > 0 ? eventiFiltrati[0].giorni : -1;
  
  // Crea gli elementi li con la logica corretta dei badge
  const elementiLi = eventiFiltrati.map(evento => {
    const li = creaElementoEvento(evento);
    
    // Applica la logica del badge
    const badgeElement = li.querySelector('.giorni-badge');
    if (badgeElement && !badgeElement.classList.contains('oggi')) {
      if (evento.giorni === giorniProssimoEvento && giorniProssimoEvento > 0) {
        // Questo è uno dei prossimi eventi - mostra il badge
        badgeElement.style.display = 'block';
      } else {
        // Non è il prossimo evento - nascondi il badge
        badgeElement.style.display = 'none';
      }
    }
    
    return li;
  });
  
  // Pulisce la lista
  lista.innerHTML = '';
  
  if (elementiLi.length === 0) {
    messaggioFine.style.display = 'block';
    messaggioFine.textContent = 'Nessun evento trovato.';
    return;
  } else {
    messaggioFine.style.display = 'none';
  }
  
  // Raggruppa eventi per anno
  const eventiPerAnno = {};
  elementiLi.forEach(li => {
    // Estrae l'anno dall'elemento li
    const annoMatch = li.innerHTML.match(/(\d{4})/);
    const anno = annoMatch ? annoMatch[1] : 'Sconosciuto';
    
    if (!eventiPerAnno[anno]) {
      eventiPerAnno[anno] = [];
    }
    eventiPerAnno[anno].push(li);
  });
  
  // Ordina gli anni
  const anniOrdinati = Object.keys(eventiPerAnno).sort();
  
  // Aggiunge eventi raggruppati per anno con barre divisorie
  anniOrdinati.forEach((anno, index) => {
    // Aggiunge la barra divisoria dell'anno
    const barra = creaBarraAnno(anno);
    lista.appendChild(barra);
    
    // Aggiunge tutti gli eventi di questo anno mantenendo il layout originale
    eventiPerAnno[anno].forEach(li => {
      lista.appendChild(li);
    });
  });
}

function cancellaCerca() {
  const input = document.getElementById('searchInput');
  input.value = '';
  document.getElementById('clear-search-button').style.display = 'none';
  
  if (modalitaDatario) {
    mostraDatario(); // Ricarica il datario senza filtri
  } else {
    const eventiOrdinati = ordinaEventi(tuttiGliEventi);
    mostraEventi(eventiOrdinati, '');
  }
}

function clickEvento(nome) {
  console.log("Click su evento:", nome);
}

function cambiaData() {
  if (isMobile) return;
  
  const dataStr = prompt(
    "Inserisci la data nel formato DD/MM/YYYY:",
    dataPersonalizzata ? 
      `${dataPersonalizzata.getDate().toString().padStart(2, '0')}/${(dataPersonalizzata.getMonth() + 1).toString().padStart(2, '0')}/${dataPersonalizzata.getFullYear()}` :
      new Date().toLocaleDateString('it-IT')
  );
  
  if (dataStr === null) return;
  
  const parti = dataStr.split("/").map(n => parseInt(n.trim()));
  if (parti.length !== 3 || parti[0] < 1 || parti[0] > 31 || parti[1] < 1 || parti[1] > 12 || parti[2] < 1900 || parti[2] > 2100) {
    alert("Data non valida! Usa il formato DD/MM/YYYY");
    return;
  }
  
  dataPersonalizzata = new Date(parti[2], parti[1] - 1, parti[0]);
  document.getElementById('reset-data').style.display = 'block';
  
  aggiornaData();
  if (modalitaDatario) {
    mostraDatario();
  } else {
    const eventiOrdinati = ordinaEventi(tuttiGliEventi);
    const termineRicerca = document.getElementById('searchInput').value;
    mostraEventi(eventiOrdinati, termineRicerca);
  }
}

function resetData() {
  if (isMobile) return;
  
  dataPersonalizzata = null;
  document.getElementById('reset-data').style.display = 'none';
  
  aggiornaData();
  if (modalitaDatario) {
    mostraDatario();
  } else {
    const eventiOrdinati = ordinaEventi(tuttiGliEventi);
    const termineRicerca = document.getElementById('searchInput').value;
    mostraEventi(eventiOrdinati, termineRicerca);
  }
}

function mostraPopupInfo() {
  document.getElementById('bookmarkPopup').style.display = 'flex';
}

function nascondiPopupInfo() {
  document.getElementById('bookmarkPopup').style.display = 'none';
}

function mostraAlbero() {
  document.getElementById('treePopup').style.display = 'flex';
  caricaAlbero();
}

function nascondiAlbero() {
  document.getElementById('treePopup').style.display = 'none';
}

function caricaAlbero() {
  const contenuto = document.getElementById('treeContent');
  contenuto.textContent = `Luigi Pricci (1933)
│Teresa Grilletti (1937)
│
├── Angela Pricci (1957)
│   │Onofrio Lorusso (1951)
│   │
│   ├── Benny Lorusso (1975)
│   │   │Genny Lepore (1975)
│   │   │
│   │   ├── Alessandro Lorusso (2010)
│   │   ├── Alice Lorusso (2013)
│   │   └── Nina Lorusso (2015)
│   │
│   └── Cinzia Lorusso (1980)
│       │Gianni Rotondi (1974)
│       │
│       └── Nicoletta Rotondi (2019)
│
├── Maria Antonietta Pricci (1958)
│   │Saverio Chiarappa (1951)
│   │
│   ├── Martino Chiarappa (1997)
│   └── Cristiano Chiarappa (2001)
│
├── Marica Pricci (1961)
│   │Nino Mazzarisi (1957)
│   │
│   ├── Maria Grazia Mazzarisi (1989)
│   ├── Onofrio Mazzarisi (1992)
│   └── Teresa Mazzarisi (1994)
│
├── Vanna Pricci (1963)
│   │Domenico Lefemine (1957)
│   │
│   ├── Flavia Lefemine (1996)
│   └── Francesco Lefemine (2000)
│
├── Giovanni Pricci (1964)
│   │Rosa Bianco (1971)
│
├── Giuseppe Pricci (1968)
│   │Anna Trivisani (1969)
│   │
│   ├── Gilda Pricci (2004)
│   └── Asia Pricci (2006)
│
└── Tiziana Pricci (1972)
    │Riccardo Dalena (1973)
`;
}

function mostraConferma() {
  const box = document.getElementById('copyConfirmation');
  box.classList.remove('fade-out');
  box.classList.add('fade-in');
  setTimeout(() => {
    box.classList.remove('fade-in');
    box.classList.add('fade-out');
  }, 1500);
}

function copiaAlbero() {
  const contenuto = document.getElementById('treeContent');
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(contenuto.textContent).then(() => {
      mostraConferma();
    }).catch(err => {
      console.error("Errore copia:", err);
      alert("Impossibile copiare. Seleziona e copia manualmente.");
    });
  } else {
    const range = document.createRange();
    range.selectNode(contenuto);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    try {
      document.execCommand('copy');
      mostraConferma();
    } catch (err) {
      console.error("Errore copia fallback:", err);
      alert("Impossibile copiare. Seleziona e copia manualmente.");
    }
    window.getSelection().removeAllRanges();
  }
}

// ===== INIZIALIZZAZIONE =====
function inizializza() {
  try {
    tuttiGliEventi = [...eventiData];
    
    aggiornaData();
    document.getElementById('searchInput').value = '';
    document.getElementById('clear-search-button').style.display = 'none';
    
    const eventiOrdinati = ordinaEventi(tuttiGliEventi);
    mostraEventi(eventiOrdinati, '');
    
    // Event listeners
    if (!isMobile) {
      document.getElementById('titolo').addEventListener('click', cambiaData);
      document.addEventListener('keydown', e => {
        if (e.key === 'F2') {
          e.preventDefault();
          cambiaData();
        }
      });
      document.getElementById('cambia-data').addEventListener('click', cambiaData);
      document.getElementById('reset-data').addEventListener('click', resetData);
      document.querySelector('.pulsanti-data').style.display = 'block';
      document.getElementById('cambia-data').style.display = 'block';
    } else {
      document.getElementById('titolo').style.cursor = 'default';
    }
    
    document.getElementById('searchInput').addEventListener('input', e => {
      if (modalitaDatario) {
        mostraDatario(); // Ricarica il datario con il nuovo filtro
      } else {
        const eventiOrdinati = ordinaEventi(tuttiGliEventi);
        mostraEventi(eventiOrdinati, e.target.value);
      }
    });
    
    document.getElementById('clear-search-button').addEventListener('click', cancellaCerca);
    document.getElementById('bookmark-close-button').addEventListener('click', nascondiPopupInfo);
    document.getElementById('info-icon').addEventListener('click', mostraPopupInfo);
    document.getElementById('tree-close-button').addEventListener('click', nascondiAlbero);
    document.getElementById('tree-icon').addEventListener('click', mostraAlbero);
    document.getElementById('tree-copy-button').addEventListener('click', copiaAlbero);
    document.getElementById('datario-icon').addEventListener('click', toggleDatario);
    
  } catch (error) {
    console.error("Errore inizializzazione:", error);
  }
}

// Avvia l'applicazione
inizializza();
</script>

</body>
</html>