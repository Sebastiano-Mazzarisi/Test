<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Gestione Contatori JoyFit</title>

<style>
:root{
  --ink:#0f172a;
  --bg:#e9edf5;
  --blue:#2563eb;
  --dark-blue:#1F497D;
  --rad:12px;
  --danger:#dc2626;
}
*{box-sizing:border-box}

body{
  margin:0;
  padding:10px;
  font-family:'Segoe UI',sans-serif;
  background:var(--bg);
  color:var(--ink);
  font-size:22px;
  display:flex;
  justify-content:center;
}

.box{
  background:#fff;
  border-radius:var(--rad);
  padding:15px;
  width:100%;
  max-width:600px;
  box-shadow:0 4px 15px rgba(0,0,0,.1);
}

h1{
  text-align:center;
  color:var(--dark-blue);
  margin:5px 0 10px;
  font-size:1.4em;
  text-transform:uppercase;
}

.total-header{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:15px;
  border-bottom:1px solid #eee;
  padding-bottom:10px;
  margin-bottom:15px;
  font-size:.9em;
}

.total-header span{
  font-weight:700;
  color:var(--blue);
  font-size:1.2em;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:4px 6px;
  border-bottom:1px solid #eee;
  vertical-align:middle;
}

th{
  background:#f8fafc;
  font-size:.7em;
  text-transform:uppercase;
}

/* COLONNE FINALI */
th:nth-child(1), td:nth-child(1){ width:48%; }   /* EVENTO */
th:nth-child(2), td:nth-child(2){ width:35%; text-align:right; } /* CONTEGGIO */
th:nth-child(3), td:nth-child(3){ width:17%; text-align:center; } /* RESET */

.num{
  font-weight:700;
  color:var(--blue);
}

.row-active{ background:#fffce7 }
.row-audio{ background:#e6f2ff }

.btn-reset{
  width:100%;
  font-weight:700;
  border:2px solid var(--danger);
  color:var(--danger);
  background:#fff;
  border-radius:6px;
  cursor:pointer;
  padding:2px 0;
}

.btn-reset:hover{
  background:var(--danger);
  color:#fff;
}

.btn-reset-all{
  padding:4px 12px;
  font-weight:700;
  border-radius:8px;
  border:2px solid var(--danger);
  color:var(--danger);
  background:#fff;
  cursor:pointer;
}

.btn-reset-all:hover{
  background:var(--danger);
  color:#fff;
}
</style>
</head>

<body>
<div class="box">
  <h1>ðŸ“Š Contatori JoyFit</h1>

  <div class="total-header">
    Totale eventi:
    <span id="grandTotal">0</span>
    <button class="btn-reset-all" onclick="resetAll()">RESET TUTTO</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Evento</th>
        <th>Conteggio</th>
        <th>Reset</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* === REFRESH AUTOMATICO UNA SOLA VOLTA === */
if (!sessionStorage.getItem("jf_contatori_refreshed")) {
  sessionStorage.setItem("jf_contatori_refreshed", "1");
  location.reload(true);
}

/* === CONTATORI === */
const BASE_URL = "https://countapi.mileshilliard.com/api/v1";
const NAMESPACE = "joyfit-stats-v1";

const EVENTS = [
  { key:"tab_0",  name:"T.0 - Sintesi" },
  { key:"tab_1",  name:"T.1 - Riepilogo Incassi" },
  { key:"tab_2",  name:"T.2 - Contanti" },
  { key:"tab_3",  name:"T.3 - POS" },
  { key:"tab_4",  name:"T.4 - Entrate X" },
  { key:"tab_5",  name:"T.5 - Clienti" },
  { key:"tab_6",  name:"T.6 - Spesa Media" },
  { key:"tab_7",  name:"T.7 - Orari" },
  { key:"tab_8",  name:"T.8 - Giorni" },
  { key:"tab_9",  name:"T.9 - AttivitÃ " },
  { key:"tab_10", name:"T.10 - Clienti Top 100" },
  { key:"tab_11", name:"T.11 - Clienti Attesi" },
  { key:"tab_12", name:"T.12 - Clienti da Chiamare" },
  { key:"tab_13", name:"T.13 - FedeltÃ " },

  { key:"home",               name:"ðŸ  Home" },
  { key:"icon_riepilogo_pdf", name:"ðŸ“ Riepilogo PDF" },
  { key:"icon_calendari",     name:"ðŸ“… Calendari" },
  { key:"icon_video_sintesi", name:"ðŸ“¹ Video Sintesi" },
  { key:"audio_sintesi",      name:"ðŸ”Š Audio Sintesi", audio:true }
];

let lastSnapshot = {};

async function getVal(key){
  try{
    const r = await fetch(`${BASE_URL}/get/${NAMESPACE}_${key}`);
    const j = await r.json();
    return j.value || 0;
  }catch{
    return 0;
  }
}

async function resetKey(key){
  if(!confirm("Azzerare questo contatore?")) return;
  await fetch(`${BASE_URL}/set/${NAMESPACE}_${key}?value=0`);
  lastSnapshot = {};
  load();
}

async function resetAll(){
  if(!confirm("AZZERARE TUTTI I CONTATORI?")) return;
  await Promise.all(EVENTS.map(e =>
    fetch(`${BASE_URL}/set/${NAMESPACE}_${e.key}?value=0`)
  ));
  lastSnapshot = {};
  load();
}

function redraw(snapshot, total){
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  for(const e of EVENTS){
    const v = snapshot[e.key];
    const tr = document.createElement("tr");

    if(v > 0) tr.classList.add("row-active");
    if(e.audio) tr.classList.add("row-audio");

    tr.innerHTML = `
      <td>${e.name}</td>
      <td class="num">${v}</td>
      <td><button class="btn-reset" onclick="resetKey('${e.key}')">X</button></td>
    `;
    tb.appendChild(tr);
  }

  document.getElementById("grandTotal").innerText =
    total.toLocaleString("it-IT");
}

async function load(){
  let snapshot = {};
  let total = 0;
  let changed = false;

  for(const e of EVENTS){
    const v = await getVal(e.key);
    snapshot[e.key] = v;
    total += v;
    if(lastSnapshot[e.key] !== v) changed = true;
  }

  if(!changed && Object.keys(lastSnapshot).length > 0) return;

  lastSnapshot = snapshot;
  redraw(snapshot, total);
}

load();
setInterval(load, 3000);
</script>
</body>
</html>
