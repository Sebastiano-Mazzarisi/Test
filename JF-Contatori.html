<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoraggio Accessi</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f4f6f9; font-family:Segoe UI, Tahoma, sans-serif; }
  .header { background:#2c3e50; color:white; padding:24px; text-align:center; border-radius:0 0 16px 16px; margin-bottom:26px; }
  .card-counter { background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.08); padding:18px; height:96px; position:relative; }
  .count-name { color:#7f8c8d; font-weight:600; font-size:15px; }
  .count-value { position:absolute; right:18px; top:18px; font-size:34px; font-weight:800; }
  .b-green{border-left:5px solid #28a745;} .b-yellow{border-left:5px solid #ffc107;}
  .b-red{border-left:5px solid #dc3545;} .b-blue{border-left:5px solid #007bff;}
  .refresh-btn{position:fixed; bottom:18px; right:18px; width:60px; height:60px; border-radius:50%; font-size:24px;}
  .small{opacity:.85; font-size:12px;}
</style>
</head>

<body>
<div class="header">
  <h1 class="mb-1">ðŸ“Š Monitoraggio Accessi</h1>
  <div id="status" class="small">Caricamentoâ€¦</div>
</div>

<div class="container mb-5">
  <h5 class="text-muted mb-3">Azioni & Download</h5>
  <div class="row mb-4">
    <div class="col-md-3 mb-3"><div class="card-counter b-green"><div class="count-name">PDF Sintesi</div><div class="count-value" id="pdf_sintesi">â€”</div></div></div>
    <div class="col-md-3 mb-3"><div class="card-counter b-yellow"><div class="count-name">PDF Calendari</div><div class="count-value" id="pdf_calendari">â€”</div></div></div>
    <div class="col-md-3 mb-3"><div class="card-counter b-red"><div class="count-name">Video Sintesi</div><div class="count-value" id="video_sintesi">â€”</div></div></div>
    <div class="col-md-3 mb-3"><div class="card-counter b-red"><div class="count-name">Audio Sintesi</div><div class="count-value" id="audio_sintesi">â€”</div></div></div>
  </div>

  <h5 class="text-muted mb-3">Visualizzazioni Tabelle</h5>
  <div class="row" id="tables"></div>
</div>

<button class="btn btn-primary refresh-btn" onclick="loadCounters()">â†»</button>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<script>
/* ========= 1) INCOLLA QUI LA TUA firebaseConfig ========= */
const firebaseConfig = {
  // apiKey: "...",
  // authDomain: "...",
  // databaseURL: "https://<PROJECT>.firebaseio.com",
  // projectId: "...",
  // storageBucket: "...",
  // messagingSenderId: "...",
  // appId: "..."
};
/* ======================================================= */

const TABLE_NAMES = [
  "0. Sintesi","1. Riepilogo Incassi","2. Contanti","3. POS",
  "4. Entrate X","5. Clienti","6. Spesa Media","7. Orari",
  "8. Giorni","9. AttivitÃ ","10. Top 100","11. Clienti Attesi",
  "12. Da Chiamare"
];

const KEYS = [
  "pdf_sintesi","pdf_calendari","video_sintesi","audio_sintesi",
  ...Array.from({length:13}, (_,i)=>`tab_${i}`)
];

function buildUI(){
  const c = document.getElementById("tables");
  TABLE_NAMES.forEach((name,i)=>{
    c.innerHTML += `
      <div class="col-md-3 mb-3">
        <div class="card-counter b-blue">
          <div class="count-name">${name}</div>
          <div class="count-value" id="tab_${i}">â€”</div>
        </div>
      </div>`;
  });
}

let db = null;

function setStatus(msg){ document.getElementById("status").innerText = msg; }

function ensureFirebase(){
  if (!firebaseConfig || !firebaseConfig.databaseURL) {
    setStatus("ERRORE: manca firebaseConfig (databaseURL).");
    return false;
  }
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  return true;
}

async function loadCounters(){
  if (!ensureFirebase()) return;

  try{
    setStatus("Aggiornamentoâ€¦");
    const snap = await db.ref("counters").get();
    const data = snap.exists() ? snap.val() : {};

    // default 0 se non câ€™Ã¨
    for (const k of KEYS){
      const el = document.getElementById(k);
      if (el) el.innerText = (data && typeof data[k] === "number") ? data[k] : 0;
    }
    setStatus("Aggiornato: " + new Date().toLocaleTimeString());
  } catch (e){
    setStatus("Errore lettura contatori (regole DB?)");
  }
}

buildUI();
loadCounters();
setInterval(loadCounters, 30000);
</script>
</body>
</html>
