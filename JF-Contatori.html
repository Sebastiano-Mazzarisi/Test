<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Contatori</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background-color:#f4f6f9; font-family:'Segoe UI',Tahoma; }
.header { background:#2c3e50; color:white; padding:20px; text-align:center; margin-bottom:30px; border-radius:0 0 15px 15px; }
.card-counter { box-shadow:2px 2px 10px #DADADA; margin:5px; padding:20px 10px; background:#fff; height:100px; border-radius:5px; position:relative; }
.count-numbers { position:absolute; right:30px; top:20px; font-size:32px; font-weight:bold; }
.count-name { position:absolute; left:15px; top:35px; font-size:16px; font-weight:600; color:#7f8c8d; }
.border-left-primary { border-left:5px solid #007bff; }
.border-left-success { border-left:5px solid #28a745; }
.border-left-danger { border-left:5px solid #dc3545; }
.border-left-warning { border-left:5px solid #ffc107; }
.refresh-btn { position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; font-size:24px; }
.small-note { font-size:12px; opacity:0.85; }
</style>
</head>

<body>

<div class="header">
  <h1>ðŸ“Š Monitoraggio Accessi</h1>
  <p id="status-msg" class="mb-1">In attesaâ€¦</p>
  <div id="err-msg" class="small-note"></div>
</div>

<div class="container mb-5">

  <h4 class="mb-3 text-muted">Azioni & Download</h4>
  <div class="row mb-4">
    <div class="col-md-3"><div class="card-counter border-left-success"><span class="count-name">PDF Sintesi</span><span class="count-numbers" id="val_pdf_sintesi">â€¦</span></div></div>
    <div class="col-md-3"><div class="card-counter border-left-warning"><span class="count-name">PDF Calendari</span><span class="count-numbers" id="val_pdf_calendari">â€¦</span></div></div>
    <div class="col-md-3"><div class="card-counter border-left-danger"><span class="count-name">Video Sintesi</span><span class="count-numbers" id="val_video_sintesi">â€¦</span></div></div>
    <div class="col-md-3"><div class="card-counter border-left-danger"><span class="count-name">Audio Sintesi</span><span class="count-numbers" id="val_audio_sintesi">â€¦</span></div></div>
  </div>

  <h4 class="mb-3 text-muted">Visualizzazioni Tabelle</h4>
  <div class="row" id="tables-container"></div>

</div>

<button class="btn btn-primary refresh-btn" onclick="fetchAll()">â†»</button>

<script>
const NAMESPACE = "Seba_Test";
const BASE_URL = "https://api.countapi.xyz";

const BASE_METRICS = [
  { key:'pdf_sintesi', id:'val_pdf_sintesi' },
  { key:'pdf_calendari', id:'val_pdf_calendari' },
  { key:'video_sintesi', id:'val_video_sintesi' },
  { key:'audio_sintesi', id:'val_audio_sintesi' }
];

const TABLE_NAMES = [
  "0. Sintesi","1. Riepilogo Incassi","2. Contanti","3. POS",
  "4. Entrate X","5. Clienti","6. Spesa Media","7. Orari",
  "8. Giorni","9. AttivitÃ ","10. Top 100","11. Clienti Attesi",
  "12. Da Chiamare"
];

const METRICS = [...BASE_METRICS];

function initGrid(){
  const c = document.getElementById('tables-container');
  TABLE_NAMES.forEach((n,i)=>{
    c.innerHTML += `
      <div class="col-md-3 mb-3">
        <div class="card-counter border-left-primary">
          <span class="count-name">${n}</span>
          <span class="count-numbers" id="val_tab_${i}">â€¦</span>
        </div>
      </div>`;
    METRICS.push({ key:`tab_${i}`, id:`val_tab_${i}` });
  });
}

function setStatus(msg, err=""){
  document.getElementById("status-msg").innerText = msg;
  document.getElementById("err-msg").innerText = err;
}

async function apiGet(key){
  // /get Ã¨ piÃ¹ adatto per leggere il valore
  const r = await fetch(`${BASE_URL}/get/${NAMESPACE}/${key}`);
  if (!r.ok) return { ok:false, status:r.status, json:null };
  const j = await r.json();
  return { ok:true, status:r.status, json:j };
}

async function apiCreate(key){
  // crea con valore 0 se non esiste
  const r = await fetch(`${BASE_URL}/create?namespace=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(key)}&value=0`);
  if (!r.ok) return { ok:false, status:r.status };
  return { ok:true, status:r.status };
}

async function fetchValue(key,id){
  const el = document.getElementById(id);

  try{
    let g = await apiGet(key);

    // se non esiste, proviamo a crearlo e rileggerlo
    if (!g.ok && (g.status === 404 || g.status === 400)){
      const c = await apiCreate(key);
      if (c.ok){
        g = await apiGet(key);
      }
    }

    if (g.ok && g.json && typeof g.json.value !== "undefined"){
      el.innerText = g.json.value;
      return { ok:true };
    } else {
      el.innerText = "0";
      return { ok:false, reason:`HTTP ${g.status}` };
    }

  }catch(err){
    el.innerHTML = "<span style='font-size:14px;color:red'>Err</span>";
    return { ok:false, reason:String(err) };
  }
}

async function fetchAll(){
  setStatus("Aggiornamentoâ€¦", "");
  const results = await Promise.all(METRICS.map(m => fetchValue(m.key, m.id)));

  const errors = results.filter(r => !r.ok);
  if (errors.length){
    // se hai aperto in file:// qui quasi sempre Ã¨ CORS/origin null
    const hint = location.protocol === "file:"
      ? "Stai aprendo da file://. Prova con http://localhost (python -m http.server)."
      : "Possibile blocco rete/estensione (adblock) o CORS.";

    setStatus("Aggiornato con errori: " + new Date().toLocaleTimeString(),
              `${errors.length} errori. ${hint}`);
  } else {
    setStatus("Aggiornato: " + new Date().toLocaleTimeString(), "");
  }
}

initGrid();
fetchAll();
setInterval(fetchAll, 30000);
</script>

</body>
</html>
