name: Diagnostica Connessione ntfy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  debug-network:
    runs-on: ubuntu-latest
    name: Debug connettività di rete
    
    steps:
    - name: Test connettività di base verso siti noti
      run: |
        echo "=== Test risoluzione DNS per ntfy.sh ==="
        nslookup ntfy.sh
        echo "=== Test curl verso endpoint di controllo (Google) ==="
        curl -I -s -o /dev/null -w "google.com: Status %{http_code}\n" https://www.google.com

    - name: Test diagnostico approfondito verso ntfy.sh
      run: |
        echo "=== Test curl verboso verso ntfy.sh ==="
        curl -v --connect-timeout 15 https://ntfy.sh 2>&1 || echo "ERRORE: curl verboso verso ntfy.sh fallito"

  test-ntfy-notifications:
    runs-on: ubuntu-latest
    name: Test invio notifiche ntfy con vari metodi
    needs: debug-network
    if: always() # Esegui anche se il job precedente fallisce
    
    steps:
    - name: Test notifica ntfy - Metodo 1 (curl diretto)
      env:
        NTFY_TOPIC: ${{ secrets.NTFY_TOPIC || 'msgalternativo' }}
      run: |
        echo "Tentativo con curl diretto al topic: $NTFY_TOPIC"
        curl -d "Test (Metodo 1) da GitHub Actions" \
          -H "Title: GitHub Actions Test (curl)" \
          https://ntfy.sh/$NTFY_TOPIC || echo "FALLITO: curl diretto"
    
    - name: Test notifica ntfy - Metodo 2 (Node.js fetch)
      env:
        NTFY_TOPIC: ${{ secrets.NTFY_TOPIC || 'msgalternativo' }}
      run: |
        echo "Tentativo con Node.js fetch al topic: $NTFY_TOPIC"
        node -e "
          const https = require('https');
          const message = 'Test (Metodo 2) da Node.js';
          const options = {
            hostname: 'ntfy.sh',
            port: 443,
            path: '/' + process.env.NTFY_TOPIC,
            method: 'POST',
            headers: { 'Title': 'GitHub Actions Test (Node.js)' }
          };
          const req = https.request(options, res => {
            console.log('Node.js test - Status:', res.statusCode);
            res.on('data', d => process.stdout.write(d));
          });
          req.on('error', e => console.error('ERRORE Node.js:', e));
          req.write(message);
          req.end();
        " || echo "FALLITO: Node.js fetch"

  final-report:
    runs-on: ubuntu-latest
    name: Report finale dei test
    needs: [debug-network, test-ntfy-notifications]
    if: always()
    
    steps:
    - name: Stampa riepilogo
      run: |
        echo "=== RIEPILOGO TEST DIAGNOSTICO ==="
        echo "Timestamp: $(date)"
        echo "Questo test ha verificato la connettività di base e ha provato a inviare una notifica a ntfy in due modi diversi (curl e Node.js)."
        echo "Se i test di connettività di base funzionano ma i test di notifica falliscono, il problema è specifico della comunicazione con ntfy."
