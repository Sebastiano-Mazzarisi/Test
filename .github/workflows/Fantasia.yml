name: Aggiorna Menù Fantasia

on:
  schedule:
    # Esegui alle 8:00, 9:00, e 10:00 UTC (10:00, 11:00, 12:00 ora italiana)
    - cron: '0 8 * * *'
    - cron: '0 9 * * *'
    - cron: '0 10 * * *'
  
  # Permetti esecuzione manuale
  workflow_dispatch:

jobs:
  update-menu:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout del repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: 🐍 Configurazione di Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: 📦 Installazione delle dipendenze Python
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests pytz
      
      - name: 🎭 Installazione browser Playwright
        run: |
          playwright install chromium
          playwright install-deps
      
      - name: 🔍 Verifica file necessari
        run: |
          echo "📁 Contenuto directory corrente:"
          ls -la
          echo ""
          echo "🍪 Verifica file cookies:"
          if [ -f "cookies.txt" ]; then
            echo "✅ File cookies.txt trovato"
            echo "📊 Dimensione file: $(wc -c < cookies.txt) bytes"
            echo "📄 Prime 3 righe (senza dati sensibili):"
            head -3 cookies.txt | sed 's/[^\t]*$/***HIDDEN***/g'
          else
            echo "❌ File cookies.txt NON trovato!"
            exit 1
          fi
          echo ""
          echo "🐍 Verifica script Python:"
          if [ -f "Fantasia.py" ]; then
            echo "✅ File Fantasia.py trovato"
          else
            echo "❌ File Fantasia.py NON trovato!"
            exit 1
          fi
      
      - name: 🍽️ Esecuzione dello script di estrazione menù
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          echo "🚀 Avvio estrazione menù..."
          python Fantasia.py
          echo ""
          echo "📁 File generati:"
          ls -la *.html *.jpg *.log 2>/dev/null || echo "Nessun file generato"
      
      - name: 📋 Verifica file generati
        run: |
          echo "🔍 Controllo file generati..."
          if [ -f "Fantasia.html" ]; then
            echo "✅ File HTML generato con successo"
            echo "📊 Dimensione: $(wc -c < Fantasia.html) bytes"
          else
            echo "⚠️ File HTML non trovato"
          fi
          
          if ls menu_*.jpg 1> /dev/null 2>&1; then
            echo "✅ Immagine menù scaricata:"
            ls -la menu_*.jpg
          else
            echo "⚠️ Nessuna immagine trovata"
          fi
          
          if [ -f "menu_extractor.log" ]; then
            echo ""
            echo "📝 Log dell'esecuzione (ultime 20 righe):"
            tail -20 menu_extractor.log
          fi
      
      - name: 🗂️ Prepara file per commit (SENZA PUSH per ora)
        run: |
          echo "📁 File generati:"
          ls -la *.html *.jpg *.log 2>/dev/null || echo "Alcuni file potrebbero non essere stati generati"
          
          echo ""
          echo "🔍 Contenuto HTML generato:"
          if [ -f "Fantasia.html" ]; then
            echo "✅ Fantasia.html trovato!"
            head -10 Fantasia.html
          fi
          
          echo ""
          echo "📸 Immagini generate:"
          if ls menu_*.jpg 1> /dev/null 2>&1; then
            ls -la menu_*.jpg
          fi
          
          echo ""
          echo "⚠️ NOTA: Push Git temporaneamente disabilitato per debug"
        
      - name: 📊 Riepilogo finale
        if: always()
        run: |
          echo "📈 RIEPILOGO ESECUZIONE:"
          echo "========================"
          echo "⏰ Timestamp: $(date)"
          echo "🔧 Job Status: ${{ job.status }}"
          if [ -f "menu_extractor.log" ]; then
            echo "📝 Controlla il file 'menu_extractor.log' per dettagli completi"
          fi
          echo "========================"