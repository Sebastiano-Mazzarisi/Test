name: Aggiorna MenÃ¹ Fantasia

# Permessi espliciti per il token
permissions:
  contents: write
  actions: read

on:
  schedule:
    # Esegui alle 8:00, 9:00, e 10:00 UTC (10:00, 11:00, 12:00 ora italiana)
    - cron: '0 8 * * *'
    - cron: '0 9 * * *'
    - cron: '0 10 * * *'
  
  # Permetti esecuzione manuale
  workflow_dispatch:

jobs:
  update-menu:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ Configurazione di Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Installazione delle dipendenze Python
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests pytz
      
      - name: ğŸ­ Installazione browser Playwright
        run: |
          playwright install chromium
          playwright install-deps
      
      - name: ğŸ” Verifica file necessari
        run: |
          echo "ğŸ“ Contenuto directory corrente:"
          ls -la
          echo ""
          echo "ğŸª Verifica file cookies:"
          if [ -f "cookies.txt" ]; then
            echo "âœ… File cookies.txt trovato"
            echo "ğŸ“Š Dimensione file: $(wc -c < cookies.txt) bytes"
            echo "ğŸ“„ Prime 3 righe (senza dati sensibili):"
            head -3 cookies.txt | sed 's/[^\t]*$/***HIDDEN***/g'
          else
            echo "âŒ File cookies.txt NON trovato!"
            exit 1
          fi
          echo ""
          echo "ğŸ Verifica script Python:"
          if [ -f "Fantasia.py" ]; then
            echo "âœ… File Fantasia.py trovato"
          else
            echo "âŒ File Fantasia.py NON trovato!"
            exit 1
          fi
      
      - name: ğŸ½ï¸ Esecuzione dello script di estrazione menÃ¹
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          echo "ğŸš€ Avvio estrazione menÃ¹..."
          python Fantasia.py
          echo ""
          echo "ğŸ“ File generati:"
          ls -la *.html *.jpg *.log 2>/dev/null || echo "Nessun file generato"
      
      - name: ğŸ“‹ Verifica file generati
        run: |
          echo "ğŸ” Controllo file generati..."
          if [ -f "Fantasia.html" ]; then
            echo "âœ… File HTML generato con successo"
            echo "ğŸ“Š Dimensione: $(wc -c < Fantasia.html) bytes"
          else
            echo "âš ï¸ File HTML non trovato"
          fi
          
          if ls menu_*.jpg 1> /dev/null 2>&1; then
            echo "âœ… Immagine menÃ¹ scaricata:"
            ls -la menu_*.jpg
          else
            echo "âš ï¸ Nessuna immagine trovata"
          fi
          
          if [ -f "menu_extractor.log" ]; then
            echo ""
            echo "ğŸ“ Log dell'esecuzione (ultime 20 righe):"
            tail -20 menu_extractor.log
          fi
      
      - name: ğŸ—‚ï¸ Commit e push dei file aggiornati
        run: |
          # Configura Git con token esplicito
          git config --local user.email "actions@github.com"
          git config --local user.name "Fantasia Bot"
          
          # Aggiungi tutti i file generati
          git add Fantasia.html menu_*.jpg menu_extractor.log
          
          # Controlla se ci sono modifiche
          if git diff --staged --quiet; then
            echo "ğŸ“ Nessuna modifica da committare"
          else
            echo "ğŸ“ Commit delle modifiche..."
            git commit -m "ğŸ½ï¸ Aggiorna menÃ¹ Fantasia - $(date +'%d/%m/%Y %H:%M')"
            echo "ğŸ“¤ Push in corso..."
            git push
            echo "âœ… File committati con successo nel repository!"
          fi
        
      - name: ğŸ“Š Riepilogo finale
        if: always()
        run: |
          echo "ğŸ“ˆ RIEPILOGO ESECUZIONE:"
          echo "========================"
          echo "â° Timestamp: $(date)"
          echo "ğŸ”§ Job Status: ${{ job.status }}"
          if [ -f "menu_extractor.log" ]; then
            echo "ğŸ“ Controlla il file 'menu_extractor.log' per dettagli completi"
          fi
          echo "========================"