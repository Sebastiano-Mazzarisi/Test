<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relazioni di Parentela - Famiglia Pricci</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Parenti.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Parenti.png">
    <meta property="og:title" content="Calcolatore di Parentela">
    <meta property="og:description" content="Scopri le relazioni di parentela della famiglia Pricci">
    <meta property="og:image" content="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Parenti.png">
    <meta property="og:url" content="https://sebastiano-mazzarisi.github.io/Test/Parenti.html">
    <meta property="og:type" content="website">
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        :root {
            --primary-blue: #0a3d91;
            --light-blue: #f8faff; 
            --garnet-red: #9D2235; 
            --straw-yellow: #fefce8;
            --light-green-highlight: #f0fff4; 
            --green-border: #a3d9b1;
            --warning-red: #c53030;
            --light-warning-red: rgba(197, 48, 48, 0.1);
            --light-warning-red-pulse: rgba(197, 48, 48, 0.25);
            --background-color: #f0f4f8;
            --text-color: #1c2a38;
            --card-bg: #ffffff;
            --border-color: #d1d9e6;
            --shadow-color: rgba(10, 61, 145, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .hidden { display: none !important; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow-color);
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .header-title-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 {
            color: var(--primary-blue);
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header-icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: var(--primary-blue);
            transition: color 0.2s;
        }
        .header-icon-btn:hover {
            color: #083175;
        }
        .header-icon-btn svg {
             width: 28px;
             height: 28px;
        }


        header p {
            font-size: 1.1rem;
            color: #555;
            margin-top: 5px;
        }

        #results-container {
            position: -webkit-sticky;
            position: sticky;
            top: 10px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background-color: var(--light-blue);
            border: 2px solid var(--primary-blue);
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 30px;
            min-height: 140px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(10, 61, 145, 0.1);
        }
        
        .nav-arrow {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 28px;
            font-weight: bold;
            line-height: 32px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            padding-bottom: 4px;
        }

        .nav-arrow:hover {
            background-color: #083175;
        }

        .photo-navigation-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .photo-display {
            width: 100px;
            height: 100px;
            flex-shrink: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
            transform: scale(0);
            opacity: 0;
            cursor: pointer;
        }
        
        .photo-display.visible {
             transform: scale(1);
             opacity: 1;
        }

        .photo-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--primary-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #results-text-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            min-width: 200px;
        }

        #results-container p {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--text-color); 
            line-height: 1.5; 
            text-align: center;
        }

        #info-button {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        #info-button:hover {
            background-color: #083175;
        }

        .kinship-degree-info, #show-path-btn {
            background-color: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 8px;
            padding: 5px 15px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: block;
            width: fit-content;
            margin: 10px auto 0 auto;
            font-family: inherit;
        }
         #show-path-btn:hover {
            background-color: var(--light-blue);
         }

        #close-photo-info {
            font-size: 0.8rem;
            color: #555;
            margin-top: -5px;
            text-align: center;
        }
        
        #results-container strong { color: var(--primary-blue); }
        .relationship-term { color: var(--garnet-red); font-weight: 700; }
        #results-container p.placeholder { color: #5a7a9e; font-size: 1.2rem; line-height: 1.6; }
        #results-container p.warning { color: var(--warning-red); font-weight: 700; font-size: 1.1rem; line-height: 1.6; }

        #people-grid {
            padding-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
        }

        .person-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: 4px solid var(--border-color);
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px var(--shadow-color);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .person-card.relative-highlight .card-relationship-text {
            color: var(--garnet-red);
        }
        
        .person-card.relative-highlight {
            background-color: var(--light-green-highlight);
            border-color: var(--green-border); 
        }
        
        .person-card.deceased::after {
            content: 'â€ ';
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.2rem;
            color: #888;
        }

        .person-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(10, 61, 145, 0.15);
        }

        .person-card.selected {
            border-color: var(--primary-blue);
            background-color: var(--straw-yellow);
            box-shadow: 0 0 0 4px rgba(10, 61, 145, 0.2);
            transform: scale(1.05);
        }

        .person-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 10px auto;
            object-fit: cover;
            background-color: #e0e0e0;
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #aaa;
        }

        .person-name {
            font-weight: 500;
            font-size: 1rem;
            color: var(--text-color);
            flex-grow: 1;
        }
        
        .card-relationship-text {
            font-size: 0.9rem;
            font-weight: 700;
            font-style: italic;
            color: var(--garnet-red);
            margin-top: 4px;
            height: 1.4rem;
            line-height: 1.4rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 0;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        #tree-modal-overlay .modal-content {
            max-width: 95vw;
            width: 95vw;
            max-height: 95vh;
            height: 95vh;
        }
        #tree-modal-body {
            flex-grow: 1;
            overflow: auto;
            padding: 0;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding: 15px 25px;
            flex-shrink: 0;
        }
        .modal-header h2 {
            color: var(--primary-blue);
            font-size: 1.7rem;
            margin: 0;
            line-height: 1.2;
            padding-top: 5px; 
        }
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        .modal-action-btn,
        .modal-close-btn {
            background: transparent;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 1.6rem;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-action-btn:hover,
        .modal-close-btn:hover {
            background-color: var(--primary-blue);
            color: white;
        }
        .modal-body {
            overflow-y: auto;
            padding: 25px;
        }
        
        .timeline-container {
            position: relative;
            padding-left: 30px; 
        }
        .timeline-container::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 10px;
            bottom: 10px;
            width: 4px;
            background-color: var(--border-color);
            border-radius: 4px;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 5px;
            width: 13px;
            height: 13px;
            background-color: var(--primary-blue);
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        .timeline-content {
            background-color: var(--light-blue);
            padding: 15px;
            border-radius: 8px;
            border: 2.5px solid #7a92b7;
        }

        .timeline-content h3 {
            margin: 0 0 8px 0;
            color: var(--primary-blue);
            font-size: 1.2rem;
        }
        .timeline-content p {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* Stili per la tabella dei compleanni */
        @keyframes flash-red {
            0%, 100% { background-color: var(--light-warning-red); }
            50% { background-color: var(--light-warning-red-pulse); }
        }
        .birthday-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .birthday-table th, .birthday-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .birthday-table th {
            font-weight: 700;
            color: var(--primary-blue);
            background-color: var(--light-blue);
        }
        .birthday-table .month-header td {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 700;
            text-align: center;
            font-size: 1rem;
            padding: 6px;
        }
        .birthday-table .birthday-today {
            animation: flash-red 1.5s infinite ease-in-out;
            font-weight: 700;
        }
        .birthday-table .birthday-completed {
            background-color: var(--light-green-highlight);
        }
        .birthday-table .birthday-upcoming {
            background-color: var(--straw-yellow);
        }

        /* Stili per il modal del percorso di parentela */
        .path-box {
            background-color: var(--light-blue);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
         .path-box p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 0;
         }
        .path-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-blue);
            flex-shrink: 0;
        }
        
        /* Stili per l'albero genealogico */
        .tree-node rect {
            fill: var(--card-bg);
            stroke: var(--primary-blue);
            stroke-width: 2px;
            rx: 8;
        }
        .tree-node.deceased rect {
            stroke-dasharray: 4 2;
            stroke: #888;
        }
        .tree-node text {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            fill: var(--text-color);
            pointer-events: none;
        }
        .tree-link {
            fill: none;
            stroke: var(--text-color);
            stroke-width: 1.5px;
        }
        .marriage-link {
            fill: none;
            stroke: var(--garnet-red);
            stroke-width: 1.5px;
        }


        @keyframes bounce-up-down {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        #install-prompt-ios {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background-color: var(--straw-yellow);
            border-top: 1px solid #e0dcb7;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
            z-index: 1500;
            transition: transform 0.3s ease-in-out;
        }
        #install-prompt-ios.hidden {
            transform: translateY(100%);
        }
        .install-prompt-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            font-size: 1.05rem;
            color: var(--text-color);
        }
        .install-prompt-icon {
            height: 1.5em;
            width: 1.5em;
            vertical-align: middle;
            margin: 0 2px;
        }
        #install-share-icon {
            animation: bounce-up-down 1.5s infinite ease-in-out;
        }
        .install-prompt-close {
            background: transparent;
            border: none;
            font-size: 1.8rem;
            line-height: 1;
            color: #888;
            cursor: pointer;
            padding: 0 5px;
        }

        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            #results-container { 
                top: 5px; 
                padding: 10px; 
                gap: 10px; 
                flex-direction: column;
                min-height: auto;
            }
            #results-container p { font-size: 1.1rem; line-height: 1.5; }
            .photo-display { width: 80px; height: 80px; }
            #people-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }
            .person-photo { width: 70px; height: 70px; }
            .person-name { font-size: 0.85rem; }
            .install-prompt-content {
                flex-direction: column;
                gap: 10px;
                font-size: 0.95rem;
            }
            .install-prompt-close {
                position: absolute;
                top: 5px;
                right: 5px;
            }
        }

        .modal-action-btn svg {
            color: #0a3d91;
            transition: color 0.2s;
        }
        .modal-action-btn:hover svg {
            color: #fff;
        }
    </style>
</head>
<body>

<div id="install-prompt-ios" class="hidden">
    <div class="install-prompt-content">
        <p>
            Per un'esperienza migliore, installa l'app! Tocca
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWFjdGlvbiI+PHBhdGggZD0iTTQgMTJ2OGEyIDIgMCAwIDAgMiAyaDEyYTIgMiAwIDAgMCAyLTJ2LTgiLz48cG9seWxpbmUgcG9pbnRzPSIxNiA2IDEyIDIgOCA2Ii8+PGxpbmUgeDE9IjEyIiB4Mj0iMTIiIHkxPSIyIiB5Mj0iMTUiLz48L3N2Zz4=" alt="Icona Condividi" class="install-prompt-icon" id="install-share-icon">
            e poi "<strong>Aggiungi a schermata Home</strong>"
        </p>
        <button id="install-prompt-close" title="Chiudi">&times;</button>
    </div>
</div>

<div class="container">
    <header>
        <div class="header-title-container">
            <h1>Calcolatore di Parentela</h1>
            <button id="birthday-list-btn" class="header-icon-btn" title="Elenco Cronologico Compleanni">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            </button>
            <button id="tree-view-btn" class="header-icon-btn" title="Albero Genealogico">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 10v.2A3 3 0 0 1 7 13v5H4"/><path d="M14 10v.2A3 3 0 0 0 17 13v5h3"/><path d="M12 10V7a3 3 0 0 0-3-3H7"/><path d="M12 10V7a3 3 0 0 1 3-3h2"/></svg>
            </button>
        </div>
        <p>Seleziona due membri della famiglia Pricci per scoprire la loro relazione.</p>
    </header>

    <section id="results-container" class="hidden">
        <div class="photo-navigation-wrapper">
            <button id="prev-person" class="nav-arrow hidden">â€¹</button>
            <div id="person1-photo-display" class="photo-display"></div>
            <button id="next-person" class="nav-arrow hidden">â€º</button>
        </div>
        <div id="results-text-wrapper">
            <p id="results-text" class="placeholder">In attesa della selezione...</p>
            <button id="info-button" class="hidden">Info</button>
            <small id="close-photo-info" class="hidden">Cliccare sulla foto per chiuderla</small>
        </div>
        <div id="person2-photo-display" class="photo-display"></div>
    </section>

    <main id="people-grid"></main>

    <div id="info-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <div class="modal-actions">
                    <button id="image-button" class="modal-action-btn" title="Salva o Condividi Immagine">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;">
                           <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                           <polyline points="16 6 12 2 8 6"></polyline>
                           <line x1="12" y1="15" x2="12" y2="2"></line>
                        </svg>
                    </button>
                    <button class="modal-close-btn">&times;</button>
                </div>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    
    <div id="birthday-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Elenco cronologico nell'anno</h2>
                 <div class="modal-actions">
                    <button id="birthday-share-btn" class="modal-action-btn" title="Salva o Condividi Elenco">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;">
                           <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                           <polyline points="16 6 12 2 8 6"></polyline>
                           <line x1="12" y1="15" x2="12" y2="2"></line>
                        </svg>
                    </button>
                    <button class="modal-close-btn birthday-modal-close">&times;</button>
                </div>
            </div>
            <div id="birthday-modal-body" class="modal-body"></div>
        </div>
    </div>

    <div id="path-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="path-modal-title">Dettaglio Parentela</h2>
                 <div class="modal-actions">
                    <button id="path-share-btn" class="modal-action-btn" title="Salva o Condividi Percorso">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;">
                           <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                           <polyline points="16 6 12 2 8 6"></polyline>
                           <line x1="12" y1="15" x2="12" y2="2"></line>
                        </svg>
                    </button>
                    <button class="modal-close-btn path-modal-close">&times;</button>
                </div>
            </div>
            <div id="path-modal-body" class="modal-body"></div>
        </div>
    </div>

    <div id="tree-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tree-modal-title">Albero genealogico</h2>
                 <div class="modal-actions">
                    <button class="modal-close-btn tree-modal-close">&times;</button>
                </div>
            </div>
            <div id="tree-modal-body" class="modal-body"></div>
        </div>
    </div>
</div>

    <script>
        const familyData = {
            "Nonno Giovanni Pricci": { birth: "01/01/1909", death: "01/01/1944", spouse: "Angelina Gasparro", children: ["Luigi Pricci"], parents: [], siblings: [], gender: "M" },
            "Angelina Gasparro": { birth: "05/06/1909", death: "16/07/2001", spouse: "Nonno Giovanni Pricci", children: ["Luigi Pricci"], parents: [], siblings: [], gender: "F" },
            "Luigi Pricci": { birth: "16/11/1933", death: null, spouse: "Teresa Grilletti", children: ["Angela Pricci", "Maria Antonietta Pricci", "Marica Pricci", "Vanna Pricci", "Giovanni Pricci", "Giuseppe Pricci", "Tiziana Pricci"], parents: ["Nonno Giovanni Pricci", "Angelina Gasparro"], siblings: [], gender: "M" },
            "Teresa Grilletti": { birth: "05/03/1937", death: null, spouse: "Luigi Pricci", children: ["Angela Pricci", "Maria Antonietta Pricci", "Marica Pricci", "Vanna Pricci", "Giovanni Pricci", "Giuseppe Pricci", "Tiziana Pricci"], parents: [], siblings: [], gender: "F" },
            "Angela Pricci": { birth: "13/01/1957", death: null, spouse: "Onofrio Lorusso", children: ["Benny Lorusso", "Cinzia Lorusso"], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Maria Antonietta Pricci", "Marica Pricci", "Vanna Pricci", "Giovanni Pricci", "Giuseppe Pricci", "Tiziana Pricci"], gender: "F" },
            "Onofrio Lorusso": { birth: "05/08/1951", death: null, spouse: "Angela Pricci", children: ["Benny Lorusso", "Cinzia Lorusso"], parents:[], siblings:[], gender: "M" },
            "Maria Antonietta Pricci": { birth: "21/05/1958", death: null, spouse: "Saverio Chiarappa", children: ["Martino Chiarappa", "Cristiano Chiarappa"], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Angela Pricci", "Marica Pricci", "Vanna Pricci", "Giovanni Pricci", "Giuseppe Pricci", "Tiziana Pricci"], gender: "F" },
            "Saverio Chiarappa": { birth: "26/11/1951", death: null, spouse: "Maria Antonietta Pricci", children: ["Martino Chiarappa", "Cristiano Chiarappa"], parents:[], siblings:[], gender: "M" },
            "Marica Pricci": { birth: "12/04/1961", death: null, spouse: "Sebastiano Mazzarisi", children: ["Maria Grazia Mazzarisi", "Onofrio Mazzarisi", "Teresa Mazzarisi"], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Angela Pricci", "Maria Antonietta Pricci", "Vanna Pricci", "Giovanni Pricci", "Giuseppe Pricci", "Tiziana Pricci"], gender: "F" },
            "Sebastiano Mazzarisi": { birth: "07/05/1957", death: null, spouse: "Marica Pricci", children: ["Maria Grazia Mazzarisi", "Onofrio Mazzarisi", "Teresa Mazzarisi"], parents:[], siblings:[], gender: "M" },
            "Vanna Pricci": { birth: "11/09/1963", death: null, spouse: "Domenico Lefemine", children: ["Flavia Lefemine", "Francesco Lefemine"], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Angela Pricci", "Maria Antonietta Pricci", "Marica Pricci", "Giovanni Pricci", "Giuseppe Pricci", "Tiziana Pricci"], gender: "F" },
            "Domenico Lefemine": { birth: "06/02/1957", death: null, spouse: "Vanna Pricci", children: ["Flavia Lefemine", "Francesco Lefemine"], parents:[], siblings:[], gender: "M" },
            "Giovanni Pricci": { birth: "24/10/1964", death: null, spouse: "Rosa Bianco", children: [], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Angela Pricci", "Maria Antonietta Pricci", "Marica Pricci", "Vanna Pricci", "Giuseppe Pricci", "Tiziana Pricci"], gender: "M" },
            "Rosa Bianco": { birth: "02/09/1971", death: null, spouse: "Giovanni Pricci", children: [], parents:[], siblings:[], gender: "F" },
            "Giuseppe Pricci": { birth: "12/08/1968", death: null, spouse: "Anna Trivisani", children: ["Gilda Pricci", "Asia Pricci"], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Angela Pricci", "Maria Antonietta Pricci", "Marica Pricci", "Vanna Pricci", "Giovanni Pricci", "Tiziana Pricci"], gender: "M" },
            "Anna Trivisani": { birth: "12/07/1969", death: null, spouse: "Giuseppe Pricci", children: ["Gilda Pricci", "Asia Pricci"], parents:[], siblings:[], gender: "F" },
            "Tiziana Pricci": { birth: "27/06/1972", death: null, spouse: "Riccardo Dalena", children: [], parents: ["Luigi Pricci", "Teresa Grilletti"], siblings: ["Angela Pricci", "Maria Antonietta Pricci", "Marica Pricci", "Vanna Pricci", "Giovanni Pricci", "Giuseppe Pricci"], gender: "F" },
            "Riccardo Dalena": { birth: "11/04/1973", death: null, spouse: "Tiziana Pricci", children: [], parents:[], siblings:[], gender: "M" },
            "Benny Lorusso": { birth: "17/11/1975", death: null, spouse: "Genny Lepore", children: ["Alessandro Lorusso", "Alice Lorusso", "Nina Lorusso"], parents: ["Onofrio Lorusso", "Angela Pricci"], siblings: ["Cinzia Lorusso"], generation: 4, gender: "M" },
            "Genny Lepore": { birth: "04/07/1975", death: null, spouse: "Benny Lorusso", children: ["Alessandro Lorusso", "Alice Lorusso", "Nina Lorusso"], parents:[], siblings:[], generation: 4, gender: "F" },
            "Cinzia Lorusso": { birth: "06/04/1980", death: null, spouse: "Gianni Rotondi", children: ["Nicoletta Rotondi"], parents: ["Onofrio Lorusso", "Angela Pricci"], siblings: ["Benny Lorusso"], generation: 4, gender: "F" },
            "Gianni Rotondi": { birth: "08/03/1974", death: null, spouse: "Cinzia Lorusso", children: ["Nicoletta Rotondi"], parents:[], siblings:[], generation: 4, gender: "M" },
            "Martino Chiarappa": { birth: "24/05/1997", death: null, spouse: null, children: [], parents: ["Saverio Chiarappa", "Maria Antonietta Pricci"], siblings: ["Cristiano Chiarappa"], generation: 4, gender: "M" },
            "Cristiano Chiarappa": { birth: "20/06/2001", death: null, spouse: null, children: [], parents: ["Saverio Chiarappa", "Maria Antonietta Pricci"], siblings: ["Martino Chiarappa"], generation: 4, gender: "M" },
            "Maria Grazia Mazzarisi": { birth: "21/01/1989", death: null, spouse: null, children: [], parents: ["Sebastiano Mazzarisi", "Marica Pricci"], siblings: ["Onofrio Mazzarisi", "Teresa Mazzarisi"], generation: 4, gender: "F" },
            "Onofrio Mazzarisi": { birth: "05/06/1992", death: null, spouse: null, children: [], parents: ["Sebastiano Mazzarisi", "Marica Pricci"], siblings: ["Maria Grazia Mazzarisi", "Teresa Mazzarisi"], generation: 4, gender: "M" },
            "Teresa Mazzarisi": { birth: "01/04/1994", death: null, spouse: null, children: [], parents: ["Sebastiano Mazzarisi", "Marica Pricci"], siblings: ["Maria Grazia Mazzarisi", "Onofrio Mazzarisi"], generation: 4, gender: "F" },
            "Flavia Lefemine": { birth: "16/11/1996", death: null, spouse: null, children: [], parents: ["Domenico Lefemine", "Vanna Pricci"], siblings: ["Francesco Lefemine"], generation: 4, gender: "F" },
            "Francesco Lefemine": { birth: "20/03/2000", death: null, spouse: null, children: [], parents: ["Domenico Lefemine", "Vanna Pricci"], siblings: ["Flavia Lefemine"], generation: 4, gender: "M" },
            "Gilda Pricci": { birth: "29/06/2004", death: null, spouse: null, children: [], parents: ["Giuseppe Pricci", "Anna Trivisani"], siblings: ["Asia Pricci"], generation: 4, gender: "F" },
            "Asia Pricci": { birth: "07/06/2006", death: null, spouse: null, children: [], parents: ["Giuseppe Pricci", "Anna Trivisani"], siblings: ["Gilda Pricci"], generation: 4, gender: "F" },
            "Alessandro Lorusso": { birth: "17/07/2010", death: null, spouse: null, children: [], parents: ["Benny Lorusso", "Genny Lepore"], siblings: ["Alice Lorusso", "Nina Lorusso"], generation: 5, gender: "M" },
            "Alice Lorusso": { birth: "20/07/2013", death: null, spouse: null, children: [], parents: ["Benny Lorusso", "Genny Lepore"], siblings: ["Alessandro Lorusso", "Nina Lorusso"], generation: 5, gender: "F" },
            "Nina Lorusso": { birth: "29/11/2015", death: null, spouse: null, children: [], parents: ["Benny Lorusso", "Genny Lepore"], siblings: ["Alessandro Lorusso", "Alice Lorusso"], generation: 5, gender: "F" },
            "Nicoletta Rotondi": { birth: "12/02/2019", death: null, spouse: null, children: [], parents: ["Gianni Rotondi", "Cinzia Lorusso"], siblings: [], generation: 5, gender: "F" }
        };

        (function() {
            for (const name in familyData) {
                familyData[name].name = name;
                const photoName = name.replace(/ /g, '%20');
                familyData[name].photoLink = `https://sebastiano-mazzarisi.github.io/Test/FotoP/${photoName}.jpg`;
            }
        })();

        // --- Sezione Variabili Globali e Selettori DOM ---
        const peopleGrid = document.getElementById('people-grid');
        const resultsContainer = document.getElementById('results-container');
        const resultsText = document.getElementById('results-text');
        const photoDisplay1 = document.getElementById('person1-photo-display');
        const photoDisplay2 = document.getElementById('person2-photo-display');
        const infoButton = document.getElementById('info-button');
        const closePhotoInfo = document.getElementById('close-photo-info');
        const infoModalOverlay = document.getElementById('info-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const infoModalCloseBtn = document.querySelector('#info-modal-overlay .modal-close-btn');
        const imageButton = document.getElementById('image-button');
        const prevPersonBtn = document.getElementById('prev-person');
        const nextPersonBtn = document.getElementById('next-person');
        const installPrompt = document.getElementById('install-prompt-ios');
        const installPromptClose = document.getElementById('install-prompt-close');
        
        // Elementi per modal compleanni
        const birthdayListBtn = document.getElementById('birthday-list-btn');
        const birthdayModalOverlay = document.getElementById('birthday-modal-overlay');
        const birthdayModalBody = document.getElementById('birthday-modal-body');
        const birthdayShareBtn = document.getElementById('birthday-share-btn');
        const birthdayModalCloseBtn = document.querySelector('#birthday-modal-overlay .modal-close-btn');
        
        // Elementi per modal percorso parentela
        const pathModalOverlay = document.getElementById('path-modal-overlay');
        const pathModalBody = document.getElementById('path-modal-body');
        const pathShareBtn = document.getElementById('path-share-btn');
        const pathModalCloseBtn = document.querySelector('#path-modal-overlay .modal-close-btn');

        // Elementi per modal albero genealogico
        const treeViewBtn = document.getElementById('tree-view-btn');
        const treeModalOverlay = document.getElementById('tree-modal-overlay');
        const treeModalBody = document.getElementById('tree-modal-body');
        const treeModalCloseBtn = document.querySelector('#tree-modal-overlay .modal-close-btn');
        
        let selectedPeople = [];
        let sortedPeopleNames = [];

        // --- Sezione Funzioni di Calcolo Parentela ---
        function calculateGeneration(personName, visited = new Set()) {
            if (visited.has(personName)) return 99; // Evita loop infiniti
            visited.add(personName);

            const person = familyData[personName];
            if (!person) return 1;
            
            // Assegna generazione fissa ai capostipiti e ai loro coniugi
            if (personName === 'Nonno Giovanni Pricci' || personName === 'Angelina Gasparro') return 1;
            
            const spouse = person.spouse ? familyData[person.spouse] : null;
            if (spouse && (spouse.name === 'Nonno Giovanni Pricci' || spouse.name === 'Angelina Gasparro')) return 1;

            if (!person.parents || person.parents.length === 0) return 1;
            
            const parentGenerations = person.parents.map(p => calculateGeneration(p, new Set(visited)));
            return Math.max(...parentGenerations) + 1;
        }
        
        function findBloodConnection(person1, person2) {
            const person1Data = familyData[person1];
            const person2Data = familyData[person2];
            if (!person1Data || !person2Data) return null;

            if (person1Data.children?.includes(person2)) return { type: 'parent_child', direction: 'down' };
            if (person2Data.children?.includes(person1)) return { type: 'parent_child', direction: 'up' };
            if (person1Data.siblings?.includes(person2)) return { type: 'sibling' };
            if (person1Data.siblings?.some(sib => familyData[sib]?.children?.includes(person2))) return { type: 'uncle_nephew', direction: 'down' };
            if (person2Data.siblings?.some(sib => familyData[sib]?.children?.includes(person1))) return { type: 'uncle_nephew', direction: 'up' };
            
            if (person1Data.siblings?.some(sib => familyData[sib]?.children?.some(nephew => familyData[nephew]?.children?.includes(person2)))) return { type: 'great_uncle_nephew', direction: 'down' };
            if (person2Data.siblings?.some(sib => familyData[sib]?.children?.some(nephew => familyData[nephew]?.children?.includes(person1)))) return { type: 'great_uncle_nephew', direction: 'up' };

            const p1_parents = person1Data.parents || [];
            const p2_parents = person2Data.parents || [];
            const getGrandparents = (parents) => [].concat(...parents.map(p => familyData[p]?.parents || []));
            const p1_grandparents = getGrandparents(p1_parents);
            const p2_grandparents = getGrandparents(p2_parents);

            if (p1_parents.length > 0 && p2_parents.length > 0 && p1_parents.some(p1p => familyData[p1p]?.siblings?.some(sib => p2_parents.includes(sib)))) return { type: 'cousin' };
            if (p1_grandparents.length > 0 && p2_grandparents.length > 0 && p1_grandparents.some(p1gp => familyData[p1gp]?.siblings?.some(sib => p2_grandparents.includes(sib)))) return { type: 'second_cousin' };
            if ((p1_grandparents.length > 0 && p2_parents.length > 0 && p1_grandparents.some(p1gp => familyData[p1gp]?.siblings?.some(sib => p2_parents.includes(sib)))) || (p2_grandparents.length > 0 && p1_parents.length > 0 && p2_grandparents.some(p2gp => familyData[p2gp]?.siblings?.some(sib => p1_parents.includes(sib))))) return { type: 'second_cousin' };

            const isDirectDescendant = (ancestorName, descendantName) => {
                let queue = [descendantName];
                while (queue.length > 0) {
                    let current = queue.shift();
                    if (current === ancestorName) return true;
                    familyData[current]?.parents?.forEach(p => queue.push(p));
                }
                return false;
            };

            if (isDirectDescendant(person1, person2)) {
                const genDiff = calculateGeneration(person2) - calculateGeneration(person1);
                if (genDiff === 2) return { type: 'grandparent_grandchild', direction: 'down' };
                if (genDiff === 3) return { type: 'great_grandparent_grandchild', direction: 'down' };
                if (genDiff === 4) return { type: 'great_great_grandparent_grandchild', direction: 'down' };
            }
            if (isDirectDescendant(person2, person1)) {
                const genDiff = calculateGeneration(person1) - calculateGeneration(person2);
                if (genDiff === 2) return { type: 'grandparent_grandchild', direction: 'up' };
                if (genDiff === 3) return { type: 'great_grandparent_grandchild', direction: 'up' };
                if (genDiff === 4) return { type: 'great_great_grandparent_grandchild', direction: 'up' };
            }
            return null;
        }

        function findAffinityConnection(person1, person2) {
            const person1Data = familyData[person1];
            const person2Data = familyData[person2];
            if (!person1Data || !person2Data) return null;

            if (person1Data.spouse) {
                const connection = findBloodConnection(person1Data.spouse, person2);
                if (connection) return { ...connection, through_marriage: person1Data.spouse };
            }
            if (person2Data.spouse) {
                const connection = findBloodConnection(person1, person2Data.spouse);
                if (connection) return { ...connection, through_marriage: person2Data.spouse, reverse: true };
            }
            if (person1Data.spouse && familyData[person1Data.spouse]?.siblings?.some(sib => familyData[sib]?.spouse === person2)) {
                return { type: 'sibling', through_marriage: person1Data.spouse };
            }
            if (person2Data.spouse && familyData[person2Data.spouse]?.siblings?.some(sib => familyData[sib]?.spouse === person1)) {
                 return { type: 'sibling', through_marriage: person2Data.spouse, reverse: true };
            }
            if (person1Data.spouse && person2Data.spouse) {
                const connection = findBloodConnection(person1Data.spouse, person2Data.spouse);
                if (connection) return { ...connection, through_marriage: person1Data.spouse };
            }
            return null;
        }
        
        function connectionToRelationship(connection, startGender, endGender) {
            if (!connection) return null;
            const isAcquired = !!connection.through_marriage;

            switch (connection.type) {
                case 'spouse':
                    return { forward: startGender === 'M' ? 'marito' : 'moglie', backward: endGender === 'M' ? 'marito' : 'moglie' };
                case 'parent_child':
                    if (connection.direction === 'down') {
                        return isAcquired ? { forward: startGender === 'M' ? 'suocero' : 'suocera', backward: endGender === 'M' ? 'genero' : 'nuora' } 
                                          : { forward: startGender === 'M' ? 'padre' : 'madre', backward: endGender === 'M' ? 'figlio' : 'figlia' };
                    } else {
                        return isAcquired ? { forward: startGender === 'M' ? 'genero' : 'nuora', backward: endGender === 'M' ? 'suocero' : 'suocera' } 
                                          : { forward: startGender === 'M' ? 'figlio' : 'figlia', backward: endGender === 'M' ? 'padre' : 'madre' };
                    }
                case 'sibling':
                    return isAcquired ? { forward: startGender === 'M' ? 'cognato' : 'cognata', backward: endGender === 'M' ? 'cognato' : 'cognata' } 
                                      : { forward: startGender === 'M' ? 'fratello' : 'sorella', backward: endGender === 'M' ? 'fratello' : 'sorella' };
                case 'uncle_nephew':
                    return connection.direction === 'down' ? { forward: startGender === 'M' ? 'zio' : 'zia', backward: 'nipote' } : { forward: 'nipote', backward: endGender === 'M' ? 'zio' : 'zia' };
                case 'great_uncle_nephew':
                    return connection.direction === 'down' ? { forward: startGender === 'M' ? 'prozio' : 'prozia', backward: 'pronipote' } : { forward: 'pronipote', backward: endGender === 'M' ? 'prozio' : 'prozia' };
                case 'grandparent_grandchild':
                    return connection.direction === 'down' ? { forward: startGender === 'M' ? 'nonno' : 'nonna', backward: 'nipote' } : { forward: 'nipote', backward: endGender === 'M' ? 'nonno' : 'nonna' };
                case 'great_grandparent_grandchild':
                    return connection.direction === 'down' ? { forward: startGender === 'M' ? 'bisnonno' : 'bisnonna', backward: 'pronipote' } : { forward: 'pronipote', backward: endGender === 'M' ? 'bisnonno' : 'bisnonna' };
                case 'great_great_grandparent_grandchild':
                     return connection.direction === 'down' ? { forward: startGender === 'M' ? 'trisnonno' : 'trisnonna', backward: 'trisnipote' } : { forward: 'trisnipote', backward: endGender === 'M' ? 'trisnonno' : 'trisnonna' };
                case 'cousin':
                    return { forward: startGender === 'M' ? 'cugino' : 'cugina', backward: endGender === 'M' ? 'cugino' : 'cugina' };
                case 'second_cousin':
                    return { forward: startGender === 'M' ? 'procugino' : 'procugina', backward: endGender === 'M' ? 'procugino' : 'procugina' };
            }
            return null;
        }
        
        function findFullPath(startName, endName) {
            if (startName === endName) return null;
            const queue = [[startName]];
            const visited = new Set([startName]);

            while (queue.length > 0) {
                const path = queue.shift();
                const currentName = path[path.length - 1];

                if (currentName === endName) return path;

                const currentData = familyData[currentName];
                if (!currentData) continue;

                const connections = [
                    ...(currentData.parents || []),
                    ...(currentData.children || []),
                    ...(currentData.siblings || []),
                    ...(currentData.spouse ? [currentData.spouse] : [])
                ];

                for (const connectionName of connections) {
                    if (connectionName && !visited.has(connectionName)) {
                        visited.add(connectionName);
                        const newPath = [...path, connectionName];
                        queue.push(newPath);
                    }
                }
            }
            return null;
        }
        
        function getImmediateRelationship(p1, p2) {
            const d1 = familyData[p1];
            if (!d1) return "ha un legame con";
            if (d1.spouse === p2) return d1.gender === 'M' ? "Ã¨ marito di" : "Ã¨ moglie di";
            if (d1.children?.includes(p2)) return d1.gender === 'M' ? "Ã¨ padre di" : "Ã¨ madre di";
            if (d1.parents?.includes(p2)) return d1.gender === 'M' ? "Ã¨ figlio di" : "Ã¨ figlia di";
            if (d1.siblings?.includes(p2)) return d1.gender === 'M' ? "Ã¨ fratello di" : "Ã¨ sorella di";
            return "ha un legame con";
        }
        
        function getRelationship(startName, endName) {
            if (startName === endName) return null;
            const startPerson = familyData[startName];
            const endPerson = familyData[endName];
            if (!startPerson || !endPerson) return null;

            if (startPerson.spouse === endName) {
                const rel = connectionToRelationship({ type: 'spouse' }, startPerson.gender, endPerson.gender);
                return { 
                    a_to_b: `<span class="relationship-term">${rel.forward}</span>`, 
                    b_to_a: `<span class="relationship-term">${rel.backward}</span>`
                };
            }
            
            let connection = findBloodConnection(startName, endName) || findAffinityConnection(startName, endName);
            if (!connection) return null;
            
            const relationship = connectionToRelationship(connection, startPerson.gender, endPerson.gender);
            if (!relationship) return null;
            
            return {
                a_to_b: `<span class="relationship-term">${relationship.forward}</span>`,
                b_to_a: `<span class="relationship-term">${relationship.backward}</span>`
            };
        }
        
        // --- Sezione Funzioni UI (Interfaccia Utente) ---
        function renderPeople() {
            const getSortKey = (name) => {
                const person = familyData[name];
                const gen = calculateGeneration(name) || getGenerationFromBirth(person.birth);
                const date = new Date(person.birth.split('/').reverse().join('-')).getTime();
                return `${String(gen).padStart(2, '0')}-${date}`;
            };
            sortedPeopleNames = Object.keys(familyData).sort((a, b) => getSortKey(a).localeCompare(getSortKey(b)));
            
            for (const name of sortedPeopleNames) {
                const data = familyData[name];
                data.name = name;
                const card = document.createElement('div');
                card.className = 'person-card';
                if(data.death) card.classList.add('deceased');
                card.dataset.name = name;
                card.addEventListener('click', () => handlePersonClick(name, card));
                const photo = document.createElement('img');
                photo.className = 'person-photo';
                photo.src = data.photoLink;
                photo.alt = `Foto di ${name}`;

                photo.onerror = function() { this.outerHTML = `<div class="person-photo">${name.split(' ').map(n=>n[0]).join('')}</div>`; };

                const nameEl = document.createElement('div');
                nameEl.className = 'person-name';
                nameEl.textContent = name;
                const relText = document.createElement('div');
                relText.className = 'card-relationship-text';
                relText.textContent = data.birth;
                card.append(photo, nameEl, relText);
                peopleGrid.appendChild(card);
            }
        }
        
        function getGenerationFromBirth(birthDate) {
            const year = parseInt(birthDate.split('/')[2]);
            if (year < 1920) return 1; if (year < 1950) return 2; if (year < 1980) return 3; if (year < 2010) return 4; return 5;
        }
        
        function handlePhotoClick(name) {
            const index = selectedPeople.indexOf(name);
            if (index > -1 && selectedPeople.length === 1) {
                selectedPeople.splice(index, 1);
                document.querySelector(`.person-card[data-name="${name}"]`)?.classList.remove('selected');
            } else {
                 document.querySelector(`.person-card[data-name="${name}"]`)?.click();
                 return;
            }
            updateHighlights();
            updatePhotoDisplay();
            updateResults();
        }

        function handlePersonClick(name, cardElement) {
            const index = selectedPeople.indexOf(name);
            if (index > -1) {
                selectedPeople.splice(index, 1);
                cardElement.classList.remove('selected');
            } else {
                if (selectedPeople.length >= 2) {
                    const firstSelected = selectedPeople.shift();
                    document.querySelector(`.person-card[data-name="${firstSelected}"]`)?.classList.remove('selected');
                }
                selectedPeople.push(name);
                cardElement.classList.add('selected');
            }
            updateHighlights();
            updatePhotoDisplay();
            updateResults();
        }

        function clearHighlights() {
            document.querySelectorAll('.person-card').forEach(card => {
                card.classList.remove('relative-highlight');
                const relText = card.querySelector('.card-relationship-text');
                if (relText) relText.textContent = familyData[card.dataset.name].birth;
            });
        }

        function updateHighlights() {
            clearHighlights();
            const singleSelection = selectedPeople.length === 1;
            
            infoButton.classList.toggle('hidden', !singleSelection);
            closePhotoInfo.classList.toggle('hidden', !singleSelection);
            prevPersonBtn.classList.toggle('hidden', !singleSelection);
            nextPersonBtn.classList.toggle('hidden', !singleSelection);

            if (!singleSelection) return;
            
            const selectedName = selectedPeople[0];
            
            for (const otherName in familyData) {
                if (otherName === selectedName) continue;
                const relationship = getRelationship(otherName, selectedName);
                if (relationship) {
                    const card = document.querySelector(`[data-name="${otherName}"]`);
                    if (card) {
                        card.classList.add('relative-highlight');
                        const relTextDiv = card.querySelector('.card-relationship-text');
                        if(relTextDiv) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = relationship.a_to_b;
                            let displayText = (tempDiv.textContent || tempDiv.innerText || "").trim();
                            relTextDiv.textContent = displayText.charAt(0).toUpperCase() + displayText.slice(1);
                        }
                    }
                }
            }
        }
        
        function updatePhotoDisplay() {
            resultsContainer.classList.toggle('hidden', selectedPeople.length === 0);
            const displays = [photoDisplay1, photoDisplay2];
            displays.forEach((display, index) => {
                display.innerHTML = '';
                display.classList.remove('visible');
                if (selectedPeople[index]) {
                    const personName = selectedPeople[index];
                    const personData = familyData[personName];
                    if (personData) {
                        display.innerHTML = `<img src="${personData.photoLink}" alt="${personName}" onclick="handlePhotoClick('${personName}')" />`;
                        setTimeout(() => display.classList.add('visible'), 50);
                    }
                }
            });
        }

        function updateResults() {
            const resultsTextWrapper = document.getElementById('results-text-wrapper');
            const existingBtn = document.getElementById('show-path-btn');
            if(existingBtn) existingBtn.remove();

            if (selectedPeople.length === 0) {
                 resultsText.innerHTML = 'In attesa della selezione...';
                 return;
            }
            if (selectedPeople.length === 1) {
                const personName = selectedPeople[0];
                const personData = familyData[personName];
                const selectionText = personData.gender === 'F' ? 'selezionata...' : 'selezionato...';
                resultsText.innerHTML = `<strong>${personName}</strong> ${selectionText}`;
                return;
            }
            
            const [personA_name, personB_name] = selectedPeople;
            const relationship = getRelationship(personA_name, personB_name);
            
            if (!relationship) {
                resultsText.innerHTML = `Nessun legame di parentela noto tra <strong>${personA_name}</strong> e <strong>${personB_name}</strong>.`;
                return;
            }
            
            const result1 = `<strong>${personA_name}</strong> Ã¨ ${relationship.a_to_b} di <strong>${personB_name}</strong>`;
            const result2 = `<br><strong>${personB_name}</strong> Ã¨ ${relationship.b_to_a} di <strong>${personA_name}</strong>`;
            resultsText.innerHTML = result1 + result2;

            const path = findFullPath(personA_name, personB_name);
            if (path && path.length > 1) {
                const degree = path.length - 1;
                const pathBtn = document.createElement('button');
                pathBtn.id = 'show-path-btn';
                pathBtn.className = 'kinship-degree-info';
                pathBtn.textContent = `Parentela di ${degree}Â° grado`;
                pathBtn.addEventListener('click', () => showKinshipPath(personA_name, personB_name));
                resultsTextWrapper.appendChild(pathBtn);
            }
        }
        
        infoButton.addEventListener('click', () => {
            if (selectedPeople.length !== 1) return;
            const selectedName = selectedPeople[0];
            const selectedPersonData = familyData[selectedName];
            if (!selectedPersonData) return;

            const orderedNames = Array.from(document.querySelectorAll('#people-grid .person-card')).map(card => card.dataset.name);
            
            const groupMap = {
                'Nonno': 'Nonni', 'Nonna': 'Nonni', 'Suocero': 'Suoceri', 'Suocera': 'Suoceri', 'Marito': 'Marito', 'Moglie': 'Moglie', 'Padre': 'Genitori', 'Madre': 'Genitori', 'Figlio': 'Figli', 'Figlia': 'Figli', 'Fratello': 'Fratelli', 'Sorella': 'Fratelli', 'Cognato': 'Cognati', 'Cognata': 'Cognati', 'Zio': 'Zii', 'Zia': 'Zii', 'Nipote': 'Nipoti', 'Cugino': 'Cugini', 'Cugina': 'Cugini', 'Prozio': 'Prozii', 'Prozia': 'Prozii', 'Pronipote': 'Pronipoti', 'Procugino': 'Procugini', 'Procugina': 'Procugini', 'Trisnonno': 'Trisnonni', 'Trisnonna': 'Trisnonni', 'Trisnipote': 'Trisnipoti'
            };
            
            const groupedRelatives = {};
            for (const otherName of orderedNames) {
                if (otherName === selectedName) continue;
                const relationship = getRelationship(otherName, selectedName);
                if (relationship?.a_to_b) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = relationship.a_to_b;
                    let term = (tempDiv.textContent || tempDiv.innerText || "").trim();
                    if(term) {
                        term = term.charAt(0).toUpperCase() + term.slice(1);
                        const group = groupMap[term] || term;
                        if (!groupedRelatives[group]) {
                            groupedRelatives[group] = [];
                        }
                        groupedRelatives[group].push({ name: otherName, gender: familyData[otherName].gender, birth: familyData[otherName].birth });
                    }
                }
            }

            for (const groupName in groupedRelatives) {
                groupedRelatives[groupName].sort((a, b) => {
                    const dateA = new Date(a.birth.split('/').reverse().join('-'));
                    const dateB = new Date(b.birth.split('/').reverse().join('-'));
                    return dateA - dateB;
                });
            }

            if (groupedRelatives['Fratelli'] && groupedRelatives['Fratelli'].every(person => person.gender === 'F')) {
                groupedRelatives['Sorelle'] = groupedRelatives['Fratelli'];
                delete groupedRelatives['Fratelli'];
            }
            
            const groupOrder = ['Trisnonni', 'Bisnonni', 'Nonni', 'Suoceri', 'Genitori', 'Marito', 'Moglie', 'Figli', 'Fratelli', 'Sorelle', 'Prozii', 'Zii', 'Cognati', 'Cugini', 'Procugini', 'Nipoti', 'Pronipoti', 'Trisnipoti'];
            
            const emptyRow = `<div class="timeline-item" style="margin-bottom: -10px;"><div class="timeline-dot" style="visibility: hidden;"></div></div>`;
            let htmlList = `<div class="timeline-container">${emptyRow}`;

            for (const groupName of groupOrder) {
                if (groupedRelatives[groupName]) {
                    const peopleInGroup = groupedRelatives[groupName];
                    const fullNames = peopleInGroup.map(person => {
                        const nameParts = person.name.split(' ');
                        const lastName = nameParts.pop();
                        const firstName = nameParts.join(' ');
                        const birthYear = person.birth.split('/')[2];
                        if (firstName) {
                            return `<strong>${firstName}</strong> ${lastName} (${birthYear})`;
                        } else {
                            return `<strong>${lastName}</strong> (${birthYear})`;
                        }
                    }).join(', ');

                    htmlList += `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <h3>${groupName}</h3>
                                <p>${fullNames}</p>
                            </div>
                        </div>`;
                }
            }
            htmlList += `${emptyRow}</div>`;

            modalTitle.textContent = `${selectedName} (${selectedPersonData.birth})`;
            modalBody.innerHTML = htmlList;
            
            let clipboardText = `*${selectedName}* (${selectedPersonData.birth})\n`;
            for (const groupName of groupOrder) {
                if (groupedRelatives[groupName]) {
                    const peopleInGroup = groupedRelatives[groupName];
                    const peopleList = peopleInGroup.map(person => {
                        const birthYear = person.birth.split('/')[2];
                        return `${person.name} (${birthYear})`;
                    }).join('\n');
                    
                    clipboardText += '---\n';
                    clipboardText += `*${groupName}*:\n`;
                    clipboardText += `${peopleList}\n`;
                }
            }

            if (navigator.clipboard) {
                navigator.clipboard.writeText(clipboardText).catch(err => console.error("Impossibile copiare negli appunti:", err));
            }
            
            infoModalOverlay.classList.remove('hidden');
        });

        function closeModal(modal) {
            modal.classList.add('hidden');
        }
        
        function generateImage(elementToCapture, modalActions, fileNamePrefix = 'parentela') {
             const modalBodyEl = elementToCapture.querySelector(".modal-body");
            
            if (!elementToCapture || !modalBodyEl || !modalActions) return;
            
            const originalStyles = {
                maxHeight: elementToCapture.style.maxHeight,
                overflowY: modalBodyEl.style.overflowY,
                alignItems: elementToCapture.closest('.modal-overlay').style.alignItems,
                actionsDisplay: modalActions.style.display
            };
            
            modalActions.style.display = 'none';
            elementToCapture.style.maxHeight = 'none';
            modalBodyEl.style.overflowY = 'visible';
            elementToCapture.closest('.modal-overlay').style.alignItems = 'flex-start';

            html2canvas(elementToCapture, { 
                scale: 1.2, 
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const fileName = `${fileNamePrefix}.jpg`;

                canvas.toBlob(function(blob) {
                    const file = new File([blob], fileName, { type: 'image/jpeg' });
                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: `Parentela`,
                        }).catch(err => {
                             if (err.name !== 'AbortError') console.error("Errore di condivisione:", err)
                        });
                    } else {
                        const link = document.createElement('a');
                        link.download = fileName;
                        link.href = canvas.toDataURL('image/jpeg', 0.85);
                        link.click();
                    }
                }, 'image/jpeg', 0.85);

            }).catch(err => {
                console.error("Errore durante la creazione dell'immagine:", err);
            }).finally(() => {
                elementToCapture.style.maxHeight = originalStyles.maxHeight;
                modalBodyEl.style.overflowY = originalStyles.overflowY;
                elementToCapture.closest('.modal-overlay').style.alignItems = originalStyles.alignItems;
                modalActions.style.display = originalStyles.actionsDisplay;
            });
        }
        
        function navigatePerson(direction) {
            if (selectedPeople.length !== 1) return;
            const currentName = selectedPeople[0];
            const currentIndex = sortedPeopleNames.indexOf(currentName);
            if (currentIndex === -1) return;

            let newIndex = currentIndex + direction;

            if (newIndex >= sortedPeopleNames.length) newIndex = 0;
            if (newIndex < 0) newIndex = sortedPeopleNames.length - 1;

            const newPersonName = sortedPeopleNames[newIndex];
            
            const currentCard = document.querySelector('.person-card.selected');
            const newPersonCard = document.querySelector(`.person-card[data-name="${newPersonName}"]`);

            if (currentCard) currentCard.classList.remove('selected');
            if (newPersonCard) newPersonCard.classList.add('selected');

            selectedPeople = [newPersonName];

            updateHighlights();
            updatePhotoDisplay();
            updateResults();
        }

        // --- Funzioni per la nuova lista compleanni ---

        function parseDate(dateStr) { // "dd/mm/yyyy"
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function calculateAge(birthDateStr) {
            const birthDate = parseDate(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function calculateBirthdayDelta(birthDateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const birthDate = parseDate(birthDateStr);

            const birthdayThisYear = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
            
            const oneDay = 1000 * 60 * 60 * 24;
            const diffDays = Math.round((birthdayThisYear - today) / oneDay);

            if (diffDays === 0) {
                return { text: "Oggi!", isToday: true, hasCompleted: true, isUpcoming: false };
            } else if (diffDays > 0) {
                return { text: `Mancano ${diffDays} giorni`, isToday: false, hasCompleted: false, isUpcoming: true };
            } else {
                const daysPassed = Math.abs(diffDays);
                return { text: `Passati da ${daysPassed} giorni`, isToday: false, hasCompleted: true, isUpcoming: false };
            }
        }
        
        function showBirthdayList() {
            const peopleWithBirthdays = Object.keys(familyData)
                .filter(name => familyData[name].death === null)
                .map(name => {
                    const person = familyData[name];
                    const birthDate = parseDate(person.birth);
                    return {
                        name: name,
                        birth: person.birth,
                        month: birthDate.getMonth(),
                        day: birthDate.getDate(),
                        age: calculateAge(person.birth),
                        delta: calculateBirthdayDelta(person.birth)
                    };
            });

            peopleWithBirthdays.sort((a, b) => {
                if (a.month < b.month) return -1;
                if (a.month > b.month) return 1;
                return a.day - b.day;
            });

            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            const today = new Date();
            const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            
            let currentMonthIdx = -1;
            let tableHTML = `<table class="birthday-table">
                                <thead>
                                    <tr>
                                        <th>Nominativo</th>
                                        <th>Nascita</th>
                                        <th>EtÃ </th>
                                        <th>${formattedDate}</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            let todayRowId = null;
            let currentMonthHeaderId = `month-header-${today.getMonth()}`;

            peopleWithBirthdays.forEach(person => {
                if (person.month !== currentMonthIdx) {
                    currentMonthIdx = person.month;
                    const monthId = `month-header-${currentMonthIdx}`;
                    tableHTML += `<tr class="month-header" id="${monthId}"><td colspan="4">${monthNames[currentMonthIdx]}</td></tr>`;
                }
                
                let highlightClass = '';
                if (person.delta.isToday) {
                    highlightClass = 'birthday-today';
                } else if (person.delta.isUpcoming) {
                    highlightClass = 'birthday-upcoming';
                } else if (person.delta.hasCompleted) {
                    highlightClass = 'birthday-completed';
                }

                const rowId = person.delta.isToday ? `id="birthday-row-${person.name.replace(/ /g, '-')}"` : '';
                if(person.delta.isToday) {
                    todayRowId = `birthday-row-${person.name.replace(/ /g, '-')}`;
                }

                tableHTML += `<tr class="${highlightClass}" ${rowId}>
                                <td>${person.name}</td>
                                <td>${person.birth}</td>
                                <td>${person.age}</td>
                                <td>${person.delta.text}</td>
                              </tr>`;
            });

            tableHTML += `</tbody></table>`;
            birthdayModalBody.innerHTML = tableHTML;
            birthdayModalOverlay.classList.remove('hidden');

            setTimeout(() => {
                const targetRow = document.getElementById(todayRowId) || document.getElementById(currentMonthHeaderId);
                if(targetRow) {
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // --- Funzioni per il nuovo percorso di parentela ---
        function generatePathDescription(path, from, to) {
            const steps = [];
            for (let i = 0; i < path.length - 1; i++) {
                const p1 = path[i];
                const p2 = path[i + 1];
                const rel = getImmediateRelationship(p1, p2);
                steps.push(`<p>${p1} ${rel} ${p2}</p>`);
            }
            
            const finalRelData = getRelationship(from, to);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = finalRelData.a_to_b;
            const cleanRel = tempDiv.textContent || tempDiv.innerText;
            const conclusion = `<p><strong>${from} Ã¨ ${cleanRel} di ${to}</strong></p>`;
            
            return steps.join('') + conclusion;
        }

        function showKinshipPath(personA, personB) {
            const pathAToB = findFullPath(personA, personB);
            const pathBToA = findFullPath(personB, personA);
            const degree = pathAToB.length - 1;

            const pathDescAToB = generatePathDescription(pathAToB, personA, personB);
            const pathDescBToA = generatePathDescription(pathBToA, personB, personA);
            
            const photoA = familyData[personA].photoLink;
            const photoB = familyData[personB].photoLink;

            let html = `
                <div class="path-box" style="display: flex; align-items: center; justify-content: space-around; gap: 10px;">
                    <img src="${photoA}" alt="${personA}" class="path-photo">
                    <div>
                        <p><strong>${personA}</strong> Ã¨</p>
                        <p>parente di ${degree}Â° grado</p>
                        <p>con <strong>${personB}</strong></p>
                    </div>
                    <img src="${photoB}" alt="${personB}" class="path-photo">
                </div>
                <div class="path-box" style="text-align: left;">
                    ${pathDescAToB}
                </div>
                <div class="path-box" style="text-align: left;">
                    ${pathDescBToA}
                </div>
            `;
            
            pathModalBody.innerHTML = html;
            pathModalOverlay.classList.remove('hidden');
        }
        
        // --- Funzioni per l'albero genealogico ---
        function drawHorizontalTree() {
            treeModalBody.innerHTML = ""; 
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");

            const NODE_WIDTH = 160, NODE_HEIGHT = 40, V_SPACING_COUPLE = 2, H_SPACING = 180, V_SPACING_UNIT = 20, PADDING = 50;

            const positions = new Map();
            const subtreeHeights = new Map();
            const rootId = 'Nonno Giovanni Pricci';
            
            // Calcola ricorsivamente l'altezza verticale di ogni sotto-albero
            function calculateSubtreeHeight(personId) {
                if (subtreeHeights.has(personId)) return subtreeHeights.get(personId);
                const person = familyData[personId];
                const nodeHeight = person.spouse ? (NODE_HEIGHT * 2 + V_SPACING_COUPLE) : NODE_HEIGHT;

                if (!person.children || person.children.length === 0) {
                    subtreeHeights.set(personId, nodeHeight);
                    return nodeHeight;
                }
                let childrenBlockHeight = -V_SPACING_UNIT;
                const sortedChildren = person.children.slice().sort((a,b) => parseDate(familyData[a].birth) - parseDate(familyData[b].birth));
                sortedChildren.forEach(childId => {
                    childrenBlockHeight += calculateSubtreeHeight(childId) + V_SPACING_UNIT;
                });
                
                const finalHeight = Math.max(nodeHeight, childrenBlockHeight);
                subtreeHeights.set(personId, finalHeight);
                return finalHeight;
            }

            // Dispone ricorsivamente i nodi
            function layoutTree(personId, currentX, currentY) {
                const person = familyData[personId];
                const spouseId = person.spouse;
                const coupleHeight = spouseId ? (NODE_HEIGHT * 2 + V_SPACING_COUPLE) : NODE_HEIGHT;
                const subtreeHeight = subtreeHeights.get(personId);
                
                const y = currentY + (subtreeHeight / 2) - (coupleHeight / 2);

                positions.set(personId, { x: currentX, y: y });
                if (spouseId && familyData[spouseId]) {
                    positions.set(spouseId, { x: currentX, y: y + NODE_HEIGHT + V_SPACING_COUPLE });
                }

                if (person.children && person.children.length > 0) {
                    let childY = currentY;
                    const sortedChildren = person.children.slice().sort((a,b) => parseDate(familyData[a].birth) - parseDate(familyData[b].birth));
                    sortedChildren.forEach(childId => {
                        layoutTree(childId, currentX + NODE_WIDTH + H_SPACING, childY);
                        childY += subtreeHeights.get(childId) + V_SPACING_UNIT;
                    });
                }
            }
            
            // Avvia il processo
            calculateSubtreeHeight(rootId);
            layoutTree(rootId, PADDING, PADDING);
            
            let maxX = 0, maxY = 0;
            for(const pos of positions.values()) {
                if(pos.x > maxX) maxX = pos.x;
                if(pos.y > maxY) maxY = pos.y;
            }
            const totalWidth = maxX + NODE_WIDTH + PADDING;
            const totalHeight = maxY + NODE_HEIGHT + PADDING;
            svg.setAttribute("width", totalWidth);
            svg.setAttribute("height", totalHeight);
            
            // Disegna i collegamenti
            for(const personId in familyData) {
                 const pos = positions.get(personId);
                 const person = familyData[personId];
                 if(!pos) continue;

                 // Link matrimonio
                 if(person.spouse && positions.has(person.spouse) && person.name < person.spouse) {
                    const spousePos = positions.get(person.spouse);
                    const line = document.createElementNS(svgNS, 'line');
                    line.setAttribute('x1', pos.x + NODE_WIDTH / 2);
                    line.setAttribute('y1', pos.y + NODE_HEIGHT);
                    line.setAttribute('x2', spousePos.x + NODE_WIDTH / 2);
                    line.setAttribute('y2', spousePos.y);
                    line.setAttribute('class', 'marriage-link');
                    svg.appendChild(line);
                 }

                 // Link figli
                 if(person.children && person.children.length > 0) {
                     const spousePos = person.spouse ? positions.get(person.spouse) : null;
                     const parentMidY = spousePos ? (pos.y + spousePos.y + NODE_HEIGHT)/2 : pos.y + NODE_HEIGHT/2;
                     const connectorX = pos.x + NODE_WIDTH + H_SPACING / 2;
                     
                     const outLine = document.createElementNS(svgNS, 'line');
                     outLine.setAttribute('x1', pos.x + NODE_WIDTH);
                     outLine.setAttribute('y1', parentMidY);
                     outLine.setAttribute('x2', connectorX);
                     outLine.setAttribute('y2', parentMidY);
                     outLine.setAttribute('class', 'tree-link');
                     svg.appendChild(outLine);

                     person.children.forEach(childId => {
                         const childPos = positions.get(childId);
                         if (childPos) {
                            const childLine = document.createElementNS(svgNS, 'path');
                            childLine.setAttribute('d', `M${connectorX},${parentMidY} L ${connectorX},${childPos.y + NODE_HEIGHT/2} L ${childPos.x},${childPos.y + NODE_HEIGHT/2}`);
                            childLine.setAttribute('class', 'tree-link');
                            svg.appendChild(childLine);
                         }
                     });
                 }
            }

            // Disegna i nodi
            for(const personId in familyData) {
                const pos = positions.get(personId);
                 const person = familyData[personId];
                 if(!pos) continue;
                 
                const g = document.createElementNS(svgNS, "g");
                g.setAttribute("class", `tree-node ${person.death ? 'deceased' : ''}`);
                g.setAttribute("transform", `translate(${pos.x},${pos.y})`);

                const rect = document.createElementNS(svgNS, "rect");
                rect.setAttribute("width", NODE_WIDTH);
                rect.setAttribute("height", NODE_HEIGHT);
                g.appendChild(rect);

                const text = document.createElementNS(svgNS, "text");
                text.setAttribute("x", NODE_WIDTH / 2);
                text.setAttribute("y", NODE_HEIGHT / 2 + 5); 
                text.setAttribute("text-anchor", "middle");
                text.textContent = personId;
                
                g.appendChild(text);
                svg.appendChild(g);
            }
            
            treeModalBody.appendChild(svg);
            treeModalOverlay.classList.remove('hidden');
        }

        function showInstallPrompt() {
            const isIos = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
            const isDismissed = localStorage.getItem('installPromptDismissed') === 'true';

            if (isIos && !isInStandaloneMode && !isDismissed) {
                installPrompt.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---
        infoModalCloseBtn.addEventListener('click', () => closeModal(infoModalOverlay));
        imageButton.addEventListener('click', () => {
            const element = document.querySelector("#info-modal-overlay .modal-content");
            const actions = element.querySelector('.modal-actions');
            const fileName = `parentela-${selectedPeople[0].replace(/ /g, '_')}`;
            generateImage(element, actions, fileName);
        });
        prevPersonBtn.addEventListener('click', () => navigatePerson(-1));
        nextPersonBtn.addEventListener('click', () => navigatePerson(1));

        infoModalOverlay.addEventListener('click', (e) => {
            if (e.target === infoModalOverlay) closeModal(infoModalOverlay);
        });
        
        // Listeners per modal compleanni
        birthdayListBtn.addEventListener('click', showBirthdayList);
        birthdayModalCloseBtn.addEventListener('click', () => closeModal(birthdayModalOverlay));
        birthdayShareBtn.addEventListener('click', () => {
            const element = document.querySelector("#birthday-modal-overlay .modal-content");
            const actions = element.querySelector('.modal-actions');
            generateImage(element, actions, 'elenco-compleanni');
        });
        birthdayModalOverlay.addEventListener('click', (e) => {
             if (e.target === birthdayModalOverlay) closeModal(birthdayModalOverlay);
        });

        // Listeners per modal percorso parentela
        pathModalCloseBtn.addEventListener('click', () => closeModal(pathModalOverlay));
        pathShareBtn.addEventListener('click', () => {
            const element = document.querySelector("#path-modal-overlay .modal-content");
            const actions = element.querySelector('.modal-actions');
            const fileName = `percorso-parentela-${selectedPeople[0].replace(/ /g, '_')}-e-${selectedPeople[1].replace(/ /g, '_')}`;
            generateImage(element, actions, fileName);
        });
        pathModalOverlay.addEventListener('click', (e) => {
             if (e.target === pathModalOverlay) closeModal(pathModalOverlay);
        });
        
        // Listener per albero genealogico
        treeViewBtn.addEventListener('click', drawHorizontalTree); 
        treeModalCloseBtn.addEventListener('click', () => closeModal(treeModalOverlay));
        treeModalOverlay.addEventListener('click', (e) => {
             if (e.target === treeModalOverlay) closeModal(treeModalOverlay);
        });


        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!infoModalOverlay.classList.contains('hidden')) closeModal(infoModalOverlay);
                if (!birthdayModalOverlay.classList.contains('hidden')) closeModal(birthdayModalOverlay);
                if (!pathModalOverlay.classList.contains('hidden')) closeModal(pathModalOverlay);
                if (!treeModalOverlay.classList.contains('hidden')) closeModal(treeModalOverlay);
            }
        });
        
        installPromptClose.addEventListener('click', () => {
            installPrompt.classList.add('hidden');
            localStorage.setItem('installPromptDismissed', 'true');
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderPeople();
            showInstallPrompt();

            const sw = './sw.js';
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(sw).then(() => console.log('ServiceWorker registrato')).catch(err => console.error('Registrazione ServiceWorker fallita:', err));
            }
        });
    </script>
</body>
</html>