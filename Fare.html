<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Elenchi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="color-scheme" content="light only">
  
  <link rel="icon" href="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Fare.png?v=1.0" type="image/png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Fare.png?v=1.0">
  
  <meta property="og:title" content="Elenchi: La Tua App Sincronizzata">
  <meta property="og:description" content="Gestisci i tuoi elenchi e appunti in modo semplice, intuitivo e sincronizzato su tutti i tuoi dispositivi.">
  <meta property="og:image" content="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Fare.png?v=1.0">
  <meta property="og:url" content="https://sebastiano-mazzarisi.github.io/Test/Fare.html">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Elenchi: La Tua App Sincronizzata">
  <meta name="twitter:description" content="Gestisci i tuoi elenchi e appunti in modo semplice, intuitivo e sincronizzato su tutti i tuoi dispositivi.">
  <meta name="twitter:image" content="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Fare.png?v=1.0">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>

  <style>
    :root {
      --bg: #f5f7fa;
      --fg: #2c3e50;
      --accent: #3498db;
      --accent-dark: #2980b9;
      --card-bg: #ffffff;
      --border: #e0e6ed;
      --shadow: 0 6px 16px rgba(0,0,0,0.08);
      --border-radius-card: 12px;
      --border-radius-element: 8px;
      --touch-target: 44px;
      --light-blue-border: #aed6f1; /* Un blu molto chiaro per i bordi */
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-size: 20px;
      background-color: var(--bg);
      color: var(--fg);
      padding: 1.5rem;
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      overflow-x: hidden; /* Evita scroll orizzontale */
      overscroll-behavior: none;
      color-scheme: light; /* NUOVO: Forza il tema del browser su light */
    }

    #loading-indicator {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 1000;
        font-size: 1.2rem;
    }

    .container {
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      font-size: 2.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    /* Stile per le immagini nelle intestazioni */
    h1 img, h2 img {
        vertical-align: middle;
        height: 1.2em; /* Regola l'altezza dell'icona rispetto al testo */
        width: auto;
        margin-right: 0.2em;
    }
    
    #current-list-title {
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center; /* Ripristina la centratura */
        gap: 0.5rem;
        cursor: pointer;
        color: var(--accent);
        font-size: 2.5rem;
        margin-bottom: 1rem;
        font-weight: 700;
        letter-spacing: -0.03em;
    }

    #pdf-export-logo, #pdf-export-all-logo {
        cursor: pointer;
    }

    #current-list-title img {
        display: inline-block; /* Rende l'immagine visibile qui */
    }

    #home-icon {
        cursor: pointer;
        font-size: 1.2em;
        margin-left: 0.1em;
        color: var(--accent-dark);
        transition: color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    #home-icon:hover {
        color: var(--accent);
    }
    
    .toggle-reorder-btn {
        cursor: pointer;
        font-size: 1.2rem;
        color: var(--accent-dark);
        margin-left: 0.5rem; /* Aggiunge spazio a sinistra */
    }

    #refresh-button {
        cursor: pointer;
        font-size: 0.8em;
        margin-left: 0.75rem;
        transition: transform 0.5s ease;
        display: inline-block;
    }
    #refresh-button:hover {
        transform: rotate(360deg);
    }


    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.online {
      background-color: #28a745;
      box-shadow: 0 0 6px rgba(40, 167, 69, 0.5);
    }

    .status-dot.offline {
      background-color: #dc3545;
      box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
    }

    .section {
      width: 100%;
      margin-bottom: 1rem;
    }

    .card {
      background: #e6f3ff; /* Azzurro pastello */
      border: 1px solid var(--light-blue-border); /* Bordo blu sulla card */
      border-radius: var(--border-radius-card);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 0;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card-bg);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius-element);
      margin-bottom: 1rem;
      font-size: 0.9rem;
      border: 1px solid var(--border);
    }

    .status-online {
      color: #28a745;
    }

    .status-offline {
      color: #dc3545;
    }

    input[type="text"], textarea {
      font-size: 20px;
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.3s, box-shadow 0.3s;
      touch-action: manipulation;
      border-radius: var(--border-radius-element);
      border: 1px solid var(--border);
    }

    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      background: white;
      color: var(--fg);
    }

    button {
      font-family: 'Inter', sans-serif;
      font-size: 20px; /* Previene zoom su iOS */
      border-radius: var(--border-radius-element);
      background: var(--accent);
      border: none;
      color: white;
      padding: 0.75rem 1.2rem;
      cursor: pointer;
      font-weight: 600;
      margin-right: 0.5rem;
      transition: all 0.3s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-height: var(--touch-target);
      touch-action: manipulation;
      user-select: none;
    }

    button:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    button:last-child {
      margin-right: 0;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }

    .list-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      background: white;
      border: 1px solid var(--light-blue-border); /* Bordo blu sui list-item */
      border-radius: var(--border-radius-element);
      margin-bottom: 0.3rem;
      transition: all 0.3s;
      min-height: var(--touch-target);
    }

    .list-item.syncing {
      border-left: 4px solid #ffc107;
    }

    .list-item.error {
      border-left: 4px solid #dc3545;
    }
    
    .list-item input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 20px; /* Previene zoom su iOS */
      padding: 0.2rem 0.5rem;
      margin: 0;
      width: auto;
      cursor: text;
    }

    .list-item input:focus {
      background: #f8f9fa;
      border: 1px solid var(--accent);
      border-radius: 4px;
    }

    .list-item .action-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      margin: 0 2px;
      font-size: 0.8rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      min-width: var(--touch-target);
      min-height: var(--touch-target);
      touch-action: none;
      user-select: none;
    }
    
    .list-item .move-btn {
        border: 2px solid #bdc3c7;
        color: #bdc3c7;
    }
    
    /* Le frecce degli elementi sono nascoste di default */
    #list-names .move-btn,
    #item-list .move-btn {
        display: none;
    }

    /* Mostra le frecce solo quando la modalit√† riordina √® attiva */
    .reorder-mode #item-list .move-btn {
        display: flex;
    }
    
    .reorder-lists-mode #list-names .move-btn {
        display: flex;
    }

    .list-item .move-btn:hover {
        background: #bdc3c7;
        color: white;
    }
    
    .list-item .select-btn {
      border: 2px solid #28a745;
      color: #28a745;
    }

    .list-item .select-btn:hover {
      background: #28a745;
      color: white;
      transform: scale(1.05);
    }

    .list-item .delete-btn {
      border: 2px solid #dc3545;
      color: #dc3545;
    }

    .list-item .delete-btn:hover {
      background: #dc3545;
      color: white;
      transform: scale(1.05);
    }

    .form-row {
      display: flex;
      gap: 0.7rem;
      align-items: center;
      margin-top: 1rem;
    }

    .form-row input[type="text"] {
      flex-grow: 1;
      margin: 0;
     font-size: 20px;}

    .form-row button {
      margin-right: 0;
      padding: 0.75rem 1rem;
      font-size: 1.2rem;
    }

    .note-section {
        margin-top: 1.5rem;
        width: 100%;
    }
    .note-section textarea {
        min-height: 120px;
        resize: vertical;
        padding: 1rem;
        font-size: 1rem;
        line-height: 1.5;
        border: 1px solid var(--light-blue-border);
        border-radius: var(--border-radius-element);
    }
    .note-section textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .status-bar, .firebase-config {
      display: none;
    }

    @media (max-width: 768px) {
      body { padding: 0.75rem; }
      h1, #current-list-title { font-size: 2rem; margin-bottom: 0.75rem; }
      .card { padding: 1rem; }
      .list-item { padding: 0.3rem 0.6rem; margin-bottom: 0.2rem; }
      .list-item .action-btn { width: 36px; height: 36px; font-size: 1rem; }
      .note-section textarea { padding: 0.75rem; font-size: 0.95rem; }
      h1 img, h2 img { height: 1em; margin-right: 0.15em; }
      #home-icon { font-size: 1em; margin-left: 0.2em; }
    }

    @media (max-width: 480px) {
      body { padding: 0.5rem; }
      h1, #current-list-title { font-size: 1.75rem; margin-bottom: 0.5rem; gap: 0.25rem; }
      .card { padding: 0.75rem; }
      .list-item { gap: 0.25rem; padding: 0.25rem 0.5rem; margin-bottom: 0.15rem; }
      .list-item input { font-size: 18px; padding: 0.2rem 0.4rem; }
      .list-item .action-btn { width: 32px; height: 32px; margin: 0 1px; font-size: 0.9rem; }
      .form-row { gap: 0.5rem; margin-top: 0.75rem; }
      .form-row button { padding: 0.6rem 0.8rem; font-size: 1.1rem; }
      .note-section textarea { padding: 0.6rem; font-size: 0.9rem; min-height: 100px; }
      #home-icon { font-size: 0.9em; margin-left: 0.15em; }
    }

    @media (max-width: 360px) {
      body { padding: 0.4rem; }
      h1, #current-list-title { font-size: 1.5rem; }
      .card { padding: 0.6rem; }
      .list-item input { font-size: 17px; padding: 0.15rem 0.3rem; }
      .note-section textarea { padding: 0.5rem; min-height: 80px; }
      #home-icon { font-size: 0.85em; margin-left: 0.1em; }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      body { padding: 0.4rem; }
      h1, #current-list-title { font-size: 1.4rem; margin-bottom: 0.2rem; }
      .card { padding: 0.6rem; }
      .list-item { margin-bottom: 0.15rem; }
      .note-section textarea { min-height: 60px; }
    }

    .card { background: var(--card-bg); }
    .list-item { background: var(--card-bg); }
    .list-item input { background: var(--card-bg); color: var(--fg); }
    .note-section textarea { background: var(--card-bg); color: var(--fg); }
    .list-item input:focus { background: #555555; }
    .list-item input[style*="text-decoration: line-through"] { color: #cccccc !important; }
    
    #status-dot-single-list { display: inline-block !important; margin-left: 0.5rem; vertical-align: middle; }
    
    input[type="text"], textarea { background-color: #ffffff !important; color: #2c3e50 !important; font-size: 20px !important; -webkit-text-fill-color: #2c3e50 !important; caret-color: #2c3e50; }
    input[type="text"]:focus, textarea:focus { background-color: #ffffff !important; color: #2c3e50 !important; -webkit-text-fill-color: #2c3e50 !important; }

    /* ================================================= */
    /* MODIFICHE FINALI INTEGRATE                        */
    /* ================================================= */
    #new-list-name::placeholder,
    #item-input::placeholder,
    #note-input::placeholder {
        color: #CCCCCC !important;
        -webkit-text-fill-color: #CCCCCC !important;
        font-size: 18px !important;
        font-style: italic !important;
        opacity: 1;
    }
    #new-list-name { border: 2px solid #cccccc !important; }
    .form-row > button { background-color: white !important; color: var(--accent) !important; border: 2px solid var(--accent) !important; }
    .form-row > button:hover { background-color: #f0f8ff !important; color: var(--accent-dark) !important; border-color: var(--accent-dark) !important; }
    
    .note-section .card {
        background-color: #FFFACD !important;
    }
  </style>
</head>
<body>
  <div id="loading-indicator">Elaborazione in corso...</div>

  <div class="container">
    <div id="lists-view">
      <h1>
          <img id="pdf-export-all-logo" src="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Fare.png" alt="Icona Elenchi" title="Esporta tutti gli elenchi in PDF">
          Elenchi <span id="status-dot" class="status-dot offline"></span>
          <span id="refresh-button" title="Ricarica la pagina">üîÑ</span>
          <span id="toggle-reorder-lists-btn" class="toggle-reorder-btn" title="Attiva/Disattiva riordinamento">‚ÜïÔ∏è</span>
      </h1>
      <div class="section">
        <div class="card">
          <ul id="list-names"></ul>
          <div class="form-row">
            <input type="text" id="new-list-name" placeholder="Nome nuovo elenco" maxlength="50">
            <button onclick="addList()">‚ûï</button>
          </div>
        </div>
      </div>
    </div>

    <div id="single-list-view" style="display: none;">
      <h1 id="current-list-title">
          <img id="pdf-export-logo" src="https://raw.githubusercontent.com/Sebastiano-Mazzarisi/Test/main/Fare.png" alt="Icona Elenco" style="cursor: pointer;" title="Esporta in PDF">
          <span id="list-name-display"></span>
          <span id="status-dot-single-list" class="status-dot offline"></span>
          <span id="home-icon">üè†</span>
          <span id="toggle-reorder-btn" class="toggle-reorder-btn" title="Attiva/Disattiva riordinamento">‚ÜïÔ∏è</span>
      </h1>
      <div class="section">
        <div class="card">
          <ul id="item-list"></ul>
          <div class="form-row">
            <input type="text" id="item-input" placeholder="Aggiungi una cosa da fare" maxlength="200">
            <button onclick="addItem()" id="add-item-btn">‚ûï</button>
          </div>
        </div>
      </div>
      <div class="section note-section">
          <div class="card">
              <textarea id="note-input" placeholder="Scrivi qui i tuoi appunti per questo elenco..." rows="5" maxlength="1000"></textarea>
          </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  
  <script>
    // ‚úÖ CONFIGURAZIONE FIREBASE - QUELLA REALE
    const firebaseConfig = {
      apiKey: "AIzaSyChsZzf69k_JTY0EwbrXyWMhh8uVl9pnbA",
      authDomain: "elenchicondivisi.firebaseapp.com",
      projectId: "elenchicondivisi",
      storageBucket: "elenchicondivisi.appspot.com",
      messagingSenderId: "615174125565",
      appId: "1:615174125565:web:7a2b4b0bd6af9cbd6f4b94"
    };

    // Variabili globali
    let db = null;
    let isOnline = false;
    let unsubscribeList = null;
    let unsubscribeItems = null;
    let currentList = null;

    // Fallback locale se Firebase non funziona
    let localDatabase = {
      lists: JSON.parse(localStorage.getItem('elenchiFare') || '{}')
    };
    let listOrder = JSON.parse(localStorage.getItem('elenchiOrder') || '[]');

    // Riferimenti DOM
    const listNames = document.getElementById("list-names");
    const itemList = document.getElementById("item-list");
    const currentListTitle = document.getElementById("current-list-title");
    const listNameDisplay = document.getElementById("list-name-display");
    const newItemInput = document.getElementById("item-input");
    const newListInput = document.getElementById("new-list-name");
    const listsView = document.getElementById("lists-view");
    const singleListView = document.getElementById("single-list-view");
    const statusDot = document.getElementById("status-dot");
    const statusDotSingleList = document.getElementById("status-dot-single-list");
    const noteInput = document.getElementById("note-input");
    const homeIcon = document.getElementById("home-icon");

    // FUNZIONE PDF PER SINGOLO ELENCO
    async function exportListToPDF(event) {
        event.stopPropagation(); 

        if (!currentList) {
            alert("Nessun elenco selezionato per l'esportazione.");
            return;
        }

        const items = localDatabase.lists[currentList]?.items || [];
        const note = localDatabase.lists[currentList]?.note || '';

        if (items.length === 0 && !note.trim()) {
            alert("Questo elenco √® vuoto, non c'√® nulla da esportare.");
            return;
        }
        
        const pdfWindow = window.open('', '_blank');
        pdfWindow.document.write('<h1>Preparazione del PDF in corso...</h1>');

        try {
            const formattedDate = new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
            const content = [{ text: `${currentList} - ${formattedDate}`, style: 'header' }];

            if (items.length > 0) {
                const midpoint = Math.ceil(items.length / 2);
                const firstHalf = items.slice(0, midpoint);
                const secondHalf = items.slice(midpoint);
                
                const tableBodyFirst = firstHalf.map((item, index) => [
                    (index + 1).toString(),
                    item.done ? { text: item.text, decoration: 'lineThrough', color: '#7f8c8d' } : item.text
                ]);
                const tableBodySecond = secondHalf.map((item, index) => [
                    (midpoint + index + 1).toString(),
                    item.done ? { text: item.text, decoration: 'lineThrough', color: '#7f8c8d' } : item.text
                ]);
                
                if (items.length % 2 !== 0) {
                    tableBodySecond.push([' ', ' ']);
                }
                
                const tableLayout = {
                    hLineColor: (i, node) => '#cccccc',
                    vLineColor: (i, node) => '#cccccc'
                };

                content.push({
                    columnGap: 10,
                    columns: [
                        { table: { widths: ['auto', '*'], body: tableBodyFirst }, layout: tableLayout },
                        secondHalf.length > 0 ? { table: { widths: ['auto', '*'], body: tableBodySecond }, layout: tableLayout } : { text: '' }
                    ]
                });
            }
            
            if (note.trim()) {
                content.push({ text: `Nota: ${note}`, style: 'noteStyle' });
            }

            const docDefinition = {
                content: content,
                styles: {
                    header: { fontSize: 22, bold: true, margin: [0, 0, 0, 10], alignment: 'center' },
                    noteStyle: { italics: true, color: '#333333', margin: [0, 10, 0, 0] }
                }
            };
            
            const pdfDoc = pdfMake.createPdf(docDefinition);
            const blob = await new Promise(resolve => pdfDoc.getBlob(resolve));
            const blobUrl = URL.createObjectURL(blob);
            pdfWindow.location.href = blobUrl;

        } catch (error) {
            console.error("Errore creazione PDF singolo:", error);
            if(pdfWindow && !pdfWindow.closed) {
                pdfWindow.document.body.innerHTML = `<div style="font-family: sans-serif; padding: 20px;"><h1>Si √® verificato un errore</h1><pre style="background-color: #f0f0f0; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap;">${error.stack || error}</pre></div>`;
            }
        }
    }

    // FUNZIONE PDF PER TUTTI GLI ELENCHI
    async function exportAllListsToPDF() {
        if (listOrder.length === 0) {
            alert("Nessun elenco da esportare.");
            return;
        }
        
        const pdfWindow = window.open('', '_blank');
        pdfWindow.document.write('<h1>Preparazione del riepilogo PDF in corso...</h1>');
        
        try {
            const formattedDate = new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
            const content = [];

            content.push({ text: 'Riepilogo di Tutti gli Elenchi', style: 'docHeader' });
            content.push({ text: formattedDate, style: 'docSubHeader' });

            for (const listName of listOrder) {
                const listData = localDatabase.lists[listName];
                const note = listData?.note || '';
                const itemsSnapshot = await db.collection("lists").doc(listName).collection("items").orderBy("order", "asc").get();
                
                if (!itemsSnapshot.empty || note.trim()) {
                    content.push({ text: listName, style: 'listHeader' });

                    if (!itemsSnapshot.empty) {
                        const items = [];
                        itemsSnapshot.forEach(doc => items.push(doc.data()));

                        const midpoint = Math.ceil(items.length / 2);
                        const firstHalf = items.slice(0, midpoint);
                        const secondHalf = items.slice(midpoint);

                        const tableBodyFirst = firstHalf.map((item, index) => [
                            (index + 1).toString(),
                            item.done ? { text: item.text, decoration: 'lineThrough', color: '#7f8c8d' } : item.text
                        ]);
                        const tableBodySecond = secondHalf.map((item, index) => [
                            (midpoint + index + 1).toString(),
                            item.done ? { text: item.text, decoration: 'lineThrough', color: '#7f8c8d' } : item.text
                        ]);

                        if (items.length % 2 !== 0) {
                            tableBodySecond.push([' ', ' ']);
                        }

                        const tableLayout = {
                            hLineColor: (i, node) => '#cccccc',
                            vLineColor: (i, node) => '#cccccc'
                        };

                        content.push({
                            columnGap: 10,
                            columns: [
                                { table: { widths: ['auto', '*'], body: tableBodyFirst }, layout: tableLayout },
                                secondHalf.length > 0 ? { table: { widths: ['auto', '*'], body: tableBodySecond }, layout: tableLayout } : { text: '' }
                            ]
                        });
                    }
                    
                    if (note.trim()) {
                        content.push({ text: `Nota: ${note}`, style: 'noteStyle' });
                    }
                }
            }

            const docDefinition = {
                content: content,
                styles: {
                    docHeader: { fontSize: 24, bold: true, alignment: 'center', margin: [0, 0, 0, 5] },
                    docSubHeader: { fontSize: 12, alignment: 'center', margin: [0, 0, 0, 10] },
                    listHeader: { fontSize: 18, bold: true, margin: [0, 15, 0, 5] },
                    noteStyle: { italics: true, color: '#333333', margin: [0, 5, 0, 10] }
                }
            };
            
            const pdfDoc = pdfMake.createPdf(docDefinition);
            const blob = await new Promise(resolve => pdfDoc.getBlob(resolve));
            const blobUrl = URL.createObjectURL(blob);
            pdfWindow.location.href = blobUrl;

        } catch (error) {
            console.error("Errore creazione PDF riepilogo:", error);
            if(pdfWindow && !pdfWindow.closed) {
                pdfWindow.document.body.innerHTML = `<div style="font-family: sans-serif; padding: 20px;"><h1>Si √® verificato un errore</h1><pre style="background-color: #f0f0f0; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap;">${error.stack || error}</pre></div>`;
            }
        }
    }


    // Test di connettivit√† pi√π robusto
    function initFirebase() {
      try {
        console.log("üî• Inizializzazione Firebase...");
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        
        console.log("üì° Test scrittura Firebase...");
        
        const testDoc = {
          test: true,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection("_test").doc("connectivity").set(testDoc).then(() => {
          console.log("‚úÖ Test scrittura riuscito! Firebase completamente funzionante.");
          
          db.collection("_test").doc("connectivity").delete();
          
          isOnline = true;
          updateConnectionStatus();
          loadLists();
          
        }).catch((error) => {
          console.log("‚ùå Test scrittura fallito:", error.code, error.message);
          
          if (error.code === 'permission-denied') {
            alert("‚ö†Ô∏è FIREBASE: Permessi insufficienti.\n\nVai su console.firebase.google.com\n‚Üí Firestore Database ‚Üí Regole\n‚Üí Cambia in: allow read, write: if true;");
          }
          
          console.log("üîÑ Provo modalit√† solo lettura...");
          db.collection("lists").limit(1).get().then(() => {
            console.log("üìñ Lettura funziona, ma scrittura bloccata");
            alert("Firebase in modalit√† solo lettura. Uso modalit√† locale per salvare.");
            fallbackToLocal();
          }).catch(() => {
            console.log("‚ùå Anche lettura fallita");
            fallbackToLocal();
          });
        });
        
      } catch (error) {
        console.error("‚ùå Errore inizializzazione:", error);
        fallbackToLocal();
      }
    }

    // Fallback alla modalit√† locale
    function fallbackToLocal() {
      console.log("üîÑ Modalit√† locale attivata");
      isOnline = false;
      updateConnectionStatus();
      loadListsLocal();
    }

    // Aggiorna status connessione
    function updateConnectionStatus() {
      if (isOnline) {
        statusDot.className = "status-dot online";
        statusDot.title = "üü¢ Connesso - Sincronizzazione attiva";
        if (statusDotSingleList) {
            statusDotSingleList.className = "status-dot online";
            statusDotSingleList.title = "üü¢ Connesso - Sincronizzazione attiva";
        }
      } else {
        statusDot.className = "status-dot offline";
        statusDot.title = "üî¥ Offline - Modalit√† locale";
        if (statusDotSingleList) {
            statusDotSingleList.className = "status-dot offline";
            statusDotSingleList.title = "üî¥ Offline - Modalit√† locale";
        }
      }
    }
    
    // NUOVE FUNZIONI PER SPOSTAMENTO CON FRECCE
    async function moveItem(itemId, direction) {
        if (!currentList) return;
        let items = localDatabase.lists[currentList].items;
        const itemIndex = items.findIndex(i => i.id === itemId);

        if (itemIndex === -1) return;
        if (direction === 'up' && itemIndex === 0) return;
        if (direction === 'down' && itemIndex === items.length - 1) return;

        const targetIndex = direction === 'up' ? itemIndex - 1 : itemIndex + 1;
        [items[itemIndex], items[targetIndex]] = [items[targetIndex], items[itemIndex]];
        updateItemsOrder(items);
        loadItemsLocal();
    }
    
    async function moveList(listName, direction) {
        const listIndex = listOrder.indexOf(listName);
        if (listIndex === -1) return;
        if (direction === 'up' && listIndex === 0) return;
        if (direction === 'down' && listIndex === listOrder.length - 1) return;

        const targetIndex = direction === 'up' ? listIndex - 1 : listIndex + 1;
        [listOrder[listIndex], listOrder[targetIndex]] = [listOrder[targetIndex], listOrder[listIndex]];
        updateListsOrder();
        loadListsLocal();
    }
    
    async function updateItemsOrder(items) {
        items.forEach((item, index) => item.order = index);
        saveToLocalStorage();
        if (isOnline && db) {
            const batch = db.batch();
            const collectionRef = db.collection("lists").doc(currentList).collection("items");
            items.forEach(item => {
                batch.update(collectionRef.doc(item.id), { order: item.order });
            });
            await batch.commit().catch(err => console.error("Errore Sincronizzazione Ordine Elementi:", err));
        }
    }

    async function updateListsOrder() {
        saveToLocalStorage();
        if (isOnline && db) {
            const batch = db.batch();
            listOrder.forEach((listId, index) => {
                const docRef = db.collection("lists").doc(listId);
                batch.update(docRef, { order: index });
            });
            await batch.commit().catch(err => console.error("Errore Sincronizzazione Ordine Liste:", err));
        }
    }
    
    // Salvataggio locale
    function saveToLocalStorage() {
      listOrder.forEach((name, index) => { if(localDatabase.lists[name]) localDatabase.lists[name].order = index; });
      localStorage.setItem('elenchiOrder', JSON.stringify(listOrder));
      localStorage.setItem('elenchiFare', JSON.stringify(localDatabase.lists));
    }

    // Funzione per rinominare un elenco
    async function renameList(oldName, newName) {
      newName = newName.trim();
      if (!validateListName(newName) || newName === oldName) return false;

      if (isOnline && db) {
        try {
          const newDocRef = db.collection("lists").doc(newName);
          if ((await newDocRef.get()).exists) { alert(`L'elenco "${newName}" esiste gi√†.`); return false; }
          const oldListDocRef = db.collection("lists").doc(oldName);
          const oldListData = (await oldListDocRef.get()).data();
          const itemsSnapshot = await oldListDocRef.collection("items").get();
          
          const batch = db.batch();
          batch.set(newDocRef, oldListData);
          itemsSnapshot.forEach(doc => {
            batch.set(newDocRef.collection("items").doc(doc.id), doc.data());
            batch.delete(doc.ref);
          });
          batch.delete(oldListDocRef);
          
          await batch.commit();
          if (currentList === oldName) selectList(newName);
          return true;
        } catch (error) {
          console.error("Errore rinomina Firebase:", error);
          alert(`Errore Firebase: ${error.message}`);
          return false;
        }
      } else {
        if (localDatabase.lists[newName]) { alert(`L'elenco "${newName}" esiste gi√†.`); return false; }
        localDatabase.lists[newName] = localDatabase.lists[oldName];
        delete localDatabase.lists[oldName];
        listOrder = listOrder.map(n => (n === oldName ? newName : n));
        saveToLocalStorage();
        if (currentList === oldName) selectList(newName);
        else loadListsLocal();
        return true;
      }
    }

    // Aggiungi una funzione per aggiornare le note
    async function updateNote(listName, newNote) {
        if (!listName) return;
        newNote = newNote.trim();
        if (isOnline && db) {
            try { await db.collection("lists").doc(listName).update({ note: newNote }); } 
            catch (error) { console.error("Errore aggiornamento nota Firebase:", error); }
        } else {
            if (localDatabase.lists[listName]) {
                localDatabase.lists[listName].note = newNote;
                saveToLocalStorage();
            }
        }
    }

    // Event listeners
    newListInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') addList(); });
    newItemInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') addItem(); });
    noteInput.addEventListener('blur', () => {
        if (currentList) {
            const currentNote = localDatabase.lists[currentList]?.note || "";
            if (noteInput.value.trim() !== (currentNote || "").trim()) {
                 updateNote(currentList, noteInput.value.trim());
            }
        }
    });

    // NAVIGAZIONE
    function selectList(name) {
      currentList = name;
      listNameDisplay.textContent = name;
      listsView.style.display = 'none';
      singleListView.style.display = 'block';
      if (isOnline) loadItemsFirebase(); else loadItemsLocal();
      noteInput.value = localDatabase.lists[currentList]?.note || "";
      updateConnectionStatus();
    }

    function backToLists() {
      currentList = null;
      listsView.style.display = 'block';
      singleListView.style.display = 'none';
      itemList.innerHTML = "";
      noteInput.value = "";
      if (unsubscribeItems) { unsubscribeItems(); unsubscribeItems = null; }
      updateConnectionStatus();
    }

    // GESTIONE LISTE - FIREBASE
    function loadLists() {
      if (!db) return fallbackToLocal();
      
      unsubscribeList = db.collection("lists").orderBy("order", "asc").onSnapshot(snapshot => {
          const newOrderList = [];
          snapshot.forEach(doc => newOrderList.push(doc.id));
          listOrder = newOrderList;

          const newLocalLists = localDatabase.lists;
          snapshot.docChanges().forEach(change => {
            const doc = change.doc;
            if (change.type === "removed") {
                delete newLocalLists[doc.id];
            } else {
                newLocalLists[doc.id] = { ...newLocalLists[doc.id], ...doc.data() };
            }
          });
          localDatabase.lists = newLocalLists;

          loadListsLocal();
          saveToLocalStorage();
        }, error => {
          console.error("Errore listener Firebase:", error);
          fallbackToLocal();
        });
    }

    async function addList() {
      const name = newListInput.value.trim();
      if (!validateListName(name)) return;
      if (isOnline && db) {
        try {
            if ((await db.collection("lists").doc(name).get()).exists) {
                alert(`L'elenco "${name}" esiste gi√†.`); return;
            }
            const newOrder = listOrder.length;
            await db.collection("lists").doc(name).set({
                name: name, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                order: newOrder, note: ""
            });
            newListInput.value = "";
            selectList(name);
        } catch (error) {
            console.error("Errore Firebase:", error);
            saveListLocally(name);
        }
      } else {
        saveListLocally(name);
      }
    }

    function saveListLocally(name) {
      if (localDatabase.lists[name]) { alert(`L'elenco "${name}" esiste gi√†.`); return; }
      const newOrder = listOrder.length;
      localDatabase.lists[name] = { name: name, items: [], createdAt: new Date().toISOString(), order: newOrder, note: "" };
      listOrder.push(name);
      saveToLocalStorage();
      newListInput.value = "";
      loadListsLocal();
      selectList(name);
    }

    function deleteList(listName) {
      if (!confirm(`Eliminare "${listName}"?\nTutti gli elementi saranno cancellati.`)) return;
      if (isOnline && db) {
        db.collection("lists").doc(listName).collection("items").get().then(snapshot => {
          const batch = db.batch();
          snapshot.forEach(doc => batch.delete(doc.ref));
          return batch.commit();
        }).then(() => db.collection("lists").doc(listName).delete())
          .then(() => { if (currentList === listName) backToLists(); })
          .catch(error => alert("Errore: " + error.message));
      } else {
        delete localDatabase.lists[listName];
        listOrder = listOrder.filter(name => name !== listName);
        saveToLocalStorage();
        if (currentList === listName) backToLists();
        loadListsLocal();
      }
    }

    // GESTIONE LISTE - LOCALE
    function loadListsLocal() {
      listNames.innerHTML = "";
      if (listOrder.length === 0) showEmptyLists();
      else listOrder.forEach((listName, index) => { if (localDatabase.lists[listName]) renderListItem(listName, index, listOrder.length); });
    }

    // GESTIONE ELEMENTI - FIREBASE
    function loadItemsFirebase() {
      if (!db || !currentList) return;
      
      unsubscribeItems = db.collection("lists").doc(currentList).collection("items").orderBy("order", "asc").onSnapshot(snapshot => {
          const currentLocalItems = [];
          snapshot.forEach(doc => currentLocalItems.push({ id: doc.id, ...doc.data() }));
          if (localDatabase.lists[currentList]) localDatabase.lists[currentList].items = currentLocalItems;
          loadItemsLocal();
        });
    }

    async function addItem() {
      const text = newItemInput.value.trim();
      if (!validateItemText(text)) return;
      if (currentList) {
          const items = localDatabase.lists[currentList]?.items || [];
          const newOrder = items.length;
          if (isOnline && db) {
            try {
              await db.collection("lists").doc(currentList).collection("items").add({
                  text: text, done: false,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp(), order: newOrder
              });
              newItemInput.value = "";
            } catch (error) { addItemLocally(text, newOrder); }
          } else { addItemLocally(text, newOrder); }
      }
    }

    function addItemLocally(text, order) {
      if (!localDatabase.lists[currentList].items) localDatabase.lists[currentList].items = [];
      localDatabase.lists[currentList].items.push({
          text: text, done: false, timestamp: new Date().toISOString(), order: order, id: Date.now().toString()
      });
      saveToLocalStorage();
      newItemInput.value = "";
      loadItemsLocal();
    }

    function updateItem(itemId, updates) {
      if (isOnline && db && currentList) {
        db.collection("lists").doc(currentList).collection("items").doc(itemId)
          .update(updates).catch(error => alert("Errore: " + error.message));
      } else if (currentList) {
        const item = localDatabase.lists[currentList].items.find(i => i.id === itemId);
        if (item) {
          Object.assign(item, updates);
          saveToLocalStorage();
          loadItemsLocal();
        }
      }
    }

    function deleteItem(itemId) {
      if (isOnline && db && currentList) {
        db.collection("lists").doc(currentList).collection("items").doc(itemId).delete()
          .catch(error => alert("Errore: " + error.message));
      } else {
        localDatabase.lists[currentList].items = localDatabase.lists[currentList].items.filter(i => i.id !== itemId);
        saveToLocalStorage();
        loadItemsLocal();
      }
    }

    // GESTIONE ELEMENTI - LOCALE
    function loadItemsLocal() {
      itemList.innerHTML = "";
      const items = localDatabase.lists[currentList]?.items || [];
      if (items.length === 0) showEmptyItems();
      else items.forEach((item, index) => renderItem(item, item.id, index, items.length));
    }

    // RENDERING
    function renderListItem(name, index, total) {
      const li = document.createElement("li");
      li.className = "list-item";
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = name;
      nameInput.onblur = async () => {
          const newName = nameInput.value.trim();
          if (newName !== name && newName) {
            if (!(await renameList(name, newName))) nameInput.value = name;
          } else { nameInput.value = name; }
      };
      nameInput.onkeypress = (e) => { if (e.key === 'Enter') nameInput.blur(); };
      const moveUpBtn = document.createElement("button");
      moveUpBtn.textContent = "‚¨ÜÔ∏è";
      moveUpBtn.className = "action-btn move-btn";
      moveUpBtn.onclick = () => moveList(name, 'up');
      if (index === 0) moveUpBtn.style.visibility = 'hidden';
      const moveDownBtn = document.createElement("button");
      moveDownBtn.textContent = "‚¨áÔ∏è";
      moveDownBtn.className = "action-btn move-btn";
      moveDownBtn.onclick = () => moveList(name, 'down');
      if (index === total - 1) moveDownBtn.style.visibility = 'hidden';
      const selectBtn = document.createElement("button");
      selectBtn.textContent = "üìã";
      selectBtn.className = "action-btn select-btn";
      selectBtn.onclick = () => selectList(name);
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "üóëÔ∏è";
      deleteBtn.className = "action-btn delete-btn";
      deleteBtn.onclick = () => deleteList(name);
      li.append(moveUpBtn, moveDownBtn, nameInput, selectBtn, deleteBtn);
      listNames.appendChild(li);
    }

    function renderItem(item, itemId, index, total) {
      const li = document.createElement("li");
      li.className = "list-item";
      li.dataset.itemId = itemId;
      const moveUpBtn = document.createElement("button");
      moveUpBtn.textContent = "‚¨ÜÔ∏è";
      moveUpBtn.className = "action-btn move-btn";
      moveUpBtn.onclick = () => moveItem(itemId, 'up');
      if (index === 0) moveUpBtn.style.visibility = 'hidden';
      const moveDownBtn = document.createElement("button");
      moveDownBtn.textContent = "‚¨áÔ∏è";
      moveDownBtn.className = "action-btn move-btn";
      moveDownBtn.onclick = () => moveItem(itemId, 'down');
      if (index === total - 1) moveDownBtn.style.visibility = 'hidden';
      const textInput = document.createElement("input");
      textInput.type = "text";
      textInput.value = item.text;
      textInput.onblur = () => updateItem(itemId, { text: textInput.value });
      textInput.onkeypress = (e) => { if (e.key === 'Enter') textInput.blur(); };
      if (item.done) { textInput.style.textDecoration = "line-through"; textInput.style.color = "#7f8c8d"; }
      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = item.done ? "‚úÖ" : "‚≠ï";
      toggleBtn.className = "action-btn select-btn";
      toggleBtn.onclick = () => updateItem(itemId, { done: !item.done });
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "üóëÔ∏è";
      deleteBtn.className = "action-btn delete-btn";
      deleteBtn.onclick = () => deleteItem(itemId);
      li.append(moveUpBtn, moveDownBtn, textInput, toggleBtn, deleteBtn);
      itemList.appendChild(li);
    }

    // UTILITY
    function validateListName(name) { if (!name) { alert("Il nome dell'elenco non pu√≤ essere vuoto."); return false; } if (name.length > 50) { alert("Il nome √® troppo lungo (max 50 caratteri)."); return false; } return true; }
    function validateItemText(text) { if (!text) { alert("Il testo non pu√≤ essere vuoto."); return false; } if (text.length > 200) { alert("Il testo √® troppo lungo (max 200 caratteri)."); return false; } return true; }
    function showEmptyLists() { listNames.innerHTML = "<li style='text-align: center; font-style: italic; color: #7f8c8d; border: none; background: transparent;'>Nessun elenco creato</li>"; }
    function showEmptyItems() { itemList.innerHTML = "<li style='text-align: center; font-style: italic; color: #7f8c8d; border: none; background: transparent;'>Nessuna cosa da fare</li>"; }

    // INIZIALIZZAZIONE
    window.addEventListener('load', () => {
      initFirebase();
      homeIcon.onclick = backToLists;
      document.getElementById('pdf-export-logo').addEventListener('click', exportListToPDF);
      document.getElementById('pdf-export-all-logo').addEventListener('click', exportAllListsToPDF);
      document.getElementById('refresh-button').addEventListener('click', function() { location.reload(true); });
      document.getElementById('toggle-reorder-btn').addEventListener('click', (event) => {
        event.stopPropagation();
        singleListView.classList.toggle('reorder-mode');
      });
      document.getElementById('toggle-reorder-lists-btn').addEventListener('click', (event) => {
        event.stopPropagation();
        listsView.classList.toggle('reorder-lists-mode');
      });
    });

    // Cleanup
    window.addEventListener('beforeunload', () => { if (unsubscribeList) unsubscribeList(); if (unsubscribeItems) unsubscribeItems(); });

    // Prevenzione zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) { const now = (new Date()).getTime(); if (now - lastTouchEnd <= 300) { event.preventDefault(); } lastTouchEnd = now; }, false);

    // Focus management
    document.addEventListener('focusin', function(e) { if (e.target.matches('input[type="text"]')) { setTimeout(() => { e.target.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300); } });
  </script>
</body>
</html>